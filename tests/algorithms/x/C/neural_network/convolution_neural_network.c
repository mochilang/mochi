// Generated by Mochi 0.10.32 on 2025-08-26 08:36 +0700
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <malloc.h>
#include <math.h>

size_t convolve_len;
size_t *convolve_lens;
size_t average_pool_len;
size_t *average_pool_lens;
size_t flatten_len;
size_t vec_mul_mat_len;
size_t matT_vec_mul_len;
size_t vec_add_len;
size_t vec_sub_len;
size_t vec_mul_len;
size_t vec_map_sig_len;
size_t forward_len;

size_t append_len;
static char* str_list_double(const double *arr, size_t len) {
    size_t cap = len * 32 + 2;
    char *buf = malloc(cap);
    size_t pos = 0;
    buf[pos++] = '[';
    for (size_t i = 0; i < len; i++) {
        char tmp[64];
        snprintf(tmp, sizeof(tmp), "%g", arr[i]);
        size_t n = strlen(tmp);
        if (pos + n + 2 >= cap) { cap = cap * 2 + n + 2; buf = realloc(buf, cap); }
        memcpy(buf + pos, tmp, n);
        pos += n;
        if (i + 1 < len) buf[pos++] = ' ';
    }
    buf[pos++] = ']';
    buf[pos] = 0;
    return buf;
}

static double* list_append_double(double *arr, size_t *len, double val) {
    arr = realloc(arr, (*len + 1) * sizeof(double));
    arr[*len] = val;
    (*len)++;
    return arr;
}

static long long** list_append_intptr(long long **arr, size_t *len, long long *val) {
    arr = realloc(arr, (*len + 1) * sizeof(long long*));
    arr[*len] = val;
    (*len)++;
    return arr;
}

static long long*** list_append_intptrptr(long long ***arr, size_t *len, long long **val) {
    arr = realloc(arr, (*len + 1) * sizeof(long long**));
    arr[*len] = val;
    (*len)++;
    return arr;
}

static double** list_append_doubleptr(double **arr, size_t *len, double *val) {
    arr = realloc(arr, (*len + 1) * sizeof(double*));
    arr[*len] = val;
    (*len)++;
    return arr;
}

static size_t* list_append_szt(size_t *arr, size_t *len, size_t val) {
    arr = realloc(arr, (*len + 1) * sizeof(size_t));
    arr[*len] = val;
    (*len)++;
    return arr;
}

static size_t** list_append_szptr(size_t **arr, size_t *len, size_t *val) {
    arr = realloc(arr, (*len + 1) * sizeof(size_t*));
    arr[*len] = val;
    (*len)++;
    return arr;
}

#include <time.h>
static int seeded_now = 0;
static long long now_seed = 0;
static long long _now(void) {
    if (!seeded_now) {
        const char *s = getenv("MOCHI_NOW_SEED");
        if (s && *s) {
            now_seed = atoll(s);
            seeded_now = 1;
        }
    }
    if (seeded_now) {
        now_seed = (now_seed * 1664525 + 1013904223) % 2147483647;
        return now_seed;
    }
    struct timespec ts;
    clock_gettime(CLOCK_REALTIME, &ts);
    return (long long)(ts.tv_sec * 1000000000LL + ts.tv_nsec);
}

static long long _mem(void) {
    long long size = 0, rss = 0;
    FILE *f = fopen("/proc/self/statm", "r");
    if (f) {
        if (fscanf(f, "%lld %lld", &size, &rss) != 2) rss = 0;
        fclose(f);
    }
    return rss * (long long)sysconf(_SC_PAGESIZE);
}

static void panic(const char *msg) {
    fputs(msg, stderr);
    fputc('\n', stderr);
    exit(1);
}

typedef struct CNN CNN;
typedef struct TrainSample TrainSample;

struct CNN {
    double ***conv_kernels;
    size_t conv_kernels_len;
    size_t *conv_kernels_lens;
    size_t conv_kernels_lens_len;
    size_t **conv_kernels_lens_lens;
    size_t conv_kernels_lens_lens_len;
    double *conv_bias;
    size_t conv_bias_len;
    long long conv_step;
    long long pool_size;
    double **w_hidden;
    size_t w_hidden_len;
    size_t *w_hidden_lens;
    size_t w_hidden_lens_len;
    double **w_out;
    size_t w_out_len;
    size_t *w_out_lens;
    size_t w_out_lens_len;
    double *b_hidden;
    size_t b_hidden_len;
    double *b_out;
    size_t b_out_len;
    double rate_weight;
    double rate_bias;
};

struct TrainSample {
    double **image;
    size_t image_len;
    size_t *image_lens;
    size_t image_lens_len;
    double *target;
    size_t target_len;
};

static double*** list_append_doubleptrptr(double* **arr, size_t *len, double* *val) {
    arr = realloc(arr, (*len + 1) * sizeof(double**));
    arr[*len] = val;
    (*len)++;
    return arr;
}

long long seed = 1LL;

double user_random();
double sigmoid(double x);
double to_float(long long x);
double user_exp(double x);
double * * convolve(double * * data, size_t data_len, size_t* data_lens, size_t data_lens_len, double * * kernel, size_t kernel_len, size_t* kernel_lens, size_t kernel_lens_len, long long step, double bias);
double * * average_pool(double * * map, size_t map_len, size_t* map_lens, size_t map_lens_len, long long size);
double * flatten(double * * * maps, size_t maps_len, size_t* maps_lens, size_t maps_lens_len, size_t** maps_lens_lens, size_t maps_lens_lens_len);
double * vec_mul_mat(double * v, size_t v_len, double * * m, size_t m_len, size_t* m_lens, size_t m_lens_len);
double * matT_vec_mul(double * * m, size_t m_len, size_t* m_lens, size_t m_lens_len, double * v, size_t v_len);
double * vec_add(double * a, size_t a_len, double * b, size_t b_len);
double * vec_sub(double * a, size_t a_len, double * b, size_t b_len);
double * vec_mul(double * a, size_t a_len, double * b, size_t b_len);
double * vec_map_sig(double * v, size_t v_len);
CNN new_cnn();
double * forward(CNN cnn, double * * data, size_t data_len, size_t* data_lens, size_t data_lens_len);
CNN train(CNN cnn, TrainSample * samples, size_t samples_len, long long epochs);
const char* user_main();
int main(void);

double user_random() {
    seed = ((seed * 13LL) + 7LL) % 100LL;
    return (double)(seed) / 100.0;
}

double sigmoid(double x) {
    return 1.0 / (1.0 + exp(-(x)));
}

double to_float(long long x) {
    return x * 1.0;
}

double user_exp(double x) {
    double term = 1.0;
    double sum = 1.0;
    long long n = 1LL;
    while (n < 20LL) {
        term = (term * x) / to_float(n);
        sum = sum + term;
        n = n + 1LL;
    }
    return sum;
}

double * * convolve(double * * data, size_t data_len, size_t* data_lens, size_t data_lens_len, double * * kernel, size_t kernel_len, size_t* kernel_lens, size_t kernel_lens_len, long long step, double bias) {
    long long size_data = data_len;
    long long size_kernel = kernel_len;
    double **out = NULL;
    size_t out_len = 0;
    size_t *out_lens = NULL;
    size_t out_lens_len = 0;
    long long i = 0LL;
    while (i <= (size_data - size_kernel)) {
        double *row = NULL;
        size_t row_len = 0;
        long long j = 0LL;
        while (j <= (size_data - size_kernel)) {
            double sum = 0.0;
            long long a = 0LL;
            while (a < size_kernel) {
                long long b = 0LL;
                while (b < size_kernel) {
                    sum = sum + (data[(int)({long long _mochi_idx = i + a; _mochi_idx < 0 ? data_len + _mochi_idx : _mochi_idx;})][(int)({long long _mochi_idx = j + b; _mochi_idx < 0 ? data_lens[(int)(i + a)] + _mochi_idx : _mochi_idx;})] * kernel[(int)({long long _mochi_idx = a; _mochi_idx < 0 ? kernel_len + _mochi_idx : _mochi_idx;})][(int)({long long _mochi_idx = b; _mochi_idx < 0 ? kernel_lens[(int)(a)] + _mochi_idx : _mochi_idx;})]);
                    b = b + 1LL;
                }
                a = a + 1LL;
            }
            row = list_append_double(row, &row_len, sigmoid(sum - bias));
            j = j + step;
        }
        out = list_append_doubleptr(out, &out_len, row);
        out_lens = list_append_szt(out_lens, &out_lens_len, row_len);
        i = i + step;
    }
    return convolve_lens = out_lens, convolve_len = out_len, out;
}

double * * average_pool(double * * map, size_t map_len, size_t* map_lens, size_t map_lens_len, long long size) {
    double **out = NULL;
    size_t out_len = 0;
    size_t *out_lens = NULL;
    size_t out_lens_len = 0;
    long long i = 0LL;
    while (i < map_len) {
        double *row = NULL;
        size_t row_len = 0;
        long long j = 0LL;
        while (j < map_lens[(int)(i)]) {
            double sum = 0.0;
            long long a = 0LL;
            while (a < size) {
                long long b = 0LL;
                while (b < size) {
                    sum = sum + map[(int)({long long _mochi_idx = i + a; _mochi_idx < 0 ? map_len + _mochi_idx : _mochi_idx;})][(int)({long long _mochi_idx = j + b; _mochi_idx < 0 ? map_lens[(int)(i + a)] + _mochi_idx : _mochi_idx;})];
                    b = b + 1LL;
                }
                a = a + 1LL;
            }
            row = list_append_double(row, &row_len, sum / (size * size));
            j = j + size;
        }
        out = list_append_doubleptr(out, &out_len, row);
        out_lens = list_append_szt(out_lens, &out_lens_len, row_len);
        i = i + size;
    }
    return average_pool_lens = out_lens, average_pool_len = out_len, out;
}

double * flatten(double * * * maps, size_t maps_len, size_t* maps_lens, size_t maps_lens_len, size_t** maps_lens_lens, size_t maps_lens_lens_len) {
    double *out = NULL;
    size_t out_len = 0;
    long long i = 0LL;
    while (i < maps_len) {
        long long j = 0LL;
        while (j < maps_lens[(int)(i)]) {
            long long k = 0LL;
            while (k < maps_lens_lens[(int)(i)][(int)(j)]) {
                out = list_append_double(out, &out_len, maps[(int)({long long _mochi_idx = i; _mochi_idx < 0 ? maps_len + _mochi_idx : _mochi_idx;})][(int)({long long _mochi_idx = j; _mochi_idx < 0 ? maps_lens[(int)(i)] + _mochi_idx : _mochi_idx;})][(int)({long long _mochi_idx = k; _mochi_idx < 0 ? maps_lens_lens[(int)(i)][(int)(j)] + _mochi_idx : _mochi_idx;})]);
                k = k + 1LL;
            }
            j = j + 1LL;
        }
        i = i + 1LL;
    }
    return flatten_len = out_len, out;
}

double * vec_mul_mat(double * v, size_t v_len, double * * m, size_t m_len, size_t* m_lens, size_t m_lens_len) {
    long long cols = m_lens[(int)(0LL)];
    double *res = NULL;
    size_t res_len = 0;
    long long j = 0LL;
    while (j < cols) {
        double sum = 0.0;
        long long i = 0LL;
        while (i < v_len) {
            sum = sum + (v[(int)({long long _mochi_idx = i; _mochi_idx < 0 ? v_len + _mochi_idx : _mochi_idx;})] * m[(int)({long long _mochi_idx = i; _mochi_idx < 0 ? m_len + _mochi_idx : _mochi_idx;})][(int)({long long _mochi_idx = j; _mochi_idx < 0 ? m_lens[(int)(i)] + _mochi_idx : _mochi_idx;})]);
            i = i + 1LL;
        }
        res = list_append_double(res, &res_len, sum);
        j = j + 1LL;
    }
    return vec_mul_mat_len = res_len, res;
}

double * matT_vec_mul(double * * m, size_t m_len, size_t* m_lens, size_t m_lens_len, double * v, size_t v_len) {
    double *res = NULL;
    size_t res_len = 0;
    long long i = 0LL;
    while (i < m_len) {
        double sum = 0.0;
        long long j = 0LL;
        while (j < m_lens[(int)(i)]) {
            sum = sum + (m[(int)({long long _mochi_idx = i; _mochi_idx < 0 ? m_len + _mochi_idx : _mochi_idx;})][(int)({long long _mochi_idx = j; _mochi_idx < 0 ? m_lens[(int)(i)] + _mochi_idx : _mochi_idx;})] * v[(int)({long long _mochi_idx = j; _mochi_idx < 0 ? v_len + _mochi_idx : _mochi_idx;})]);
            j = j + 1LL;
        }
        res = list_append_double(res, &res_len, sum);
        i = i + 1LL;
    }
    return matT_vec_mul_len = res_len, res;
}

double * vec_add(double * a, size_t a_len, double * b, size_t b_len) {
    double *res = NULL;
    size_t res_len = 0;
    long long i = 0LL;
    while (i < a_len) {
        res = list_append_double(res, &res_len, a[(int)({long long _mochi_idx = i; _mochi_idx < 0 ? a_len + _mochi_idx : _mochi_idx;})] + b[(int)({long long _mochi_idx = i; _mochi_idx < 0 ? b_len + _mochi_idx : _mochi_idx;})]);
        i = i + 1LL;
    }
    return vec_add_len = res_len, res;
}

double * vec_sub(double * a, size_t a_len, double * b, size_t b_len) {
    double *res = NULL;
    size_t res_len = 0;
    long long i = 0LL;
    while (i < a_len) {
        res = list_append_double(res, &res_len, a[(int)({long long _mochi_idx = i; _mochi_idx < 0 ? a_len + _mochi_idx : _mochi_idx;})] - b[(int)({long long _mochi_idx = i; _mochi_idx < 0 ? b_len + _mochi_idx : _mochi_idx;})]);
        i = i + 1LL;
    }
    return vec_sub_len = res_len, res;
}

double * vec_mul(double * a, size_t a_len, double * b, size_t b_len) {
    double *res = NULL;
    size_t res_len = 0;
    long long i = 0LL;
    while (i < a_len) {
        res = list_append_double(res, &res_len, a[(int)({long long _mochi_idx = i; _mochi_idx < 0 ? a_len + _mochi_idx : _mochi_idx;})] * b[(int)({long long _mochi_idx = i; _mochi_idx < 0 ? b_len + _mochi_idx : _mochi_idx;})]);
        i = i + 1LL;
    }
    return vec_mul_len = res_len, res;
}

double * vec_map_sig(double * v, size_t v_len) {
    double *res = NULL;
    size_t res_len = 0;
    long long i = 0LL;
    while (i < v_len) {
        res = list_append_double(res, &res_len, sigmoid(v[(int)({long long _mochi_idx = i; _mochi_idx < 0 ? v_len + _mochi_idx : _mochi_idx;})]));
        i = i + 1LL;
    }
    return vec_map_sig_len = res_len, res;
}

CNN new_cnn() {
    static long long k1_0[2] = {1.0, 0.0};
    static long long k1_1[2] = {0.0, 1.0};
    static long long *k1_init[2] = {k1_0, k1_1};
    static long long **k1 = k1_init;
    static const size_t k1_len = 2;
    static size_t k1_lens_init[2] = {2, 2};
    static size_t *k1_lens = k1_lens_init;
    static size_t k1_lens_len = 2;
    static long long k2_0[2] = {0.0, 1.0};
    static long long k2_1[2] = {1.0, 0.0};
    static long long *k2_init[2] = {k2_0, k2_1};
    static long long **k2 = k2_init;
    static const size_t k2_len = 2;
    static size_t k2_lens_init[2] = {2, 2};
    static size_t *k2_lens = k2_lens_init;
    static size_t k2_lens_len = 2;
    static long long **conv_kernels_init[2] = {k1_init, k2_init};
    long long ***conv_kernels = conv_kernels_init;
    size_t conv_kernels_len = 2;
    static size_t conv_kernels_lens_init[2] = {k1_len, k2_len};
    size_t *conv_kernels_lens = conv_kernels_lens_init;
    size_t conv_kernels_lens_len = 2;
    static size_t *conv_kernels_lens_lens_init[2] = {k1_lens_init, k2_lens_init};
    size_t **conv_kernels_lens_lens = conv_kernels_lens_lens_init;
    size_t conv_kernels_lens_lens_len = 2;
    double *conv_bias = NULL;
    size_t conv_bias_len = 0;
    conv_bias = list_append_double(conv_bias, &conv_bias_len, 0.0);
    conv_bias = list_append_double(conv_bias, &conv_bias_len, 0.0);
    long long conv_step = 2LL;
    long long pool_size = 2LL;
    long long input_size = 2LL;
    long long hidden_size = 2LL;
    long long output_size = 2LL;
    double **w_hidden = NULL;
    size_t w_hidden_len = 0;
    size_t *w_hidden_lens = NULL;
    size_t w_hidden_lens_len = 0;
    long long i = 0LL;
    while (i < input_size) {
        double *row = NULL;
        size_t row_len = 0;
        long long j = 0LL;
        while (j < hidden_size) {
            row = list_append_double(row, &row_len, user_random() - 0.5);
            j = j + 1LL;
        }
        w_hidden = list_append_doubleptr(w_hidden, &w_hidden_len, row);
        w_hidden_lens = list_append_szt(w_hidden_lens, &w_hidden_lens_len, row_len);
        i = i + 1LL;
    }
    double **w_out = NULL;
    size_t w_out_len = 0;
    size_t *w_out_lens = NULL;
    size_t w_out_lens_len = 0;
    i = 0LL;
    while (i < hidden_size) {
        double *row = NULL;
        size_t row_len = 0;
        long long j = 0LL;
        while (j < output_size) {
            row = list_append_double(row, &row_len, user_random() - 0.5);
            j = j + 1LL;
        }
        w_out = list_append_doubleptr(w_out, &w_out_len, row);
        w_out_lens = list_append_szt(w_out_lens, &w_out_lens_len, row_len);
        i = i + 1LL;
    }
    double *b_hidden = NULL;
    size_t b_hidden_len = 0;
    b_hidden = list_append_double(b_hidden, &b_hidden_len, 0.0);
    b_hidden = list_append_double(b_hidden, &b_hidden_len, 0.0);
    double *b_out = NULL;
    size_t b_out_len = 0;
    b_out = list_append_double(b_out, &b_out_len, 0.0);
    b_out = list_append_double(b_out, &b_out_len, 0.0);
    return (CNN){.conv_kernels = conv_kernels, .conv_kernels_len = conv_kernels_len, .conv_kernels_lens = conv_kernels_lens, .conv_kernels_lens_len = conv_kernels_len, .conv_bias = conv_bias, .conv_bias_len = conv_bias_len, .conv_step = conv_step, .pool_size = pool_size, .w_hidden = w_hidden, .w_hidden_len = w_hidden_len, .w_hidden_lens = w_hidden_lens, .w_hidden_lens_len = w_hidden_len, .w_out = w_out, .w_out_len = w_out_len, .w_out_lens = w_out_lens, .w_out_lens_len = w_out_len, .b_hidden = b_hidden, .b_hidden_len = b_hidden_len, .b_out = b_out, .b_out_len = b_out_len, .rate_weight = 0.2, .rate_bias = 0.2};
}

double * forward(CNN cnn, double * * data, size_t data_len, size_t* data_lens, size_t data_lens_len) {
    double ***maps = NULL;
    size_t maps_len = 0;
    size_t *maps_lens = NULL;
    size_t maps_lens_len = 0;
    size_t **maps_lens_lens = NULL;
    size_t maps_lens_lens_len = 0;
    long long i = 0LL;
    while (i < cnn.conv_kernels_len) {
        double **conv_map = convolve(data, data_len, data_lens, data_len, cnn.conv_kernels[(int)({long long _mochi_idx = i; _mochi_idx < 0 ? cnn.conv_kernels_len + _mochi_idx : _mochi_idx;})], cnn.conv_kernels_lens[i], NULL, cnn.conv_kernels_lens[i], cnn.conv_step, cnn.conv_bias[(int)({long long _mochi_idx = i; _mochi_idx < 0 ? cnn.conv_bias_len + _mochi_idx : _mochi_idx;})]);
        size_t conv_map_len = convolve_len;
        size_t *conv_map_lens = convolve_lens;
        size_t conv_map_lens_len = convolve_len;
        double **pooled = average_pool(conv_map, conv_map_len, conv_map_lens, conv_map_len, cnn.pool_size);
        size_t pooled_len = average_pool_len;
        size_t *pooled_lens = average_pool_lens;
        size_t pooled_lens_len = average_pool_len;
        maps = list_append_doubleptrptr(maps, &maps_len, pooled);
        maps_lens = list_append_szt(maps_lens, &maps_lens_len, pooled_len);
        maps_lens_lens = list_append_szptr(maps_lens_lens, &maps_lens_lens_len, pooled_lens);
        i = i + 1LL;
    }
    double *flat = flatten(maps, maps_len, maps_lens, maps_len, maps_lens_lens, maps_len);
    size_t flat_len = flatten_len;
    double *hidden_net = ({double* __tmp10 = vec_mul_mat(flat, flat_len, cnn.w_hidden, cnn.w_hidden_len, cnn.w_hidden_lens, cnn.w_hidden_len); size_t __tmp10_len = vec_mul_mat_len; vec_add(__tmp10, __tmp10_len, cnn.b_hidden, cnn.b_hidden_len);});
    size_t hidden_net_len = vec_add_len;
    double *hidden_out = vec_map_sig(hidden_net, hidden_net_len);
    size_t hidden_out_len = vec_map_sig_len;
    double *out_net = ({double* __tmp11 = vec_mul_mat(hidden_out, hidden_out_len, cnn.w_out, cnn.w_out_len, cnn.w_out_lens, cnn.w_out_len); size_t __tmp11_len = vec_mul_mat_len; vec_add(__tmp11, __tmp11_len, cnn.b_out, cnn.b_out_len);});
    size_t out_net_len = vec_add_len;
    double *out = vec_map_sig(out_net, out_net_len);
    size_t out_len = vec_map_sig_len;
    return forward_len = out_len, out;
}

CNN train(CNN cnn, TrainSample * samples, size_t samples_len, long long epochs) {
    double **w_out = cnn.w_out;
    size_t w_out_len = cnn.w_out_len;
    size_t *w_out_lens = cnn.w_out_lens;
    size_t w_out_lens_len = cnn.w_out_len;
    double *b_out = cnn.b_out;
    size_t b_out_len = cnn.b_out_len;
    double **w_hidden = cnn.w_hidden;
    size_t w_hidden_len = cnn.w_hidden_len;
    size_t *w_hidden_lens = cnn.w_hidden_lens;
    size_t w_hidden_lens_len = cnn.w_hidden_len;
    double *b_hidden = cnn.b_hidden;
    size_t b_hidden_len = cnn.b_hidden_len;
    long long e = 0LL;
    while (e < epochs) {
        long long s = 0LL;
        while (s < samples_len) {
            double **data = samples[(int)({long long _mochi_idx = s; _mochi_idx < 0 ? samples_len + _mochi_idx : _mochi_idx;})].image;
            size_t data_len = samples[(int)({long long _mochi_idx = s; _mochi_idx < 0 ? samples_len + _mochi_idx : _mochi_idx;})].image_len;
            size_t *data_lens = samples[(int)({long long _mochi_idx = s; _mochi_idx < 0 ? samples_len + _mochi_idx : _mochi_idx;})].image_lens;
            size_t data_lens_len = samples[(int)({long long _mochi_idx = s; _mochi_idx < 0 ? samples_len + _mochi_idx : _mochi_idx;})].image_len;
            double *target = samples[(int)({long long _mochi_idx = s; _mochi_idx < 0 ? samples_len + _mochi_idx : _mochi_idx;})].target;
            size_t target_len = samples[(int)({long long _mochi_idx = s; _mochi_idx < 0 ? samples_len + _mochi_idx : _mochi_idx;})].target_len;
            double ***maps = NULL;
            size_t maps_len = 0;
            size_t *maps_lens = NULL;
            size_t maps_lens_len = 0;
            size_t **maps_lens_lens = NULL;
            size_t maps_lens_lens_len = 0;
            long long i = 0LL;
            while (i < cnn.conv_kernels_len) {
                double **conv_map = convolve(data, data_len, data_lens, data_len, cnn.conv_kernels[(int)({long long _mochi_idx = i; _mochi_idx < 0 ? cnn.conv_kernels_len + _mochi_idx : _mochi_idx;})], cnn.conv_kernels_lens[i], NULL, cnn.conv_kernels_lens[i], cnn.conv_step, cnn.conv_bias[(int)({long long _mochi_idx = i; _mochi_idx < 0 ? cnn.conv_bias_len + _mochi_idx : _mochi_idx;})]);
                size_t conv_map_len = convolve_len;
                size_t *conv_map_lens = convolve_lens;
                size_t conv_map_lens_len = convolve_len;
                double **pooled = average_pool(conv_map, conv_map_len, conv_map_lens, conv_map_len, cnn.pool_size);
                size_t pooled_len = average_pool_len;
                size_t *pooled_lens = average_pool_lens;
                size_t pooled_lens_len = average_pool_len;
                maps = list_append_doubleptrptr(maps, &maps_len, pooled);
                maps_lens = list_append_szt(maps_lens, &maps_lens_len, pooled_len);
                maps_lens_lens = list_append_szptr(maps_lens_lens, &maps_lens_lens_len, pooled_lens);
                i = i + 1LL;
            }
            double *flat = flatten(maps, maps_len, maps_lens, maps_len, maps_lens_lens, maps_len);
            size_t flat_len = flatten_len;
            double *hidden_net = ({double* __tmp12 = vec_mul_mat(flat, flat_len, w_hidden, w_hidden_len, w_hidden_lens, w_hidden_len); size_t __tmp12_len = vec_mul_mat_len; vec_add(__tmp12, __tmp12_len, b_hidden, b_hidden_len);});
            size_t hidden_net_len = vec_add_len;
            double *hidden_out = vec_map_sig(hidden_net, hidden_net_len);
            size_t hidden_out_len = vec_map_sig_len;
            double *out_net = ({double* __tmp13 = vec_mul_mat(hidden_out, hidden_out_len, w_out, w_out_len, w_out_lens, w_out_len); size_t __tmp13_len = vec_mul_mat_len; vec_add(__tmp13, __tmp13_len, b_out, b_out_len);});
            size_t out_net_len = vec_add_len;
            double *out = vec_map_sig(out_net, out_net_len);
            size_t out_len = vec_map_sig_len;
            double *error_out = vec_sub(target, target_len, out, out_len);
            size_t error_out_len = vec_sub_len;
            double *pd_out = ({double* __tmp14 = ({double* __tmp15 = vec_sub(({double *tmp = malloc(2 * sizeof(double)); tmp[0] = 1.0; tmp[1] = 1.0; tmp;}), 2, out, out_len); size_t __tmp15_len = vec_sub_len; vec_mul(out, out_len, __tmp15, __tmp15_len);}); size_t __tmp14_len = vec_mul_len; vec_mul(error_out, error_out_len, __tmp14, __tmp14_len);});
            size_t pd_out_len = vec_mul_len;
            double *error_hidden = matT_vec_mul(w_out, w_out_len, w_out_lens, w_out_len, pd_out, pd_out_len);
            size_t error_hidden_len = matT_vec_mul_len;
            double *pd_hidden = ({double* __tmp16 = ({double* __tmp17 = vec_sub(({double *tmp = malloc(2 * sizeof(double)); tmp[0] = 1.0; tmp[1] = 1.0; tmp;}), 2, hidden_out, hidden_out_len); size_t __tmp17_len = vec_sub_len; vec_mul(hidden_out, hidden_out_len, __tmp17, __tmp17_len);}); size_t __tmp16_len = vec_mul_len; vec_mul(error_hidden, error_hidden_len, __tmp16, __tmp16_len);});
            size_t pd_hidden_len = vec_mul_len;
            long long j = 0LL;
            while (j < w_out_len) {
                long long k = 0LL;
                while (k < w_out_lens[(int)(j)]) {
                    w_out[(int)(j)][(int)(k)] = w_out[(int)({long long _mochi_idx = j; _mochi_idx < 0 ? w_out_len + _mochi_idx : _mochi_idx;})][(int)({long long _mochi_idx = k; _mochi_idx < 0 ? w_out_lens[(int)(j)] + _mochi_idx : _mochi_idx;})] + ((cnn.rate_weight * hidden_out[(int)({long long _mochi_idx = j; _mochi_idx < 0 ? hidden_out_len + _mochi_idx : _mochi_idx;})]) * pd_out[(int)({long long _mochi_idx = k; _mochi_idx < 0 ? pd_out_len + _mochi_idx : _mochi_idx;})]);
                    k = k + 1LL;
                }
                j = j + 1LL;
            }
            j = 0LL;
            while (j < b_out_len) {
                b_out[(int)(j)] = b_out[(int)({long long _mochi_idx = j; _mochi_idx < 0 ? b_out_len + _mochi_idx : _mochi_idx;})] - (cnn.rate_bias * pd_out[(int)({long long _mochi_idx = j; _mochi_idx < 0 ? pd_out_len + _mochi_idx : _mochi_idx;})]);
                j = j + 1LL;
            }
            long long i_h = 0LL;
            while (i_h < w_hidden_len) {
                long long j_h = 0LL;
                while (j_h < w_hidden_lens[(int)(i_h)]) {
                    w_hidden[(int)(i_h)][(int)(j_h)] = w_hidden[(int)({long long _mochi_idx = i_h; _mochi_idx < 0 ? w_hidden_len + _mochi_idx : _mochi_idx;})][(int)({long long _mochi_idx = j_h; _mochi_idx < 0 ? w_hidden_lens[(int)(i_h)] + _mochi_idx : _mochi_idx;})] + ((cnn.rate_weight * flat[(int)({long long _mochi_idx = i_h; _mochi_idx < 0 ? flat_len + _mochi_idx : _mochi_idx;})]) * pd_hidden[(int)({long long _mochi_idx = j_h; _mochi_idx < 0 ? pd_hidden_len + _mochi_idx : _mochi_idx;})]);
                    j_h = j_h + 1LL;
                }
                i_h = i_h + 1LL;
            }
            j = 0LL;
            while (j < b_hidden_len) {
                b_hidden[(int)(j)] = b_hidden[(int)({long long _mochi_idx = j; _mochi_idx < 0 ? b_hidden_len + _mochi_idx : _mochi_idx;})] - (cnn.rate_bias * pd_hidden[(int)({long long _mochi_idx = j; _mochi_idx < 0 ? pd_hidden_len + _mochi_idx : _mochi_idx;})]);
                j = j + 1LL;
            }
            s = s + 1LL;
        }
        e = e + 1LL;
    }
    return (CNN){.conv_kernels = cnn.conv_kernels, .conv_kernels_len = cnn.conv_kernels_len, .conv_kernels_lens = cnn.conv_kernels_lens, .conv_kernels_lens_len = cnn.conv_kernels_len, .conv_bias = cnn.conv_bias, .conv_bias_len = cnn.conv_bias_len, .conv_step = cnn.conv_step, .pool_size = cnn.pool_size, .w_hidden = w_hidden, .w_hidden_len = w_hidden_len, .w_hidden_lens = w_hidden_lens, .w_hidden_lens_len = w_hidden_len, .w_out = w_out, .w_out_len = w_out_len, .w_out_lens = w_out_lens, .w_out_lens_len = w_out_len, .b_hidden = b_hidden, .b_hidden_len = b_hidden_len, .b_out = b_out, .b_out_len = b_out_len, .rate_weight = cnn.rate_weight, .rate_bias = cnn.rate_bias};
}

const char* user_main() {
    CNN cnn = new_cnn();
    static long long image_0[4] = {1.0, 0.0, 1.0, 0.0};
    static long long image_1[4] = {0.0, 1.0, 0.0, 1.0};
    static long long image_2[4] = {1.0, 0.0, 1.0, 0.0};
    static long long image_3[4] = {0.0, 1.0, 0.0, 1.0};
    static long long *image_init[4] = {image_0, image_1, image_2, image_3};
    static long long **image = image_init;
    static const size_t image_len = 4;
    static size_t image_lens_init[4] = {4, 4, 4, 4};
    static size_t *image_lens = image_lens_init;
    static size_t image_lens_len = 4;
    TrainSample sample = (TrainSample){.image = image, .image_len = image_len, .image_lens = image_lens, .image_lens_len = image_len, .target = ({double *tmp = malloc(2 * sizeof(double)); tmp[0] = 1.0; tmp[1] = 0.0; tmp;}), .target_len = 2};
    double* __tmp18 = forward(cnn, image, image_len, image_lens, image_len);
    puts(str_list_double(__tmp18, forward_len));
    puts("Before training:");
    CNN trained = train(cnn, ({TrainSample *tmp = malloc(1 * sizeof(TrainSample)); tmp[0] = sample; tmp;}), 1, 50LL);
    double* __tmp19 = forward(trained, image, image_len, image_lens, image_len);
    puts(str_list_double(__tmp19, forward_len));
    puts("After training:");
}

int main(void) {
    {
        long long __start = _now();
        user_main();
        long long __end = _now();
        long long __dur_us = (__end - __start + 999) / 1000;
        long long __mem_bytes = _mem();
        printf("{\n  \"duration_us\": %-lld,\n  \"memory_bytes\": %-lld,\n  \"name\": \"main\"\n}\n", __dur_us, __mem_bytes);
    }
    return 0;
}
