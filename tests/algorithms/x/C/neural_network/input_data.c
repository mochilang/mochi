// Generated by Mochi 0.10.32 on 2025-08-22 14:17 +0700
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <malloc.h>

size_t dense_to_one_hot_len;
size_t *dense_to_one_hot_lens;

size_t _slice_intptr_len;
size_t *_slice_intptr_lens;
size_t append_len;
static char* str_int(long long v) {
    char buf[32];
    snprintf(buf, sizeof(buf), "%lld", v);
    return strdup(buf);
}

static char* str_list_int(const long long *arr, size_t len) {
    size_t cap = len * 32 + 2;
    char *buf = malloc(cap);
    size_t pos = 0;
    buf[pos++] = '[';
    for (size_t i = 0; i < len; i++) {
        char tmp[32];
        snprintf(tmp, sizeof(tmp), "%lld", arr[i]);
        size_t n = strlen(tmp);
        if (pos + n + 2 >= cap) { cap = cap * 2 + n + 2; buf = realloc(buf, cap); }
        memcpy(buf + pos, tmp, n);
        pos += n;
        if (i + 1 < len) buf[pos++] = ' ';
    }
    buf[pos++] = ']';
    buf[pos] = 0;
    return buf;
}

static char* str_list_list_int(long long **arr, size_t len, const size_t lens[]) {
    size_t cap = 2;
    for (size_t i = 0; i < len; i++) cap += lens[i] * 32 + 3;
    char *buf = malloc(cap);
    size_t pos = 0;
    buf[pos++] = '[';
    for (size_t i = 0; i < len; i++) {
        char *inner = str_list_int(arr[i], lens[i]);
        size_t n = strlen(inner);
        if (pos + n + 2 >= cap) { cap = cap * 2 + n + 2; buf = realloc(buf, cap); }
        memcpy(buf + pos, inner, n);
        pos += n;
        free(inner);
        if (i + 1 < len) buf[pos++] = ' ';
    }
    buf[pos++] = ']';
    buf[pos] = 0;
    return buf;
}

static long long** list_append_intptr(long long **arr, size_t *len, long long *val) {
    arr = realloc(arr, (*len + 1) * sizeof(long long*));
    arr[*len] = val;
    (*len)++;
    return arr;
}

static size_t* list_append_szt(size_t *arr, size_t *len, size_t val) {
    arr = realloc(arr, (*len + 1) * sizeof(size_t));
    arr[*len] = val;
    (*len)++;
    return arr;
}

static size_t concat_len;
static long long* concat_long_long(long long *a, size_t a_len, const long long *b, size_t b_len) {
    long long *res = realloc(a, (a_len + b_len) * sizeof(long long));
    if (b_len > 0) memcpy(res + a_len, b, b_len * sizeof(long long));
    concat_len = a_len + b_len;
    return res;
}

#include <time.h>
static int seeded_now = 0;
static long long now_seed = 0;
static long long _now(void) {
    if (!seeded_now) {
        const char *s = getenv("MOCHI_NOW_SEED");
        if (s && *s) {
            now_seed = atoll(s);
            seeded_now = 1;
        }
    }
    if (seeded_now) {
        now_seed = (now_seed * 1664525 + 1013904223) % 2147483647;
        return now_seed;
    }
    struct timespec ts;
    clock_gettime(CLOCK_REALTIME, &ts);
    return (long long)(ts.tv_sec * 1000000000LL + ts.tv_nsec);
}

static long long _mem(void) {
    long long size = 0, rss = 0;
    FILE *f = fopen("/proc/self/statm", "r");
    if (f) {
        if (fscanf(f, "%lld %lld", &size, &rss) != 2) rss = 0;
        fclose(f);
    }
    return rss * (long long)sysconf(_SC_PAGESIZE);
}

static void panic(const char *msg) {
    fputs(msg, stderr);
    fputc('\n', stderr);
    exit(1);
}

static long long** _slice_intptr(long long **arr, size_t len, size_t *lens, int start, int end, size_t *out_len, size_t **out_lens) {
    if (start < 0) start = 0;
    if ((size_t)end > len) end = len;
    if (start > end) start = end;
    size_t n = end - start;
    *out_len = n;
    _slice_intptr_len = n;
    *out_lens = lens + start;
    _slice_intptr_lens = lens + start;
    return arr + start;
}

typedef struct DataSet DataSet;
typedef struct Datasets Datasets;
typedef struct BatchResult BatchResult;

struct DataSet {
    long long **images;
    size_t images_len;
    size_t *images_lens;
    size_t images_lens_len;
    long long **labels;
    size_t labels_len;
    size_t *labels_lens;
    size_t labels_lens_len;
    long long num_examples;
    long long index_in_epoch;
    long long epochs_completed;
};

struct Datasets {
    DataSet train;
    DataSet validation;
    DataSet test_ds;
};

struct BatchResult {
    DataSet dataset;
    long long **images;
    size_t images_len;
    size_t *images_lens;
    size_t images_lens_len;
    long long **labels;
    size_t labels_len;
    size_t *labels_lens;
    size_t labels_lens_len;
};

static long long* list_append_long_long(long long *arr, size_t *len, long long val) {
    arr = realloc(arr, (*len + 1) * sizeof(long long));
    arr[*len] = val;
    (*len)++;
    return arr;
}

long long * * dense_to_one_hot(long long * labels, size_t labels_len, long long num_classes);
DataSet new_dataset(long long * * images, size_t images_len, size_t* images_lens, size_t images_lens_len, long long * * labels, size_t labels_len, size_t* labels_lens, size_t labels_lens_len);
BatchResult next_batch(DataSet ds, long long batch_size);
Datasets read_data_sets(long long * * train_images, size_t train_images_len, size_t* train_images_lens, size_t train_images_lens_len, long long * train_labels_raw, size_t train_labels_raw_len, long long * * test_images, size_t test_images_len, size_t* test_images_lens, size_t test_images_lens_len, long long * test_labels_raw, size_t test_labels_raw_len, long long validation_size, long long num_classes);
void user_main();
int main(void);

long long * * dense_to_one_hot(long long * labels, size_t labels_len, long long num_classes) {
    long long **result = NULL;
    size_t result_len = 0;
    size_t *result_lens = NULL;
    size_t result_lens_len = 0;
    long long i = 0LL;
    while (i < labels_len) {
        long long *row = NULL;
        size_t row_len = 0;
        long long j = 0LL;
        while (j < num_classes) {
            if (j == labels[(int)({long long _mochi_idx = i; _mochi_idx < 0 ? labels_len + _mochi_idx : _mochi_idx;})]) {
                row = list_append_long_long(row, &row_len, 1LL);
            } else {
                row = list_append_long_long(row, &row_len, 0LL);
            }
            j = j + 1LL;
        }
        result = list_append_intptr(result, &result_len, row);
        result_lens = list_append_szt(result_lens, &result_lens_len, row_len);
        i = i + 1LL;
    }
    return dense_to_one_hot_lens = result_lens, dense_to_one_hot_len = result_len, result;
}

DataSet new_dataset(long long * * images, size_t images_len, size_t* images_lens, size_t images_lens_len, long long * * labels, size_t labels_len, size_t* labels_lens, size_t labels_lens_len) {
    return (DataSet){.images = images, .images_len = images_len, .images_lens = images_lens, .images_lens_len = images_len, .labels = labels, .labels_len = labels_len, .labels_lens = labels_lens, .labels_lens_len = labels_len, .num_examples = images_len, .index_in_epoch = 0LL, .epochs_completed = 0LL};
}

BatchResult next_batch(DataSet ds, long long batch_size) {
    long long start = ds.index_in_epoch;
    if ((start + batch_size) > ds.num_examples) {
        long long rest = ds.num_examples - start;
        long long **images_rest = _slice_intptr(ds.images, ds.images_len, ds.images_lens, start, ds.num_examples, &(_slice_intptr_len), &(_slice_intptr_lens));
        size_t images_rest_len = _slice_intptr_len;
        size_t *images_rest_lens = _slice_intptr_lens;
        size_t images_rest_lens_len = _slice_intptr_len;
        long long **labels_rest = _slice_intptr(ds.labels, ds.labels_len, ds.labels_lens, start, ds.num_examples, &(_slice_intptr_len), &(_slice_intptr_lens));
        size_t labels_rest_len = _slice_intptr_len;
        size_t *labels_rest_lens = _slice_intptr_lens;
        size_t labels_rest_lens_len = _slice_intptr_len;
        long long new_index = batch_size - rest;
        long long **images_new = _slice_intptr(ds.images, ds.images_len, ds.images_lens, 0LL, new_index, &(_slice_intptr_len), &(_slice_intptr_lens));
        size_t images_new_len = _slice_intptr_len;
        size_t *images_new_lens = _slice_intptr_lens;
        size_t images_new_lens_len = _slice_intptr_len;
        long long **labels_new = _slice_intptr(ds.labels, ds.labels_len, ds.labels_lens, 0LL, new_index, &(_slice_intptr_len), &(_slice_intptr_lens));
        size_t labels_new_len = _slice_intptr_len;
        size_t *labels_new_lens = _slice_intptr_lens;
        size_t labels_new_lens_len = _slice_intptr_len;
        long long batch_images = concat_long_long(images_rest, images_rest_len, images_new, images_new_len);
        long long batch_labels = concat_long_long(labels_rest, labels_rest_len, labels_new, labels_new_len);
        DataSet new_ds = (DataSet){.images = ds.images, .images_len = ds.images_len, .images_lens = ds.images_lens, .images_lens_len = ds.images_len, .labels = ds.labels, .labels_len = ds.labels_len, .labels_lens = ds.labels_lens, .labels_lens_len = ds.labels_len, .num_examples = ds.num_examples, .index_in_epoch = new_index, .epochs_completed = ds.epochs_completed + 1LL};
        return (BatchResult){.dataset = new_ds, .images = batch_images, .images_len = batch_images_len, .images_lens = batch_images_lens, .images_lens_len = batch_images_len, .labels = batch_labels, .labels_len = batch_labels_len, .labels_lens = batch_labels_lens, .labels_lens_len = batch_labels_len};
    } else {
        long long end = start + batch_size;
        long long **batch_images = _slice_intptr(ds.images, ds.images_len, ds.images_lens, start, end, &(_slice_intptr_len), &(_slice_intptr_lens));
        size_t batch_images_len = _slice_intptr_len;
        size_t *batch_images_lens = _slice_intptr_lens;
        size_t batch_images_lens_len = _slice_intptr_len;
        long long **batch_labels = _slice_intptr(ds.labels, ds.labels_len, ds.labels_lens, start, end, &(_slice_intptr_len), &(_slice_intptr_lens));
        size_t batch_labels_len = _slice_intptr_len;
        size_t *batch_labels_lens = _slice_intptr_lens;
        size_t batch_labels_lens_len = _slice_intptr_len;
        DataSet new_ds = (DataSet){.images = ds.images, .images_len = ds.images_len, .images_lens = ds.images_lens, .images_lens_len = ds.images_len, .labels = ds.labels, .labels_len = ds.labels_len, .labels_lens = ds.labels_lens, .labels_lens_len = ds.labels_len, .num_examples = ds.num_examples, .index_in_epoch = end, .epochs_completed = ds.epochs_completed};
        return (BatchResult){.dataset = new_ds, .images = batch_images, .images_len = batch_images_len, .images_lens = batch_images_lens, .images_lens_len = batch_images_len, .labels = batch_labels, .labels_len = batch_labels_len, .labels_lens = batch_labels_lens, .labels_lens_len = batch_labels_len};
    }
}

Datasets read_data_sets(long long * * train_images, size_t train_images_len, size_t* train_images_lens, size_t train_images_lens_len, long long * train_labels_raw, size_t train_labels_raw_len, long long * * test_images, size_t test_images_len, size_t* test_images_lens, size_t test_images_lens_len, long long * test_labels_raw, size_t test_labels_raw_len, long long validation_size, long long num_classes) {
    long long **train_labels = dense_to_one_hot(train_labels_raw, train_labels_raw_len, num_classes);
    size_t train_labels_len = dense_to_one_hot_len;
    size_t *train_labels_lens = dense_to_one_hot_lens;
    size_t train_labels_lens_len = dense_to_one_hot_len;
    long long **test_labels = dense_to_one_hot(test_labels_raw, test_labels_raw_len, num_classes);
    size_t test_labels_len = dense_to_one_hot_len;
    size_t *test_labels_lens = dense_to_one_hot_lens;
    size_t test_labels_lens_len = dense_to_one_hot_len;
    long long **validation_images = _slice_intptr(train_images, train_images_len, train_images_lens, 0LL, validation_size, &(_slice_intptr_len), &(_slice_intptr_lens));
    size_t validation_images_len = _slice_intptr_len;
    size_t *validation_images_lens = _slice_intptr_lens;
    size_t validation_images_lens_len = _slice_intptr_len;
    long long **validation_labels = _slice_intptr(train_labels, train_labels_len, train_labels_lens, 0LL, validation_size, &(_slice_intptr_len), &(_slice_intptr_lens));
    size_t validation_labels_len = _slice_intptr_len;
    size_t *validation_labels_lens = _slice_intptr_lens;
    size_t validation_labels_lens_len = _slice_intptr_len;
    long long **train_images_rest = _slice_intptr(train_images, train_images_len, train_images_lens, validation_size, train_images_len, &(_slice_intptr_len), &(_slice_intptr_lens));
    size_t train_images_rest_len = _slice_intptr_len;
    size_t *train_images_rest_lens = _slice_intptr_lens;
    size_t train_images_rest_lens_len = _slice_intptr_len;
    long long **train_labels_rest = _slice_intptr(train_labels, train_labels_len, train_labels_lens, validation_size, train_labels_len, &(_slice_intptr_len), &(_slice_intptr_lens));
    size_t train_labels_rest_len = _slice_intptr_len;
    size_t *train_labels_rest_lens = _slice_intptr_lens;
    size_t train_labels_rest_lens_len = _slice_intptr_len;
    DataSet train = new_dataset(train_images_rest, train_images_rest_len, train_images_rest_lens, train_images_rest_len, train_labels_rest, train_labels_rest_len, train_labels_rest_lens, train_labels_rest_len);
    DataSet validation = new_dataset(validation_images, validation_images_len, validation_images_lens, validation_images_len, validation_labels, validation_labels_len, validation_labels_lens, validation_labels_len);
    DataSet testset = new_dataset(test_images, test_images_len, test_images_lens, test_images_len, test_labels, test_labels_len, test_labels_lens, test_labels_len);
    return (Datasets){.train = train, .validation = validation, .test_ds = testset};
}

void user_main() {
    long long train_images_0[2] = {0LL, 1LL};
    long long train_images_1[2] = {1LL, 2LL};
    long long train_images_2[2] = {2LL, 3LL};
    long long train_images_3[2] = {3LL, 4LL};
    long long train_images_4[2] = {4LL, 5LL};
    long long *train_images_init[5] = {train_images_0, train_images_1, train_images_2, train_images_3, train_images_4};
    long long **train_images = train_images_init;
    size_t train_images_len = 5;
    size_t train_images_lens_init[5] = {2, 2, 2, 2, 2};
    size_t *train_images_lens = train_images_lens_init;
    size_t train_images_lens_len = 5;
    long long *train_labels_raw = NULL;
    size_t train_labels_raw_len = 0;
    train_labels_raw = list_append_long_long(train_labels_raw, &train_labels_raw_len, 0LL);
    train_labels_raw = list_append_long_long(train_labels_raw, &train_labels_raw_len, 1LL);
    train_labels_raw = list_append_long_long(train_labels_raw, &train_labels_raw_len, 2LL);
    train_labels_raw = list_append_long_long(train_labels_raw, &train_labels_raw_len, 3LL);
    train_labels_raw = list_append_long_long(train_labels_raw, &train_labels_raw_len, 4LL);
    long long test_images_0[2] = {5LL, 6LL};
    long long test_images_1[2] = {6LL, 7LL};
    long long *test_images_init[2] = {test_images_0, test_images_1};
    long long **test_images = test_images_init;
    size_t test_images_len = 2;
    size_t test_images_lens_init[2] = {2, 2};
    size_t *test_images_lens = test_images_lens_init;
    size_t test_images_lens_len = 2;
    long long *test_labels_raw = NULL;
    size_t test_labels_raw_len = 0;
    test_labels_raw = list_append_long_long(test_labels_raw, &test_labels_raw_len, 5LL);
    test_labels_raw = list_append_long_long(test_labels_raw, &test_labels_raw_len, 6LL);
    Datasets data = read_data_sets(train_images, train_images_len, train_images_lens, train_images_len, train_labels_raw, train_labels_raw_len, test_images, test_images_len, test_images_lens, test_images_len, test_labels_raw, test_labels_raw_len, 2LL, 10LL);
    DataSet ds = data.train;
    BatchResult res = next_batch(ds, 2LL);
    ds = res.dataset;
    puts(str_list_list_int(res.images, res.images_len, res.images_lens));
    puts(str_list_list_int(res.labels, res.labels_len, res.labels_lens));
    res = next_batch(ds, 2LL);
    ds = res.dataset;
    puts(str_list_list_int(res.images, res.images_len, res.images_lens));
    puts(str_list_list_int(res.labels, res.labels_len, res.labels_lens));
    res = next_batch(ds, 2LL);
    ds = res.dataset;
    puts(str_list_list_int(res.images, res.images_len, res.images_lens));
    puts(str_list_list_int(res.labels, res.labels_len, res.labels_lens));
}

int main(void) {
    {
        long long __start = _now();
        user_main();
        long long __end = _now();
        long long __dur_us = (__end - __start) / 1000;
        long long __mem_bytes = _mem();
        printf("{\n  \"duration_us\": %-lld,\n  \"memory_bytes\": %-lld,\n  \"name\": \"main\"\n}\n", __dur_us, __mem_bytes);
    }
    return 0;
}
