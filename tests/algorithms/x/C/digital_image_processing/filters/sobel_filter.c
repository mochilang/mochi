// Generated by Mochi 0.10.32 on 2025-08-25 17:21 +0700
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <malloc.h>
#include <math.h>

size_t zeros_len;
size_t *zeros_lens;
size_t pad_edge_len;
size_t *pad_edge_lens;
size_t img_convolve_len;
size_t *img_convolve_lens;
size_t abs_matrix_len;
size_t *abs_matrix_lens;
size_t scale_matrix_len;
size_t *scale_matrix_lens;
size_t sobel_filter_len;
size_t *sobel_filter_lens;
size_t **sobel_filter_lens_lens;

size_t append_len;
static char* str_concat(const char *a, const char *b) {
    size_t len1 = strlen(a);
    size_t len2 = strlen(b);
    char *res = malloc(len1 + len2 + 1);
    memcpy(res, a, len1);
    memcpy(res + len1, b, len2);
    res[len1 + len2] = 0;
    return res;
}

static char* str_int(long long v) {
    char buf[32];
    snprintf(buf, sizeof(buf), "%lld", v);
    return strdup(buf);
}

static char* str_float(double v) {
    char buf[64];
    snprintf(buf, sizeof(buf), "%f", v);
    char *p = buf + strlen(buf) - 1;
    while (p > buf && *p == '0') *p-- = '\0';
    if (p > buf && *p == '.') *p = '\0';
    return strdup(buf);
}

static double* list_append_double(double *arr, size_t *len, double val) {
    arr = realloc(arr, (*len + 1) * sizeof(double));
    arr[*len] = val;
    (*len)++;
    return arr;
}

static long long** list_append_intptr(long long **arr, size_t *len, long long *val) {
    arr = realloc(arr, (*len + 1) * sizeof(long long*));
    arr[*len] = val;
    (*len)++;
    return arr;
}

static double** list_append_doubleptr(double **arr, size_t *len, double *val) {
    arr = realloc(arr, (*len + 1) * sizeof(double*));
    arr[*len] = val;
    (*len)++;
    return arr;
}

static size_t* list_append_szt(size_t *arr, size_t *len, size_t val) {
    arr = realloc(arr, (*len + 1) * sizeof(size_t));
    arr[*len] = val;
    (*len)++;
    return arr;
}

#include <time.h>
static int seeded_now = 0;
static long long now_seed = 0;
static long long _now(void) {
    if (!seeded_now) {
        const char *s = getenv("MOCHI_NOW_SEED");
        if (s && *s) {
            now_seed = atoll(s);
            seeded_now = 1;
        }
    }
    if (seeded_now) {
        now_seed = (now_seed * 1664525 + 1013904223) % 2147483647;
        return now_seed;
    }
    struct timespec ts;
    clock_gettime(CLOCK_REALTIME, &ts);
    return (long long)(ts.tv_sec * 1000000000LL + ts.tv_nsec);
}

static long long _mem(void) {
    long long size = 0, rss = 0;
    FILE *f = fopen("/proc/self/statm", "r");
    if (f) {
        if (fscanf(f, "%lld %lld", &size, &rss) != 2) rss = 0;
        fclose(f);
    }
    return rss * (long long)sysconf(_SC_PAGESIZE);
}

static void panic(const char *msg) {
    fputs(msg, stderr);
    fputc('\n', stderr);
    exit(1);
}

double PI = 3.141592653589793;

double absf(double x);
double sqrtApprox(double x);
double atanApprox(double x);
double atan2Approx(double y, double x);
double * * zeros(long long h, long long w);
double * * pad_edge(double * * img, size_t img_len, size_t* img_lens, size_t img_lens_len, long long pad);
double * * img_convolve(double * * img, size_t img_len, size_t* img_lens, size_t img_lens_len, long long * * kernel, size_t kernel_len, size_t* kernel_lens, size_t kernel_lens_len);
double * * abs_matrix(double * * mat, size_t mat_len, size_t* mat_lens, size_t mat_lens_len);
double max_matrix(double * * mat, size_t mat_len, size_t* mat_lens, size_t mat_lens_len);
double * * scale_matrix(double * * mat, size_t mat_len, size_t* mat_lens, size_t mat_lens_len, double factor);
double * * * sobel_filter(long long * * image, size_t image_len, size_t* image_lens, size_t image_lens_len);
void print_matrix_int(double * * mat, size_t mat_len, size_t* mat_lens, size_t mat_lens_len);
void print_matrix_float(double * * mat, size_t mat_len, size_t* mat_lens, size_t mat_lens_len);
void user_main();
int main(void);

double absf(double x) {
    if (x < 0.0) {
        return -(x);
    }
    return x;
}

double sqrtApprox(double x) {
    if (x <= 0.0) {
        return 0.0;
    }
    double guess = x / 2.0;
    long long i = 0LL;
    while (i < 20LL) {
        guess = (guess + (x / guess)) / 2.0;
        i = i + 1LL;
    }
    return guess;
}

double atanApprox(double x) {
    if (x > 1.0) {
        return (PI / 2.0) - (x / ((x * x) + 0.28));
    }
    if (x < -1.0) {
        return (-(PI) / 2.0) - (x / ((x * x) + 0.28));
    }
    return x / (1.0 + ((0.28 * x) * x));
}

double atan2Approx(double y, double x) {
    if (x == 0.0) {
        if (y > 0.0) {
            return PI / 2.0;
        }
        if (y < 0.0) {
            return -(PI) / 2.0;
        }
        return 0.0;
    }
    double a = atanApprox(y / x);
    if (x > 0.0) {
        return a;
    }
    if (y >= 0.0) {
        return a + PI;
    }
    return a - PI;
}

double * * zeros(long long h, long long w) {
    double **m = NULL;
    size_t m_len = 0;
    size_t *m_lens = NULL;
    size_t m_lens_len = 0;
    long long y = 0LL;
    while (y < h) {
        double *row = NULL;
        size_t row_len = 0;
        long long x = 0LL;
        while (x < w) {
            row = list_append_double(row, &row_len, 0.0);
            x = x + 1LL;
        }
        m = list_append_doubleptr(m, &m_len, row);
        m_lens = list_append_szt(m_lens, &m_lens_len, row_len);
        y = y + 1LL;
    }
    return zeros_lens = m_lens, zeros_len = m_len, m;
}

double * * pad_edge(double * * img, size_t img_len, size_t* img_lens, size_t img_lens_len, long long pad) {
    long long h = img_len;
    long long w = img_lens[(int)(0LL)];
    double **out = zeros(h + (pad * 2LL), w + (pad * 2LL));
    size_t out_len = zeros_len;
    size_t *out_lens = zeros_lens;
    size_t out_lens_len = zeros_len;
    long long y = 0LL;
    while (y < (h + (pad * 2LL))) {
        long long x = 0LL;
        while (x < (w + (pad * 2LL))) {
            long long sy = y - pad;
            if (sy < 0LL) {
                sy = 0LL;
            }
            if (sy >= h) {
                sy = h - 1LL;
            }
            long long sx = x - pad;
            if (sx < 0LL) {
                sx = 0LL;
            }
            if (sx >= w) {
                sx = w - 1LL;
            }
            out[(int)(y)][(int)(x)] = img[(int)({long long _mochi_idx = sy; _mochi_idx < 0 ? img_len + _mochi_idx : _mochi_idx;})][(int)({long long _mochi_idx = sx; _mochi_idx < 0 ? img_lens[(int)(sy)] + _mochi_idx : _mochi_idx;})];
            x = x + 1LL;
        }
        y = y + 1LL;
    }
    return pad_edge_lens = out_lens, pad_edge_len = out_len, out;
}

double * * img_convolve(double * * img, size_t img_len, size_t* img_lens, size_t img_lens_len, long long * * kernel, size_t kernel_len, size_t* kernel_lens, size_t kernel_lens_len) {
    long long h = img_len;
    long long w = img_lens[(int)(0LL)];
    long long k = kernel_len;
    long long pad = k / 2LL;
    double **padded = pad_edge(img, img_len, img_lens, img_len, pad);
    size_t padded_len = pad_edge_len;
    size_t *padded_lens = pad_edge_lens;
    size_t padded_lens_len = pad_edge_len;
    double **out = zeros(h, w);
    size_t out_len = zeros_len;
    size_t *out_lens = zeros_lens;
    size_t out_lens_len = zeros_len;
    long long y = 0LL;
    while (y < h) {
        long long x = 0LL;
        while (x < w) {
            double sum = 0.0;
            long long i = 0LL;
            while (i < k) {
                long long j = 0LL;
                while (j < k) {
                    sum = sum + (padded[(int)({long long _mochi_idx = y + i; _mochi_idx < 0 ? padded_len + _mochi_idx : _mochi_idx;})][(int)({long long _mochi_idx = x + j; _mochi_idx < 0 ? padded_lens[(int)(y + i)] + _mochi_idx : _mochi_idx;})] * (double)(kernel[(int)({long long _mochi_idx = i; _mochi_idx < 0 ? kernel_len + _mochi_idx : _mochi_idx;})][(int)({long long _mochi_idx = j; _mochi_idx < 0 ? kernel_lens[(int)(i)] + _mochi_idx : _mochi_idx;})]));
                    j = j + 1LL;
                }
                i = i + 1LL;
            }
            out[(int)(y)][(int)(x)] = sum;
            x = x + 1LL;
        }
        y = y + 1LL;
    }
    return img_convolve_lens = out_lens, img_convolve_len = out_len, out;
}

double * * abs_matrix(double * * mat, size_t mat_len, size_t* mat_lens, size_t mat_lens_len) {
    long long h = mat_len;
    long long w = mat_lens[(int)(0LL)];
    double **out = zeros(h, w);
    size_t out_len = zeros_len;
    size_t *out_lens = zeros_lens;
    size_t out_lens_len = zeros_len;
    long long y = 0LL;
    while (y < h) {
        long long x = 0LL;
        while (x < w) {
            double v = mat[(int)({long long _mochi_idx = y; _mochi_idx < 0 ? mat_len + _mochi_idx : _mochi_idx;})][(int)({long long _mochi_idx = x; _mochi_idx < 0 ? mat_lens[(int)(y)] + _mochi_idx : _mochi_idx;})];
            if (v < 0.0) {
                out[(int)(y)][(int)(x)] = -(v);
            } else {
                out[(int)(y)][(int)(x)] = v;
            }
            x = x + 1LL;
        }
        y = y + 1LL;
    }
    return abs_matrix_lens = out_lens, abs_matrix_len = out_len, out;
}

double max_matrix(double * * mat, size_t mat_len, size_t* mat_lens, size_t mat_lens_len) {
    double max_val = mat[(int)({long long _mochi_idx = 0LL; _mochi_idx < 0 ? mat_len + _mochi_idx : _mochi_idx;})][(int)({long long _mochi_idx = 0LL; _mochi_idx < 0 ? mat_lens[(int)(0LL)] + _mochi_idx : _mochi_idx;})];
    long long y = 0LL;
    while (y < mat_len) {
        long long x = 0LL;
        while (x < mat_lens[(int)(0LL)]) {
            if (mat[(int)({long long _mochi_idx = y; _mochi_idx < 0 ? mat_len + _mochi_idx : _mochi_idx;})][(int)({long long _mochi_idx = x; _mochi_idx < 0 ? mat_lens[(int)(y)] + _mochi_idx : _mochi_idx;})] > max_val) {
                max_val = mat[(int)({long long _mochi_idx = y; _mochi_idx < 0 ? mat_len + _mochi_idx : _mochi_idx;})][(int)({long long _mochi_idx = x; _mochi_idx < 0 ? mat_lens[(int)(y)] + _mochi_idx : _mochi_idx;})];
            }
            x = x + 1LL;
        }
        y = y + 1LL;
    }
    return max_val;
}

double * * scale_matrix(double * * mat, size_t mat_len, size_t* mat_lens, size_t mat_lens_len, double factor) {
    long long h = mat_len;
    long long w = mat_lens[(int)(0LL)];
    double **out = zeros(h, w);
    size_t out_len = zeros_len;
    size_t *out_lens = zeros_lens;
    size_t out_lens_len = zeros_len;
    long long y = 0LL;
    while (y < h) {
        long long x = 0LL;
        while (x < w) {
            out[(int)(y)][(int)(x)] = mat[(int)({long long _mochi_idx = y; _mochi_idx < 0 ? mat_len + _mochi_idx : _mochi_idx;})][(int)({long long _mochi_idx = x; _mochi_idx < 0 ? mat_lens[(int)(y)] + _mochi_idx : _mochi_idx;})] * factor;
            x = x + 1LL;
        }
        y = y + 1LL;
    }
    return scale_matrix_lens = out_lens, scale_matrix_len = out_len, out;
}

double * * * sobel_filter(long long * * image, size_t image_len, size_t* image_lens, size_t image_lens_len) {
    long long h = image_len;
    long long w = image_lens[(int)(0LL)];
    double **img = NULL;
    size_t img_len = 0;
    size_t *img_lens = NULL;
    size_t img_lens_len = 0;
    long long y0_ = 0LL;
    while (y0_ < h) {
        double *row = NULL;
        size_t row_len = 0;
        long long x0 = 0LL;
        while (x0 < w) {
            row = list_append_double(row, &row_len, (double)(image[(int)({long long _mochi_idx = y0_; _mochi_idx < 0 ? image_len + _mochi_idx : _mochi_idx;})][(int)({long long _mochi_idx = x0; _mochi_idx < 0 ? image_lens[(int)(y0_)] + _mochi_idx : _mochi_idx;})]));
            x0 = x0 + 1LL;
        }
        img = list_append_doubleptr(img, &img_len, row);
        img_lens = list_append_szt(img_lens, &img_lens_len, row_len);
        y0_ = y0_ + 1LL;
    }
    long long kernel_x_0[3] = {-1LL, 0LL, 1LL};
    long long kernel_x_1[3] = {-2LL, 0LL, 2LL};
    long long kernel_x_2[3] = {-1LL, 0LL, 1LL};
    long long *kernel_x_init[3] = {kernel_x_0, kernel_x_1, kernel_x_2};
    long long **kernel_x = kernel_x_init;
    size_t kernel_x_len = 3;
    size_t kernel_x_lens_init[3] = {3, 3, 3};
    size_t *kernel_x_lens = kernel_x_lens_init;
    size_t kernel_x_lens_len = 3;
    long long kernel_y_0[3] = {1LL, 2LL, 1LL};
    long long kernel_y_1[3] = {0LL, 0LL, 0LL};
    long long kernel_y_2[3] = {-1LL, -2LL, -1LL};
    long long *kernel_y_init[3] = {kernel_y_0, kernel_y_1, kernel_y_2};
    long long **kernel_y = kernel_y_init;
    size_t kernel_y_len = 3;
    size_t kernel_y_lens_init[3] = {3, 3, 3};
    size_t *kernel_y_lens = kernel_y_lens_init;
    size_t kernel_y_lens_len = 3;
    double **dst_x = ({double** __tmp2 = img_convolve(img, img_len, img_lens, img_len, kernel_x, kernel_x_len, kernel_x_lens, kernel_x_len); size_t __tmp2_len = img_convolve_len; size_t* __tmp2_lens = img_convolve_lens; abs_matrix(__tmp2, __tmp2_len, __tmp2_lens, __tmp2_len);});
    size_t dst_x_len = abs_matrix_len;
    size_t *dst_x_lens = abs_matrix_lens;
    size_t dst_x_lens_len = abs_matrix_len;
    double **dst_y = ({double** __tmp3 = img_convolve(img, img_len, img_lens, img_len, kernel_y, kernel_y_len, kernel_y_lens, kernel_y_len); size_t __tmp3_len = img_convolve_len; size_t* __tmp3_lens = img_convolve_lens; abs_matrix(__tmp3, __tmp3_len, __tmp3_lens, __tmp3_len);});
    size_t dst_y_len = abs_matrix_len;
    size_t *dst_y_lens = abs_matrix_lens;
    size_t dst_y_lens_len = abs_matrix_len;
    double max_x = max_matrix(dst_x, dst_x_len, dst_x_lens, dst_x_len);
    double max_y = max_matrix(dst_y, dst_y_len, dst_y_lens, dst_y_len);
    dst_x = scale_matrix(dst_x, dst_x_len, dst_x_lens, dst_x_len, 255.0 / max_x);
    dst_x_len = scale_matrix_len;
    dst_x_lens = scale_matrix_lens;
    dst_y = scale_matrix(dst_y, dst_y_len, dst_y_lens, dst_y_len, 255.0 / max_y);
    dst_y_len = scale_matrix_len;
    dst_y_lens = scale_matrix_lens;
    double **mag = zeros(h, w);
    size_t mag_len = zeros_len;
    size_t *mag_lens = zeros_lens;
    size_t mag_lens_len = zeros_len;
    double **theta = zeros(h, w);
    size_t theta_len = zeros_len;
    size_t *theta_lens = zeros_lens;
    size_t theta_lens_len = zeros_len;
    long long y = 0LL;
    while (y < h) {
        long long x = 0LL;
        while (x < w) {
            double gx = dst_x[(int)({long long _mochi_idx = y; _mochi_idx < 0 ? dst_x_len + _mochi_idx : _mochi_idx;})][(int)({long long _mochi_idx = x; _mochi_idx < 0 ? dst_x_lens[(int)(y)] + _mochi_idx : _mochi_idx;})];
            double gy = dst_y[(int)({long long _mochi_idx = y; _mochi_idx < 0 ? dst_y_len + _mochi_idx : _mochi_idx;})][(int)({long long _mochi_idx = x; _mochi_idx < 0 ? dst_y_lens[(int)(y)] + _mochi_idx : _mochi_idx;})];
            mag[(int)(y)][(int)(x)] = sqrtApprox((gx * gx) + (gy * gy));
            theta[(int)(y)][(int)(x)] = atan2Approx(gy, gx);
            x = x + 1LL;
        }
        y = y + 1LL;
    }
    double max_m = max_matrix(mag, mag_len, mag_lens, mag_len);
    mag = scale_matrix(mag, mag_len, mag_lens, mag_len, 255.0 / max_m);
    mag_len = scale_matrix_len;
    mag_lens = scale_matrix_lens;
    {
        size_t *__tmp4_lens = malloc(2 * sizeof(size_t));
        size_t **__tmp4_lens_lens = malloc(2 * sizeof(size_t*));
        __tmp4_lens[0] = mag_len;
        __tmp4_lens_lens[0] = mag_lens;
        __tmp4_lens[1] = theta_len;
        __tmp4_lens_lens[1] = theta_lens;
        double*** __tmp4_data = malloc(2 * sizeof(double**));
        __tmp4_data[0] = mag;
        __tmp4_data[1] = theta;
        sobel_filter_lens_lens = __tmp4_lens_lens;
        sobel_filter_lens = __tmp4_lens;
        sobel_filter_len = 2;
        return __tmp4_data;
    }
}

void print_matrix_int(double * * mat, size_t mat_len, size_t* mat_lens, size_t mat_lens_len) {
    long long y = 0LL;
    while (y < mat_len) {
        const char* line = "";
        long long x = 0LL;
        while (x < mat_lens[(int)(y)]) {
            line = str_concat(line, str_int((int)(mat[(int)({long long _mochi_idx = y; _mochi_idx < 0 ? mat_len + _mochi_idx : _mochi_idx;})][(int)({long long _mochi_idx = x; _mochi_idx < 0 ? mat_lens[(int)(y)] + _mochi_idx : _mochi_idx;})])));
            if (x < (mat_lens[(int)(y)] - 1LL)) {
                line = str_concat(line, " ");
            }
            x = x + 1LL;
        }
        puts(line);
        y = y + 1LL;
    }
}

void print_matrix_float(double * * mat, size_t mat_len, size_t* mat_lens, size_t mat_lens_len) {
    long long y = 0LL;
    while (y < mat_len) {
        const char* line = "";
        long long x = 0LL;
        while (x < mat_lens[(int)(y)]) {
            line = str_concat(line, str_float(mat[(int)({long long _mochi_idx = y; _mochi_idx < 0 ? mat_len + _mochi_idx : _mochi_idx;})][(int)({long long _mochi_idx = x; _mochi_idx < 0 ? mat_lens[(int)(y)] + _mochi_idx : _mochi_idx;})]));
            if (x < (mat_lens[(int)(y)] - 1LL)) {
                line = str_concat(line, " ");
            }
            x = x + 1LL;
        }
        puts(line);
        y = y + 1LL;
    }
}

void user_main() {
    long long img_0[5] = {10LL, 10LL, 10LL, 10LL, 10LL};
    long long img_1[5] = {10LL, 50LL, 50LL, 50LL, 10LL};
    long long img_2[5] = {10LL, 50LL, 80LL, 50LL, 10LL};
    long long img_3[5] = {10LL, 50LL, 50LL, 50LL, 10LL};
    long long img_4[5] = {10LL, 10LL, 10LL, 10LL, 10LL};
    long long *img_init[5] = {img_0, img_1, img_2, img_3, img_4};
    long long **img = img_init;
    size_t img_len = 5;
    size_t img_lens_init[5] = {5, 5, 5, 5, 5};
    size_t *img_lens = img_lens_init;
    size_t img_lens_len = 5;
    double ***res = sobel_filter(img, img_len, img_lens, img_len);
    size_t res_len = sobel_filter_len;
    size_t *res_lens = sobel_filter_lens;
    size_t res_lens_len = sobel_filter_len;
    size_t **res_lens_lens = sobel_filter_lens_lens;
    size_t res_lens_lens_len = sobel_filter_len;
    double **mag = res[(int)({long long _mochi_idx = 0LL; _mochi_idx < 0 ? res_len + _mochi_idx : _mochi_idx;})];
    size_t mag_len = res_lens[(int)(0LL)];
    size_t *mag_lens = res_lens_lens[(int)(0LL)];
    size_t mag_lens_len = mag_len;
    double **theta = res[(int)({long long _mochi_idx = 1LL; _mochi_idx < 0 ? res_len + _mochi_idx : _mochi_idx;})];
    size_t theta_len = res_lens[(int)(1LL)];
    size_t *theta_lens = res_lens_lens[(int)(1LL)];
    size_t theta_lens_len = theta_len;
    print_matrix_int(mag, mag_len, mag_lens, mag_len);
    print_matrix_float(theta, theta_len, theta_lens, theta_len);
}

int main(void) {
    {
        long long __start = _now();
        user_main();
        long long __end = _now();
        long long __dur_us = (__end - __start) / 1000;
        long long __mem_bytes = _mem();
        printf("{\n  \"duration_us\": %-lld,\n  \"memory_bytes\": %-lld,\n  \"name\": \"main\"\n}\n", __dur_us, __mem_bytes);
    }
    return 0;
}
