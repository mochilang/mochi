// Generated by Mochi TypeScript compiler

let body: any;

async function main(): Promise<void> {
  body = await _fetch(
    "https://example.com",
    _toAnyMap({
      "method": "POST",
      "headers": { "Content_Type": "application/json" },
      "query": { "q": "1" },
      "body": { "x": 1 },
      "timeout": 1.5,
    }),
  );
  console.log(
    (Array.isArray(body) || typeof body === "string"
      ? (body as any).length
      : (body && typeof body === "object" ? Object.keys(body).length : 0)) > 0,
  );
}
async function _fetch(url: string, opts: any): Promise<any> {
  if (url.startsWith("file://")) {
    let path = url.slice(7);
    if (!path.startsWith("/")) {
      try {
        const t = Deno.readTextFileSync(path);
        try {
          return JSON.parse(t);
        } catch {
          return t;
        }
      } catch {
        path = Deno.cwd() + "/../.." + "/" + path;
      }
    }
    const text = Deno.readTextFileSync(path);
    try {
      return JSON.parse(text);
    } catch {
      return text;
    }
  }
  const init: RequestInit = { method: opts?.method ?? "GET" };
  if (opts?.headers) init.headers = _toAnyMap(opts.headers);
  if (opts && "body" in opts) init.body = JSON.stringify(opts.body);
  if (opts?.query) {
    const qs = new URLSearchParams();
    for (const [k, v] of Object.entries(_toAnyMap(opts.query))) {
      qs.set(k, String(v));
    }
    const sep = url.includes("?") ? "&" : "?";
    url = url + sep + qs.toString();
  }
  let ctrl: AbortController | undefined;
  let id: any;
  if (opts?.timeout) {
    ctrl = new AbortController();
    id = setTimeout(() => ctrl!.abort(), Number(opts.timeout) * 1000);
    init.signal = ctrl.signal;
  }
  const resp = await fetch(url, init);
  if (id) clearTimeout(id);
  const text = await resp.text();
  try {
    return JSON.parse(text);
  } catch {
    return text;
  }
}

function _toAnyMap(m: any): Record<string, any> {
  return m as Record<string, any>;
}

const _pending: Promise<any>[] = [];
async function _waitAll(): Promise<void> {
  await Promise.all(_pending);
}

await main();
await _waitAll();
