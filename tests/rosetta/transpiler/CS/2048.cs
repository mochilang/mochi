// Generated by Mochi 0.10.38 on 2025-07-24 06:53 +0700
using System;
using System.Linq;
using System.IO;

struct Board {
    public int[][] cells;
    public override string ToString() => $"Board {{cells = {cells}}}";
}
struct SpawnResult {
    public Board board;
    public bool full;
    public override string ToString() => $"SpawnResult {{board = {board}, full = {full}}}";
}
struct SlideResult {
    public int[] row;
    public int gain;
    public override string ToString() => $"SlideResult {{row = {row}, gain = {gain}}}";
}
struct MoveResult {
    public Board board;
    public int score;
    public bool moved;
    public override string ToString() => $"MoveResult {{board = {board}, score = {score}, moved = {moved}}}";
}
class Program {
    static bool seededNow = false;
    static int nowSeed = 0;
    static int _now() {
        if (!seededNow) {
            var s = Environment.GetEnvironmentVariable("MOCHI_NOW_SEED");
            if (int.TryParse(s, out var v)) {
                nowSeed = v;
                seededNow = true;
            }
        }
        if (seededNow) {
            nowSeed = (nowSeed*1664525 + 1013904223) % 2147483647;
            return nowSeed;
        }
        return (int)(DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() % int.MaxValue);
    }
    static string[] inputLines;
    static int inputIndex = 0;
    static string _input() {
        if (inputLines == null) {
            var path = Environment.GetEnvironmentVariable("MOCHI_INPUT_FILE");
            if (!string.IsNullOrEmpty(path) && File.Exists(path)) {
                inputLines = File.ReadAllLines(path);
            } else {
                inputLines = new string[]{};
            }
        }
        if (inputIndex < inputLines.Length) {
            return inputLines[inputIndex++];
        }
        return Console.ReadLine();
    }
    static int SIZE = 4;
    static Board board = newBoard();
    static SpawnResult r = spawnTile(board);
    static bool full = r.full;
    static int score = 0;
    static Board newBoard() {
        int[][] b = new int[][]{};
        int y = 0;
        while ((y < SIZE)) {
            int[] row = new int[]{};
            int x = 0;
            while ((x < SIZE)) {
                row = (row.Append(0).ToArray());
                x = (x + 1);
            }
            b = (b.Append(row).ToArray());
            y = (y + 1);
        };
        return new Board{cells = b};
    }

    static SpawnResult spawnTile(Board b) {
        int[][] grid = b.cells;
        int[][] empty = new int[][]{};
        int y = 0;
        while ((y < SIZE)) {
            int x = 0;
            while ((x < SIZE)) {
                if ((grid[y][x] == 0)) {
                    empty = (empty.Append(new int[]{x, y}).ToArray());
                }
                x = (x + 1);
            }
            y = (y + 1);
        };
        if ((empty.Length == 0)) {
            return new SpawnResult{board = b, full = true};
        };
        int idx = (_now() % empty.Length);
        var cell = empty[idx];
        int val = 4;
        if (((_now() % 10) < 9)) {
            val = 2;
        };
        grid[cell[1]][cell[0]] = val;
        return new SpawnResult{board = new Board{cells = grid}, full = (empty.Length == 1)};
    }

    static string pad(int n) {
        string s = n.ToString();
        int pad = (4 - s.Length);
        int i = 0;
        string _out = "";
        while ((i < pad)) {
            _out = (_out + " ");
            i = (i + 1);
        };
        return (_out + s);
    }

    static void draw(Board b, int score) {
        Console.WriteLine(("Score: " + score.ToString()));
        int y = 0;
        while ((y < SIZE)) {
            Console.WriteLine("+----+----+----+----+");
            string line = "|";
            int x = 0;
            while ((x < SIZE)) {
                int v = b.cells[y][x];
                if ((v == 0)) {
                    line = (line + "    |");
                } else {
                    line = ((line + pad(v)) + "|");
                }
                x = (x + 1);
            }
            Console.WriteLine(line);
            y = (y + 1);
        };
        Console.WriteLine("+----+----+----+----+");
        Console.WriteLine("W=Up S=Down A=Left D=Right Q=Quit");
    }

    static int[] reverseRow(int[] r) {
        int[] _out = new int[]{};
        int i = (r.Length - 1);
        while ((i >= 0)) {
            _out = (_out.Append(r[i]).ToArray());
            i = (i - 1);
        };
        return _out;
    }

    static SlideResult slideLeft(int[] row) {
        int[] xs = new int[]{};
        int i = 0;
        while ((i < row.Length)) {
            if ((row[i] != 0)) {
                xs = (xs.Append(row[i]).ToArray());
            }
            i = (i + 1);
        };
        int[] res = new int[]{};
        int gain = 0;
        i = 0;
        while ((i < xs.Length)) {
            if ((((i + 1) < xs.Length) && (xs[i] == xs[(i + 1)]))) {
                int v = (xs[i] * 2);
                gain = (gain + v);
                res = (res.Append(v).ToArray());
                i = (i + 2);
            } else {
                res = (res.Append(xs[i]).ToArray());
                i = (i + 1);
            }
        };
        while ((res.Length < SIZE)) {
            res = (res.Append(0).ToArray());
        };
        return new SlideResult{row = res, gain = gain};
    }

    static MoveResult moveLeft(Board b, int score) {
        int[][] grid = b.cells;
        bool moved = false;
        int y = 0;
        while ((y < SIZE)) {
            SlideResult r = slideLeft(grid[y]);
            var _new = r.row;
            score = (score + r.gain);
            int x = 0;
            while ((x < SIZE)) {
                if ((grid[y][x] != _new[x])) {
                    moved = true;
                }
                grid[y][x] = _new[x];
                x = (x + 1);
            }
            y = (y + 1);
        };
        return new MoveResult{board = new Board{cells = grid}, score = score, moved = moved};
    }

    static MoveResult moveRight(Board b, int score) {
        int[][] grid = b.cells;
        bool moved = false;
        int y = 0;
        while ((y < SIZE)) {
            int[] rev = reverseRow(grid[y]);
            SlideResult r = slideLeft(rev);
            rev = r.row;
            score = (score + r.gain);
            rev = reverseRow(rev);
            int x = 0;
            while ((x < SIZE)) {
                if ((grid[y][x] != rev[x])) {
                    moved = true;
                }
                grid[y][x] = rev[x];
                x = (x + 1);
            }
            y = (y + 1);
        };
        return new MoveResult{board = new Board{cells = grid}, score = score, moved = moved};
    }

    static int[] getCol(Board b, int x) {
        int[] col = new int[]{};
        int y = 0;
        while ((y < SIZE)) {
            col = (col.Append(b.cells[y][x]).ToArray());
            y = (y + 1);
        };
        return col;
    }

    static void setCol(Board b, int x, int[] col) {
        int[][] rows = b.cells;
        int y = 0;
        while ((y < SIZE)) {
            var row = rows[y];
            row[x] = col[y];
            rows[y] = row;
            y = (y + 1);
        };
        b.cells = rows;
    }

    static MoveResult moveUp(Board b, int score) {
        int[][] grid = b.cells;
        bool moved = false;
        int x = 0;
        while ((x < SIZE)) {
            int[] col = getCol(b, x);
            SlideResult r = slideLeft(col);
            var _new = r.row;
            score = (score + r.gain);
            int y = 0;
            while ((y < SIZE)) {
                if ((grid[y][x] != _new[y])) {
                    moved = true;
                }
                grid[y][x] = _new[y];
                y = (y + 1);
            }
            x = (x + 1);
        };
        return new MoveResult{board = new Board{cells = grid}, score = score, moved = moved};
    }

    static MoveResult moveDown(Board b, int score) {
        int[][] grid = b.cells;
        bool moved = false;
        int x = 0;
        while ((x < SIZE)) {
            int[] col = reverseRow(getCol(b, x));
            SlideResult r = slideLeft(col);
            col = r.row;
            score = (score + r.gain);
            col = reverseRow(col);
            int y = 0;
            while ((y < SIZE)) {
                if ((grid[y][x] != col[y])) {
                    moved = true;
                }
                grid[y][x] = col[y];
                y = (y + 1);
            }
            x = (x + 1);
        };
        return new MoveResult{board = new Board{cells = grid}, score = score, moved = moved};
    }

    static bool hasMoves(Board b) {
        int y = 0;
        while ((y < SIZE)) {
            int x = 0;
            while ((x < SIZE)) {
                if ((b.cells[y][x] == 0)) {
                    return true;
                }
                if ((((x + 1) < SIZE) && (b.cells[y][x] == b.cells[y][(x + 1)]))) {
                    return true;
                }
                if ((((y + 1) < SIZE) && (b.cells[y][x] == b.cells[(y + 1)][x]))) {
                    return true;
                }
                x = (x + 1);
            }
            y = (y + 1);
        };
        return false;
    }

    static bool has2048(Board b) {
        int y = 0;
        while ((y < SIZE)) {
            int x = 0;
            while ((x < SIZE)) {
                if ((b.cells[y][x] >= 2048)) {
                    return true;
                }
                x = (x + 1);
            }
            y = (y + 1);
        };
        return false;
    }

    static void Main() {
        board = r.board;
        r = spawnTile(board);
        board = r.board;
        full = r.full;
        draw(board, score);
        while (true) {
            Console.WriteLine("Move: ");
            string cmd = _input();
            bool moved = false;
            if (((cmd == "a") || (cmd == "A"))) {
                MoveResult m = moveLeft(board, score);
                board = m.board;
                score = m.score;
                moved = m.moved;
            }
            if (((cmd == "d") || (cmd == "D"))) {
                MoveResult m = moveRight(board, score);
                board = m.board;
                score = m.score;
                moved = m.moved;
            }
            if (((cmd == "w") || (cmd == "W"))) {
                MoveResult m = moveUp(board, score);
                board = m.board;
                score = m.score;
                moved = m.moved;
            }
            if (((cmd == "s") || (cmd == "S"))) {
                MoveResult m = moveDown(board, score);
                board = m.board;
                score = m.score;
                moved = m.moved;
            }
            if (((cmd == "q") || (cmd == "Q"))) {
                break;
            }
            if (moved) {
                SpawnResult r2 = spawnTile(board);
                board = r2.board;
                full = r2.full;
                if ((full && (!hasMoves(board)))) {
                    draw(board, score);
                    Console.WriteLine("Game Over");
                    break;
                }
            }
            draw(board, score);
            if (has2048(board)) {
                Console.WriteLine("You win!");
                break;
            }
            if ((!hasMoves(board))) {
                Console.WriteLine("Game Over");
                break;
            }
        }
    }
}
