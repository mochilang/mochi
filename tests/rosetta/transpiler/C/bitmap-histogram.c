// Generated by Mochi 0.10.32 on 2025-07-27 18:13 +0700
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <malloc.h>

size_t image_len;
size_t *image_lens;
size_t histogram_len;
size_t threshold_len;
size_t *threshold_lens;

static char* str_concat(const char *a, const char *b) {
    size_t len1 = strlen(a);
    size_t len2 = strlen(b);
    char *res = malloc(len1 + len2 + 1);
    memcpy(res, a, len1);
    memcpy(res + len1, b, len2);
    res[len1 + len2] = 0;
    return res;
}

static char* str_int(int v) {
    char buf[32];
    snprintf(buf, sizeof(buf), "%d", v);
    return strdup(buf);
}

static char* str_list_int(const int *arr, size_t len) {
    size_t cap = len * 32 + 2;
    char *buf = malloc(cap);
    size_t pos = 0;
    buf[pos++] = '[';
    for (size_t i = 0; i < len; i++) {
        char tmp[32];
        snprintf(tmp, sizeof(tmp), "%d", arr[i]);
        size_t n = strlen(tmp);
        if (pos + n + 2 >= cap) { cap = cap * 2 + n + 2; buf = realloc(buf, cap); }
        memcpy(buf + pos, tmp, n);
        pos += n;
        if (i + 1 < len) buf[pos++] = ' ';
    }
    buf[pos++] = ']';
    buf[pos] = 0;
    return buf;
}

static int* list_append_int(int *arr, size_t *len, int val) {
    arr = realloc(arr, (*len + 1) * sizeof(int));
    arr[*len] = val;
    (*len)++;
    return arr;
}

static int** list_append_intptr(int **arr, size_t *len, int *val) {
    arr = realloc(arr, (*len + 1) * sizeof(int*));
    arr[*len] = val;
    (*len)++;
    return arr;
}

static size_t* list_append_szt(size_t *arr, size_t *len, size_t val) {
    arr = realloc(arr, (*len + 1) * sizeof(size_t));
    arr[*len] = val;
    (*len)++;
    return arr;
}

#include <time.h>
#include <stdlib.h>
static int seeded_now = 0;
static long long now_seed = 0;
static long long _now(void) {
    if (!seeded_now) {
        const char *s = getenv("MOCHI_NOW_SEED");
        if (s && *s) {
            now_seed = atoll(s);
            seeded_now = 1;
        }
    }
    if (seeded_now) {
        now_seed = (now_seed * 1664525 + 1013904223) % 2147483647;
        return now_seed;
    }
    struct timespec ts;
    clock_gettime(CLOCK_REALTIME, &ts);
    return (long long)(ts.tv_sec * 1000000000LL + ts.tv_nsec);
}

static long long _mem(void) {
    struct mallinfo mi = mallinfo();
    return (long long)mi.uordblks;
}

int * * image();
int * histogram(int * * g, size_t g_len, size_t* g_lens, size_t g_lens_len, int bins);
int medianThreshold(int * h, size_t h_len);
int * * threshold(int * * g, size_t g_len, size_t* g_lens, size_t g_lens_len, int t);
int printImage(int * * g, size_t g_len, size_t* g_lens, size_t g_lens_len);
int user_main();
int main(void);

int * * image() {
    return image_lens = (size_t[]){3, 3, 3}, image_len = 3, (int*[]){ (int[]){ 0, 0, 10000 }, (int[]){ 65535, 65535, 65535 }, (int[]){ 65535, 65535, 65535 } };
}

int * histogram(int * * g, size_t g_len, size_t* g_lens, size_t g_lens_len, int bins) {
    if (bins <= 0) {
        bins = g_lens[0];
    }
    int *h = NULL;
    size_t h_len = 0;
    int i = 0;
    while (i < bins) {
        h = list_append_int(h, &h_len, 0);
        i = i + 1;
    }
    int y = 0;
    while (y < g_len) {
        int *row = g[y];
        size_t row_len = g_lens[y];
        int x = 0;
        while (x < row_len) {
            int p = row[x];
            int idx = (p * (bins - 1)) / 65535;
            h[idx] = h[idx] + 1;
            x = x + 1;
        }
        y = y + 1;
    }
    return histogram_len = h_len, h;
}

int medianThreshold(int * h, size_t h_len) {
    int lb = 0;
    int ub = h_len - 1;
    int lSum = 0;
    int uSum = 0;
    while (lb <= ub) {
        if ((lSum + h[lb]) < (uSum + h[ub])) {
            lSum = lSum + h[lb];
            lb = lb + 1;
        } else {
            uSum = uSum + h[ub];
            ub = ub - 1;
        }
    }
    return (ub * 65535) / h_len;
}

int * * threshold(int * * g, size_t g_len, size_t* g_lens, size_t g_lens_len, int t) {
    int **out = NULL;
    size_t out_len = 0;
    size_t *out_lens = NULL;
    size_t out_lens_len = 0;
    int y = 0;
    while (y < g_len) {
        int *row = g[y];
        size_t row_len = g_lens[y];
        int *newRow = NULL;
        size_t newRow_len = 0;
        int x = 0;
        while (x < row_len) {
            if (row[x] < t) {
                newRow = list_append_int(newRow, &newRow_len, 0);
            } else {
                newRow = list_append_int(newRow, &newRow_len, 65535);
            }
            x = x + 1;
        }
        out = list_append_intptr(out, &out_len, newRow);
        out_lens = list_append_szt(out_lens, &out_lens_len, newRow_len);
        y = y + 1;
    }
    return threshold_lens = out_lens, threshold_len = out_len, out;
}

int printImage(int * * g, size_t g_len, size_t* g_lens, size_t g_lens_len) {
    int y = 0;
    while (y < g_len) {
        int *row = g[y];
        size_t row_len = g_lens[y];
        const char* line = "";
        int x = 0;
        while (x < row_len) {
            if (row[x] == 0) {
                line = str_concat(line, "0");
            } else {
                line = str_concat(line, "1");
            }
            x = x + 1;
        }
        puts(line);
        y = y + 1;
    }
}

int user_main() {
    int **img = image();
    size_t img_len = image_len;
    size_t *img_lens = image_lens;
    size_t img_lens_len = image_len;
    int *h = histogram(img, img_len, img_lens, img_len, 0);
    size_t h_len = histogram_len;
    puts(str_concat("Histogram: ", str_list_int(h, h_len)));
    int t = medianThreshold(h, h_len);
    puts(str_concat("Threshold: ", str_int(t)));
    int **bw = threshold(img, img_len, img_lens, img_len, t);
    size_t bw_len = threshold_len;
    size_t *bw_lens = threshold_lens;
    size_t bw_lens_len = threshold_len;
    printImage(bw, bw_len, bw_lens, bw_len);
}

int main(void) {
    {
        long long __start = _now();
        long long __mem_start = _mem();
        user_main();
        long long __end = _now();
        long long __mem_end = _mem();
        long long __dur_us = (__end - __start) / 1000;
        long long __mem_bytes = __mem_end - __mem_start;
        printf("{\n  \"duration_us\": %-lld,\n  \"memory_bytes\": %-lld,\n  \"name\": \"main\"\n}\n", __dur_us, __mem_bytes);
    }
    return 0;
}
