// Generated by Mochi 0.10.32 on 2025-08-03 17:09 +0700
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <malloc.h>

size_t image_len;
size_t *image_lens;
size_t histogram_len;
size_t threshold_len;
size_t *threshold_lens;

static char* str_concat(const char *a, const char *b) {
    size_t len1 = strlen(a);
    size_t len2 = strlen(b);
    char *res = malloc(len1 + len2 + 1);
    memcpy(res, a, len1);
    memcpy(res + len1, b, len2);
    res[len1 + len2] = 0;
    return res;
}

static char* str_int(long long v) {
    char buf[32];
    snprintf(buf, sizeof(buf), "%lld", v);
    return strdup(buf);
}

static int** list_append_intptr(int **arr, size_t *len, int *val) {
    arr = realloc(arr, (*len + 1) * sizeof(int*));
    arr[*len] = val;
    (*len)++;
    return arr;
}

static size_t* list_append_szt(size_t *arr, size_t *len, size_t val) {
    arr = realloc(arr, (*len + 1) * sizeof(size_t));
    arr[*len] = val;
    (*len)++;
    return arr;
}

#include <time.h>
#include <stdlib.h>
static int seeded_now = 0;
static long long now_seed = 0;
static long long _now(void) {
    if (!seeded_now) {
        const char *s = getenv("MOCHI_NOW_SEED");
        if (s && *s) {
            now_seed = atoll(s);
            seeded_now = 1;
        }
    }
    if (seeded_now) {
        now_seed = (now_seed * 1664525 + 1013904223) % 2147483647;
        return now_seed;
    }
    struct timespec ts;
    clock_gettime(CLOCK_REALTIME, &ts);
    return (long long)(ts.tv_sec * 1000000000LL + ts.tv_nsec);
}

static long long _mem(void) {
    long long size = 0, rss = 0;
    FILE *f = fopen("/proc/self/statm", "r");
    if (f) {
        if (fscanf(f, "%lld %lld", &size, &rss) != 2) rss = 0;
        fclose(f);
    }
    return rss * (long long)sysconf(_SC_PAGESIZE);
}

static long long* list_append_long_long(long long *arr, size_t *len, long long val) {
    arr = realloc(arr, (*len + 1) * sizeof(long long));
    arr[*len] = val;
    (*len)++;
    return arr;
}

static long long** list_append_long_longptr(long long **arr, size_t *len, long long *val) {
    arr = realloc(arr, (*len + 1) * sizeof(long long*));
    arr[*len] = val;
    (*len)++;
    return arr;
}

long long * * image();
long long * histogram(long long * * g, size_t g_len, size_t* g_lens, size_t g_lens_len, long long bins);
long long medianThreshold(long long * h, size_t h_len);
long long * * threshold(long long * * g, size_t g_len, size_t* g_lens, size_t g_lens_len, long long t);
void printImage(long long * * g, size_t g_len, size_t* g_lens, size_t g_lens_len);
void user_main();
int main(void);

long long * * image() {
    {
        static size_t __tmp0_lens[] = {3, 3, 3};
        static long long __tmp0_row0[] = {0LL, 0LL, 10000LL};
        static long long __tmp0_row1[] = {65535LL, 65535LL, 65535LL};
        static long long __tmp0_row2[] = {65535LL, 65535LL, 65535LL};
        static long long* __tmp0_data[] = {__tmp0_row0, __tmp0_row1, __tmp0_row2};
        image_lens = __tmp0_lens;
        image_len = 3;
        return __tmp0_data;
    }
}

long long * histogram(long long * * g, size_t g_len, size_t* g_lens, size_t g_lens_len, long long bins) {
    if (bins <= 0LL) {
        bins = g_lens[0LL];
    }
    long long *h = NULL;
    size_t h_len = 0;
    int i = 0LL;
    while (i < bins) {
        h = list_append_long_long(h, &h_len, 0LL);
        i = i + 1LL;
    }
    int y = 0LL;
    while (y < g_len) {
        long long *row = g[(int)(y)];
        size_t row_len = g_lens[y];
        int x = 0LL;
        while (x < row_len) {
            long long p = row[(int)(x)];
            int idx = (p * (bins - 1LL)) / 65535LL;
            h[(int)(idx)] = h[(int)(idx)] + 1LL;
            x = x + 1LL;
        }
        y = y + 1LL;
    }
    return histogram_len = h_len, h;
}

long long medianThreshold(long long * h, size_t h_len) {
    int lb = 0LL;
    int ub = h_len - 1LL;
    int lSum = 0LL;
    int uSum = 0LL;
    while (lb <= ub) {
        if ((lSum + h[(int)(lb)]) < (uSum + h[(int)(ub)])) {
            lSum = lSum + h[(int)(lb)];
            lb = lb + 1LL;
        } else {
            uSum = uSum + h[(int)(ub)];
            ub = ub - 1LL;
        }
    }
    return (ub * 65535LL) / h_len;
}

long long * * threshold(long long * * g, size_t g_len, size_t* g_lens, size_t g_lens_len, long long t) {
    long long **out = NULL;
    size_t out_len = 0;
    size_t *out_lens = NULL;
    size_t out_lens_len = 0;
    int y = 0LL;
    while (y < g_len) {
        long long *row = g[(int)(y)];
        size_t row_len = g_lens[y];
        long long *newRow = NULL;
        size_t newRow_len = 0;
        int x = 0LL;
        while (x < row_len) {
            if (row[(int)(x)] < t) {
                newRow = list_append_long_long(newRow, &newRow_len, 0LL);
            } else {
                newRow = list_append_long_long(newRow, &newRow_len, 65535LL);
            }
            x = x + 1LL;
        }
        out = list_append_long_longptr(out, &out_len, newRow);
        out_lens = list_append_szt(out_lens, &out_lens_len, newRow_len);
        y = y + 1LL;
    }
    return threshold_lens = out_lens, threshold_len = out_len, out;
}

void printImage(long long * * g, size_t g_len, size_t* g_lens, size_t g_lens_len) {
    int y = 0LL;
    while (y < g_len) {
        long long *row = g[(int)(y)];
        size_t row_len = g_lens[y];
        const char* line = "";
        int x = 0LL;
        while (x < row_len) {
            if (row[(int)(x)] == 0LL) {
                line = str_concat(line, "0");
            } else {
                line = str_concat(line, "1");
            }
            x = x + 1LL;
        }
        puts(line);
        y = y + 1LL;
    }
}

void user_main() {
    long long **img = image();
    size_t img_len = image_len;
    size_t *img_lens = image_lens;
    size_t img_lens_len = image_len;
    long long *h = histogram(img, img_len, img_lens, img_len, 0LL);
    size_t h_len = histogram_len;
    puts(str_concat("Histogram: ", str_int(h)));
    long long t = medianThreshold(h, h_len);
    puts(str_concat("Threshold: ", str_int(t)));
    long long **bw = threshold(img, img_len, img_lens, img_len, t);
    size_t bw_len = threshold_len;
    size_t *bw_lens = threshold_lens;
    size_t bw_lens_len = threshold_len;
    printImage(bw, bw_len, bw_lens, bw_len);
}

int main(void) {
    {
        long long __start = _now();
        user_main();
        long long __end = _now();
        long long __dur_us = (__end - __start) / 1000;
        long long __mem_bytes = _mem();
        printf("{\n  \"duration_us\": %-lld,\n  \"memory_bytes\": %-lld,\n  \"name\": \"main\"\n}\n", __dur_us, __mem_bytes);
    }
    return 0;
}
