// Generated by Mochi 0.10.32 on 2025-07-23 23:20 +0700
#include <stdio.h>
#include <string.h>
#include <stdlib.h>

static char* str_concat(const char *a, const char *b) {
    size_t len1 = strlen(a);
    size_t len2 = strlen(b);
    char *res = malloc(len1 + len2 + 1);
    memcpy(res, a, len1);
    memcpy(res + len1, b, len2);
    res[len1 + len2] = 0;
    return res;
}

static char* str_int(int v) {
    char buf[32];
    snprintf(buf, sizeof(buf), "%d", v);
    return strdup(buf);
}

#include <time.h>
static int _now(void) {
    struct timespec ts;
    clock_gettime(CLOCK_REALTIME, &ts);
    return (int)(ts.tv_sec * 1000 + ts.tv_nsec / 1000000);
}

static char* _input(void) {
    char buf[1024];
    if (!fgets(buf, sizeof(buf), stdin)) return strdup("");
    size_t len = strlen(buf);
    if (len > 0 && buf[len-1] == '\n') buf[len-1] = 0;
    return strdup(buf);
}

typedef struct MoveResult MoveResult;

struct MoveResult {
    int idx;
    int ok;
};

int board[] = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 0};
size_t board_len = 16;
int solved[] = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 0};
size_t solved_len = 16;
int empty = 15;
int moves = 0;
int quit = 0;

int randMove() {
    return _now() % 4;
}

int isSolved() {
    int i = 0;
    while (i < 16) {
        if (board[i] != solved[i]) {
            return 0;
        }
        i = i + 1;
    }
    return 1;
}

MoveResult isValidMove(int m) {
    if (m == 0) {
        return (MoveResult){.idx = empty - 4, .ok = (empty / 4) > 0};
    }
    if (m == 1) {
        return (MoveResult){.idx = empty + 4, .ok = (empty / 4) < 3};
    }
    if (m == 2) {
        return (MoveResult){.idx = empty + 1, .ok = (empty % 4) < 3};
    }
    if (m == 3) {
        return (MoveResult){.idx = empty - 1, .ok = (empty % 4) > 0};
    }
    return (MoveResult){.idx = 0, .ok = 0};
}

int doMove(int m) {
    MoveResult r = isValidMove(m);
    if (!(r.ok)) {
        return 0;
    }
    int i = empty;
    int j = r.idx;
    int tmp = board[i];
    board[i] = board[j];
    board[j] = tmp;
    empty = j;
    moves = moves + 1;
    return 1;
}

int shuffle(int n) {
    int i = 0;
    while ((i < n) || isSolved()) {
        if (doMove(randMove())) {
            i = i + 1;
        }
    }
}

int printBoard() {
    const char* line = "";
    int i = 0;
    while (i < 16) {
        int val = board[i];
        if (val == 0) {
            line = str_concat(line, "  .");
        } else {
            const char* s = str_int(val);
            if (val < 10) {
                line = str_concat(str_concat(line, "  "), s);
            } else {
                line = str_concat(str_concat(line, " "), s);
            }
        }
        if ((i % 4) == 3) {
            puts(line);
            line = "";
        }
        i = i + 1;
    }
}

int playOneMove() {
    while (1) {
        puts(str_concat(str_concat("Enter move #", str_int(moves + 1)), " (U, D, L, R, or Q): "));
        const char* s = _input();
        if (strcmp(s, "") == 0) {
            continue;
        }
        const char* c = s;
        int m = 0;
        if ((strcmp(c, "U") == 0) || (strcmp(c, "u") == 0)) {
            m = 0;
        } else {
            if ((strcmp(c, "D") == 0) || (strcmp(c, "d") == 0)) {
                m = 1;
            } else {
                if ((strcmp(c, "R") == 0) || (strcmp(c, "r") == 0)) {
                    m = 2;
                } else {
                    if ((strcmp(c, "L") == 0) || (strcmp(c, "l") == 0)) {
                        m = 3;
                    } else {
                        if ((strcmp(c, "Q") == 0) || (strcmp(c, "q") == 0)) {
                            puts(str_concat(str_concat("Quiting after ", str_int(moves)), " moves."));
                            quit = 1;
                            return 0;
                        } else {
                            puts("Please enter \"U\", \"D\", \"L\", or \"R\" to move the empty cell\nup, down, left, or right. You can also enter \"Q\" to quit.\nUpper or lowercase is accepted and only the first non-blank\ncharacter is important (i.e. you may enter \"up\" if you like).");
                            continue;
                        }
                    }
                }
            }
        }
        if (!(doMove(m))) {
            puts("That is not a valid move at the moment.");
            continue;
        }
        return 0;
    }
}

int play() {
    puts("Starting board:");
    while (!(quit) && (isSolved() == 0)) {
        puts("");
        printBoard();
        playOneMove();
    }
    if (isSolved()) {
        puts(str_concat(str_concat("You solved the puzzle in ", str_int(moves)), " moves."));
    }
}

int user_main() {
    shuffle(50);
    play();
}

int main(void) {
    user_main();
    return 0;
}
