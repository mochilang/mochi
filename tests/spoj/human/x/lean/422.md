# Transposing is Even More Fun

[Problem on SPOJ](https://www.spoj.com/problems/TRANSP2/)

For a matrix of size $2^a \times 2^b$ stored row-major, transposing it in place is equivalent to permuting the array. Each swap exchanges two entries, so the minimal number of swaps is the number of elements minus the number of cycles in the permutation.

Consider a linear index written in binary using $a+b$ bits. The upper $a$ bits are the row and the lower $b$ bits are the column. Transposition swaps these groups, which is the same as rotating the bit string left by $a$ positions.

Let $L=a+b$, $g=\gcd(a,b)$ and $h=L/g$. The permutation corresponds to the cyclic group generated by this rotation. Using Burnside's lemma the number of cycles is

$$\text{cycles} = \frac1{h} \sum_{d\mid h} \varphi(d)\,2^{g\cdot (h/d)}$$

where $\varphi$ is Euler's totient function. The minimal number of swaps is then

$$2^{L} - \text{cycles} \pmod{1\,000\,003}.$$ 

The program factors $h$ (which is at most $10^6$), generates all its divisors along with their totients, evaluates the above sum using fast exponentiation, multiplies by the modular inverse of $h$, and finally outputs the result.
