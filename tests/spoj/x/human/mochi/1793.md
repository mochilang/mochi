# GEN2 - Text Generater II

[Problem link](https://www.spoj.com/problems/GEN2/)

## Algorithm

1. Build an Aho–Corasick automaton containing the three required substrings `"hl"`, `"hj"`, `"fgd"` and all given evil substrings.
2. Each automaton node stores:
   - `mask` – a bitmask of required patterns ending at this node,
   - `bad` – whether an evil pattern ends here.
   While building fail links, propagate `mask` and `bad` through the links.
3. Augment the automaton with a 3‑bit mask state tracking which required strings have appeared so far. The total number of states is `node_count * 8` (at most ~200).
4. Construct a transition matrix `M` of size `(node_count*8) × (node_count*8)` where `M[i][j]` counts letters leading from state `i` to state `j` in one step, skipping transitions to `bad` nodes. All counts are taken modulo `8000`.
5. Raise `M` to the power `L` using binary exponentiation. Multiply the start vector (only the root with mask `0` active) by `M^L` to count all length‑`L` strings.
6. Sum the counts of states whose mask is `111` (all required substrings seen) to obtain the total number of valid titles `S` modulo `8000`.
7. The answer is `(S / 8) mod 1000`, since each week uses 8 unique titles.

## Correctness Proof

We prove the algorithm yields the number of valid problem titles.

- **Automaton validity.** The Aho–Corasick automaton recognises all occurrences of the required and evil substrings in linear time. Because `mask` and `bad` are propagated along fail links, whenever a prefix matches a required or evil pattern, the current automaton node reflects it.
- **State augmentation.** Extending each automaton node with a 3‑bit mask faithfully captures whether `"hl"`, `"hj"` and `"fgd"` have occurred in the processed prefix. Transitions between augmented states update the mask and never enter `bad` nodes, so every accepted path corresponds to a valid title and vice versa.
- **Matrix exponentiation.** The transition matrix counts how many letters move between augmented states in one step. Therefore `M^L` counts the number of length‑`L` strings leading from the start state to every other state. Summing entries with mask `111` yields exactly the number of valid titles.
- **Final division.** Each week consumes eight distinct titles. Dividing the count `S` by 8 gives the number of full weeks achievable. Working modulo `8000` suffices because only `S / 8 mod 1000` is required.

Thus the algorithm outputs the correct number of complete weeks.

## Complexity Analysis

Let `m` be the number of automaton nodes (≤27) and `k = m * 8`. Building the automaton takes `O(m * 26)` time. Matrix exponentiation on a `k × k` matrix requires `O(k^3 log L)` operations, with `k ≤ 216`. Memory usage is `O(k^2)`.

## Reference Implementation

The reference Mochi implementation is available in `tests/spoj/human/x/mochi/1793.mochi` and follows the algorithm described above.

