# GEN2 - Text Generater II

[Problem link](https://www.spoj.com/problems/GEN2/)

## Algorithm

We must count the number of strings of length `L` over the lowercase alphabet
that contain the substrings `hl`, `hj` and `fgd` at least once and do not
contain any of `N` forbidden substrings.  The count is then divided by `8`
(the number of titles used per week) and reported modulo `1000`.

We build an Aho–Corasick automaton for all patterns: the three required
substrings and the `N` forbidden ones.  Each automaton node stores

* `mask` – which of the required substrings end at this node (bitset of size 3).
* `bad` – whether a forbidden pattern ends here or on any suffix link.

After constructing the failure links we know, for every state and input letter,
the next state and the updated mask while automatically rejecting transitions
that reach a `bad` node.

We now consider states of the form `(node, mask)` where `mask` remembers which
required substrings have been seen so far.  Transitions correspond to appending
one character; there are at most `8·S` states (`S` = number of automaton nodes,
< 40 in this problem).  The transitions form a matrix `M` and the number of
valid strings of length `L` is obtained by computing `M^L` and applying it to
an initial vector located at `(root,0)`.

All computations are performed modulo `8000` which is enough to determine the
final answer `(count / 8) mod 1000`.

## Correctness Proof

We prove that the algorithm above outputs the correct number of weeks.

*Construction.*  The Aho–Corasick automaton accepts exactly all strings that
avoid forbidden patterns while reporting occurrences of the required patterns.
By propagating the `mask` and `bad` flags along failure links, a node is marked
as `bad` iff some forbidden pattern ends at that position, and its `mask`
indicates which required patterns have appeared.

*State expansion.*  Extending the automaton with the `mask` component ensures
that the state `(node,mask)` uniquely represents the set of required substrings
seen so far after reading a prefix.  Every valid title corresponds to a unique
path of length `L` starting at `(root,0)` and ending at some `(node,7)` – all
three required substrings have been seen – while never visiting a `bad` node.
Conversely, every such path yields a valid title.

*Counting.*  Matrix exponentiation computes the number of length-`L` paths in
this expanded automaton.  Summing over all ending states with mask `7` yields
the total number of valid titles.  Dividing this count by `8` gives the number
of complete weeks, and working modulo `8000` preserves the result modulo `1000`.

## Complexity Analysis

Let `S` be the number of nodes in the automaton (≤ 40).  The transition matrix
has size `(8S) × (8S)` and exponentiation by `L` costs
`O((8S)^3 log L)` time, which is easily fast enough for the constraints.
Memory usage is `O((8S)^2)`.

## Reference Implementation

The reference implementation in Lean is available in
`tests/spoj/human/x/lean/1793.lean` and follows the algorithm described above.
