# SPOJ FTOUR2 - Free tour II

Given a tree with weighted edges and some "crowded" nodes, the task is to
find a path of maximum total weight that visits at most `K` crowded nodes.

## Algorithm

The solution uses tree dynamic programming.  Root the tree at an arbitrary
node.  For each node `u` we compute an array `dp[c]` – the best total weight of
a path that starts at `u`, goes only into its descendants and visits exactly
`c` crowded nodes (including `u` when it is crowded).  Non‑reachable entries are
set to `-∞`.

While processing child subtrees, two operations are performed:

1. **Combine through `u`:** for each already processed child and the next child
   we try to join one path from each side via `u`.  If the total number of
   crowded nodes does not exceed `K` we update the global answer.
2. **Extend `dp`:** we update `dp` with the best path obtained by extending from
   `u` into the current child.  Only the number of crowded nodes in that child
   plus `u` matters.

Finally, the global answer is also updated with every value in `dp` since a path
may start at `u` and end in its subtree.

The complexity of the above merging is `O(N * K^2)`, which is adequate for
small `K` used in the tests.

## Correctness

We prove by induction on the DFS tree that `dp[c]` for every node `u` equals the
maximum total weight of any path starting at `u` that stays within its subtree
and contains exactly `c` crowded nodes.

*Base case:* a leaf has no children.  Its `dp` array contains only `0` in the
position corresponding to whether the leaf is crowded or not, hence the claim
is true.

*Induction step:* assume the claim holds for all children of `u`.  During the
DFS we consider each child `v` and its table `child`.  Extending a path from `u`
into `v` uses a path starting at `v` (which by the induction hypothesis is
optimal), adds the edge weight and increases the crowded count accordingly.
Thus after processing all children the resulting `dp` contains optimal values.
When combining two sides through `u`, both partial paths are optimal by the
induction hypothesis, hence the resulting path is also optimal.  Therefore the
induction holds.

The final answer is the maximum over all paths recorded in `dp` arrays and over
all combinations through some node `u`, so it is the optimal answer.

## Complexity Analysis

Let `N` be the number of nodes and `K` the limit on crowded nodes.  For each
edge we iterate over at most `K` entries of two tables, giving a time complexity
of `O(N * K^2)` and `O(K)` additional memory per recursion level.

## Reference

- <https://www.spoj.com/problems/FTOUR2/>
