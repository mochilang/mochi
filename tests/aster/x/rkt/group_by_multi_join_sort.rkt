;; Generated by Mochi 0.10.34 on 2025-07-21 21:44 +0700
#lang racket
(require racket/list racket/string json)

(define nation (list (hash "n_nationkey" 1 "n_name" "BRAZIL")))
(define customer (list (hash "c_custkey" 1 "c_name" "Alice" "c_acctbal" 100 "c_nationkey" 1 "c_address" "123 St" "c_phone" "123-456" "c_comment" "Loyal")))
(define orders (list (hash "o_orderkey" 1000 "o_custkey" 1 "o_orderdate" "1993-10-15") (hash "o_orderkey" 2000 "o_custkey" 1 "o_orderdate" "1994-01-02")))
(define lineitem (list (hash "l_orderkey" 1000 "l_returnflag" "R" "l_extendedprice" 1000 "l_discount" 0.1) (hash "l_orderkey" 2000 "l_returnflag" "N" "l_extendedprice" 500 "l_discount" 0)))
(define start_date "1993-10-01")
(define end_date "1994-01-01")
(define result (let ([_groups (make-hash)] [_res '()])
  (for ([c customer])
    (for ([o orders])
      (for ([l lineitem])
        (for ([n nation])
          (when (and (and (and (= (hash-ref o "o_custkey") (hash-ref c "c_custkey")) (= (hash-ref l "l_orderkey") (hash-ref o "o_orderkey"))) (= (hash-ref n "n_nationkey") (hash-ref c "c_nationkey"))) (string<? (string>=? (hash-ref o "o_orderdate") (and start_date (hash-ref o "o_orderdate"))) (and end_date (= (hash-ref l "l_returnflag") "R"))))
            (let* ([_key (hash "c_custkey" (hash-ref c "c_custkey") "c_name" (hash-ref c "c_name") "c_acctbal" (hash-ref c "c_acctbal") "c_address" (hash-ref c "c_address") "c_phone" (hash-ref c "c_phone") "c_comment" (hash-ref c "c_comment") "n_name" (hash-ref n "n_name"))][_g (hash-ref _groups _key (lambda () (let ([h (make-hash)]) (hash-set! h "key" _key) (hash-set! h "items" '()) (hash-set! _groups _key h) h)))])
              (hash-set! _g "items" (append (hash-ref _g "items") (list (hash "c" c "o" o "l" l "n" n))))
          )
        )
      )
    )
  )
  (for ([g (hash-values _groups)])
    (let ([val (hash "c_custkey" (hash-ref (hash-ref g "key") "c_custkey") "c_name" (hash-ref (hash-ref g "key") "c_name") "revenue" (apply + (let ([_res '()])
  (for ([x (hash-ref g "items")])
    (set! _res (append _res (list (* (hash-ref (hash-ref x "l") "l_extendedprice") (- 1 (hash-ref (hash-ref x "l") "l_discount"))))))
  )
  _res)) "c_acctbal" (hash-ref (hash-ref g "key") "c_acctbal") "n_name" (hash-ref (hash-ref g "key") "n_name") "c_address" (hash-ref (hash-ref g "key") "c_address") "c_phone" (hash-ref (hash-ref g "key") "c_phone") "c_comment" (hash-ref (hash-ref g "key") "c_comment"))] [key (- (apply + (let ([_res '()])
  (for ([x (hash-ref g "items")])
    (set! _res (append _res (list (* (hash-ref (hash-ref x "l") "l_extendedprice") (- 1 (hash-ref (hash-ref x "l") "l_discount"))))))
  )
  _res)))])
      (set! _res (append _res (list (cons key val)))))
  )
  (set! _res (sort _res < #:key car))
  (set! _res (map cdr _res))
  _res))
(displayln result)
