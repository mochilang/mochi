#!/usr/bin/env escript
-module(main).

-export([main/1]).

% Generated by Mochi transpiler v0.10.34 (174cba038) on 2025-07-21 21:13 +0700
main(_) ->
    Nation = [#{"n_nationkey" => 1, "n_name" => "BRAZIL"}],
    Customer = [#{"c_custkey" => 1, "c_name" => "Alice", "c_acctbal" => 100, "c_nationkey" => 1, "c_address" => "123 St", "c_phone" => "123-456", "c_comment" => "Loyal"}],
    Orders = [#{"o_orderkey" => 1000, "o_custkey" => 1, "o_orderdate" => "1993-10-15"}, #{"o_orderkey" => 2000, "o_custkey" => 1, "o_orderdate" => "1994-01-02"}],
    Lineitem = [#{"l_orderkey" => 1000, "l_returnflag" => "R", "l_extendedprice" => 1000, "l_discount" => 0.1}, #{"l_orderkey" => 2000, "l_returnflag" => "N", "l_extendedprice" => 500, "l_discount" => 0}],
    Start_date = "1993-10-01",
    End_date = "1994-01-01",
    Result = lists:map(fun (T) ->     element(2, T)
 end, lists:sort(fun (A, B) ->     (element(1, A) =< element(1, B))
 end, lists:map(fun (P) ->     Key = element(1, P),
    Items = element(2, P),
    {- lists:sum([(maps:get("l_extendedprice", maps:get("l", X)) * (1 - maps:get("l_discount", maps:get("l", X)))) || X <- Items]), #{"c_custkey" => maps:get("c_custkey", Key), "c_name" => maps:get("c_name", Key), "revenue" => lists:sum([(maps:get("l_extendedprice", maps:get("l", X)) * (1 - maps:get("l_discount", maps:get("l", X)))) || X <- Items]), "c_acctbal" => maps:get("c_acctbal", Key), "n_name" => maps:get("n_name", Key), "c_address" => maps:get("c_address", Key), "c_phone" => maps:get("c_phone", Key), "c_comment" => maps:get("c_comment", Key)}}
 end, maps:to_list(lists:foldl(fun (P, Acc) ->     K = element(1, P),
    V = element(2, P),
    maps:put(K, (maps:get(K, Acc, []) ++ [V]), Acc)
 end, #{}, [{#{"c_custkey" => maps:get("c_custkey", C), "c_name" => maps:get("c_name", C), "c_acctbal" => maps:get("c_acctbal", C), "c_address" => maps:get("c_address", C), "c_phone" => maps:get("c_phone", C), "c_comment" => maps:get("c_comment", C), "n_name" => maps:get("n_name", N)}, #{"c" => C, "o" => O, "l" => L, "n" => N}} || C <- Customer, O <- Orders, L <- Lineitem, N <- Nation, ((((maps:get("o_custkey", O) == maps:get("c_custkey", C)) andalso (maps:get("l_orderkey", L) == maps:get("o_orderkey", O))) andalso (maps:get("n_nationkey", N) == maps:get("c_nationkey", C))) andalso (((maps:get("o_orderdate", O) >= Start_date) andalso (maps:get("o_orderdate", O) < End_date)) andalso (maps:get("l_returnflag", L) == "R")))]))))),
    io:format("~p~n", [Result])
.
