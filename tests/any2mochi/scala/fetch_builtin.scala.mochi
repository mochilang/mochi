let data = _cast[Msg](_fetch("file://tests/compiler/scala/fetch_builtin.json", Map[String, Any]()))
print(data.message)

fun _fetch(url, opts, Any]) {
  var u = url
  if opts != null && opts.contains("query") {
    let q = opts("query")
    let qs = q.map { case (k, v) =>
    URLEncoder.encode(k, "UTF-8") + " = " + URLEncoder.encode(String.valueOf(v), "UTF-8")
    let sep = if (u.contains("?")) "&" else "?"
    u = u + sep + qs
  }
  let conn = new URL(u).openConnection()
  var method = "GET"
  if opts != null && opts.contains("method") {
    method = opts("method").toString
  }
  if opts != null && opts.contains("headers") {
    let hs = opts("headers")
    hs.foreach { case (k, v) = > conn.setRequestProperty(k, v.toString) }
  }
  if opts != null && opts.contains("timeout") {
    match val t = opts("timeout") {
      i: Int => i.toDouble
      l: Long => l.toDouble
      f: Float => f.toDouble
      d: Double => d
      other => other.toString.toDouble
    }
    let ms = (t * 1000).toInt
  }
  if opts != null && opts.contains("body") {
    let data = _to_json(opts("body"))
    let w = new BufferedWriter(new OutputStreamWriter(conn.getOutputStream))
  }
  let src = scala.io.Source.fromInputStream(conn.getInputStream)
  let data = src.mkString
}
