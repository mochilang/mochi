-- Generated by Mochi v0.10.34 on 2025-07-21 19:35 GMT+7
nation = {{n_nationkey = 1, n_name = "BRAZIL"}}

customer = {{c_custkey = 1, c_name = "Alice", c_acctbal = 100, c_nationkey = 1, c_address = "123 St", c_phone = "123-456", c_comment = "Loyal"}}

orders = {{o_orderkey = 1000, o_custkey = 1, o_orderdate = "1993-10-15"}, {o_orderkey = 2000, o_custkey = 1, o_orderdate = "1994-01-02"}}

lineitem = {{l_orderkey = 1000, l_returnflag = "R", l_extendedprice = 1000, l_discount = 0.1}, {l_orderkey = 2000, l_returnflag = "N", l_extendedprice = 500, l_discount = 0}}

start_date = "1993-10-01"

end_date = "1994-01-01"

result = (function()
local groups = {}
local orderKeys = {}
for _, c in ipairs(customer) do
  for _, o in ipairs(orders) do
    for _, l in ipairs(lineitem) do
      for _, n in ipairs(nation) do
        if ((((o.o_custkey == c.c_custkey) and (l.l_orderkey == o.o_orderkey)) and (n.n_nationkey == c.c_nationkey)) and (((((o.o_orderdate >= start_date) and o.o_orderdate) < end_date) and l.l_returnflag) == "R")) then
          local key = {c_custkey = c.c_custkey, c_name = c.c_name, c_acctbal = c.c_acctbal, c_address = c.c_address, c_phone = c.c_phone, c_comment = c.c_comment, n_name = n.n_name}
          local ks = tostring(key)
          local g = groups[ks]
          if g == nil then
            g = {key = {c_custkey = c.c_custkey, c_name = c.c_name, c_acctbal = c.c_acctbal, c_address = c.c_address, c_phone = c.c_phone, c_comment = c.c_comment, n_name = n.n_name}, items = {}}
            groups[ks] = g
            table.insert(orderKeys, ks)
          end
          local row = {}
          row.c = c
          row.o = o
          row.l = l
          row.n = n
          table.insert(g.items, row)
        end
      end
    end
  end
end
local tmp = {}
local res = {}
for _, ks in ipairs(orderKeys) do
  local g = groups[ks]
  table.insert(tmp, {k = (0 - (function(lst)
  local s = 0
  for _, v in ipairs(lst) do
    s = s + v
  end
  return s
end)((function()
local _res = {}
for _, x in ipairs(g.items) do
  table.insert(_res, (x.l.l_extendedprice * (1 - x.l.l_discount)))
end
return _res
end)())), v = {c_custkey = g.key.c_custkey, c_name = g.key.c_name, revenue = (function(lst)
local s = 0
for _, v in ipairs(lst) do
  s = s + v
end
return s
end)((function()
local _res = {}
for _, x in ipairs(g.items) do
  table.insert(_res, (x.l.l_extendedprice * (1 - x.l.l_discount)))
end
return _res
end)()), c_acctbal = g.key.c_acctbal, n_name = g.key.n_name, c_address = g.key.c_address, c_phone = g.key.c_phone, c_comment = g.key.c_comment}})
end
table.sort(tmp, function(a,b) return a.k < b.k end)
for i,p in ipairs(tmp) do res[i] = p.v end
return res
end)()


;
(function(v)
local function is_array(t)
local i = 1
for k, _ in pairs(t) do
  if k ~= i then return false end
  i = i + 1
end
return true
end
local function encode(x, ind)
ind = ind or 0
local pad = string.rep("  ", ind)
if type(x) == "table" then
  if is_array(x) then
    local parts = {"["}
    for i, val in ipairs(x) do
      parts[#parts+1] = "\n" .. string.rep("  ", ind+1) .. encode(val, ind+1)
      if i < #x then parts[#parts+1] = "," end
    end
    if #x > 0 then parts[#parts+1] = "\n" .. pad end
    parts[#parts+1] = "]"
    return table.concat(parts)
  else
    local keys = {}
    for k in pairs(x) do table.insert(keys, k) end
    table.sort(keys, function(a,b) return tostring(a) < tostring(b) end)
    local parts = {"{"}
    for i, k in ipairs(keys) do
      parts[#parts+1] = "\n" .. string.rep("  ", ind+1) .. string.format("%q", k) .. ": " .. encode(x[k], ind+1)
      if i < #keys then parts[#parts+1] = "," end
    end
    if #keys > 0 then parts[#parts+1] = "\n" .. pad end
    parts[#parts+1] = "}"
    return table.concat(parts)
  end
elseif type(x) == "string" then
    return string.format("%q", x)
  elseif type(x) == "boolean" or type(x) == "number" then
      return tostring(x)
    elseif x == nil then
        return "null"
      else
        return "null"
      end
    end
    print(encode(v, 0))
  end)(result)
