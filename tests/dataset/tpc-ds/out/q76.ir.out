func main (regs=306)
  // let date_dim = [
  Const        r0, [{"d_date_sk": 1, "d_qoy": 1, "d_year": 1998}]
  // let item = [
  Const        r1, [{"i_category": "CatA", "i_item_sk": 1}, {"i_category": "CatB", "i_item_sk": 2}, {"i_category": "CatC", "i_item_sk": 3}]
  // let store_sales = [
  Const        r2, [{"ss_customer_sk": nil, "ss_ext_sales_price": 10, "ss_item_sk": 1, "ss_sold_date_sk": 1}]
  // let web_sales = [
  Const        r3, [{"ws_bill_customer_sk": nil, "ws_ext_sales_price": 15, "ws_item_sk": 2, "ws_sold_date_sk": 1}]
  // let catalog_sales = [
  Const        r4, [{"cs_bill_customer_sk": nil, "cs_ext_sales_price": 20, "cs_item_sk": 3, "cs_sold_date_sk": 1}]
  // from ss in store_sales
  Const        r5, []
  // where ss.ss_customer_sk == null
  Const        r6, "ss_customer_sk"
  // select { channel: "store", col_name: ss.ss_customer_sk, d_year: d.d_year, d_qoy: d.d_qoy, i_category: i.i_category, ext_sales_price: ss.ss_ext_sales_price }
  Const        r7, "channel"
  Const        r8, "col_name"
  Const        r9, "d_year"
  Const        r10, "d_qoy"
  Const        r11, "i_category"
  Const        r12, "ext_sales_price"
  Const        r13, "ss_ext_sales_price"
  // from ss in store_sales
  IterPrep     r14, r2
  Len          r15, r14
  Const        r17, 0
  Move         r16, r17
L6:
  LessInt      r18, r16, r15
  JumpIfFalse  r18, L0
  Index        r20, r14, r16
  // join i in item on i.i_item_sk == ss.ss_item_sk
  IterPrep     r21, r1
  Len          r22, r21
  Const        r23, "i_item_sk"
  Const        r24, "ss_item_sk"
  Move         r25, r17
L5:
  LessInt      r26, r25, r22
  JumpIfFalse  r26, L1
  Index        r28, r21, r25
  Index        r29, r28, r23
  Index        r30, r20, r24
  Equal        r31, r29, r30
  JumpIfFalse  r31, L2
  // join d in date_dim on d.d_date_sk == ss.ss_sold_date_sk
  IterPrep     r32, r0
  Len          r33, r32
  Const        r34, "d_date_sk"
  Const        r35, "ss_sold_date_sk"
  Move         r36, r17
L4:
  LessInt      r37, r36, r33
  JumpIfFalse  r37, L2
  Index        r39, r32, r36
  Index        r40, r39, r34
  Index        r41, r20, r35
  Equal        r42, r40, r41
  JumpIfFalse  r42, L3
  // where ss.ss_customer_sk == null
  Index        r43, r20, r6
  Const        r44, nil
  Equal        r45, r43, r44
  JumpIfFalse  r45, L3
  // select { channel: "store", col_name: ss.ss_customer_sk, d_year: d.d_year, d_qoy: d.d_qoy, i_category: i.i_category, ext_sales_price: ss.ss_ext_sales_price }
  Const        r46, "channel"
  Const        r47, "store"
  Const        r48, "col_name"
  Index        r49, r20, r6
  Const        r50, "d_year"
  Index        r51, r39, r9
  Const        r52, "d_qoy"
  Index        r53, r39, r10
  Const        r54, "i_category"
  Index        r55, r28, r11
  Const        r56, "ext_sales_price"
  Index        r57, r20, r13
  Move         r58, r46
  Move         r59, r47
  Move         r60, r48
  Move         r61, r49
  Move         r62, r50
  Move         r63, r51
  Move         r64, r52
  Move         r65, r53
  Move         r66, r54
  Move         r67, r55
  Move         r68, r56
  Move         r69, r57
  MakeMap      r70, 6, r58
  // from ss in store_sales
  Append       r5, r5, r70
L3:
  // join d in date_dim on d.d_date_sk == ss.ss_sold_date_sk
  Const        r72, 1
  Add          r36, r36, r72
  Jump         L4
L2:
  // join i in item on i.i_item_sk == ss.ss_item_sk
  Add          r25, r25, r72
  Jump         L5
L1:
  // from ss in store_sales
  AddInt       r16, r16, r72
  Jump         L6
L0:
  // from ws in web_sales
  Const        r73, []
  // where ws.ws_bill_customer_sk == null
  Const        r74, "ws_bill_customer_sk"
  // select { channel: "web", col_name: ws.ws_bill_customer_sk, d_year: d.d_year, d_qoy: d.d_qoy, i_category: i.i_category, ext_sales_price: ws.ws_ext_sales_price }
  Const        r75, "ws_ext_sales_price"
  // from ws in web_sales
  IterPrep     r76, r3
  Len          r77, r76
  Move         r78, r17
L13:
  LessInt      r79, r78, r77
  JumpIfFalse  r79, L7
  Index        r81, r76, r78
  // join i in item on i.i_item_sk == ws.ws_item_sk
  IterPrep     r82, r1
  Len          r83, r82
  Const        r84, "ws_item_sk"
  Move         r85, r17
L12:
  LessInt      r86, r85, r83
  JumpIfFalse  r86, L8
  Index        r28, r82, r85
  Index        r88, r28, r23
  Index        r89, r81, r84
  Equal        r90, r88, r89
  JumpIfFalse  r90, L9
  // join d in date_dim on d.d_date_sk == ws.ws_sold_date_sk
  IterPrep     r91, r0
  Len          r92, r91
  Const        r93, "ws_sold_date_sk"
  Move         r94, r17
L11:
  LessInt      r95, r94, r92
  JumpIfFalse  r95, L9
  Index        r39, r91, r94
  Index        r97, r39, r34
  Index        r98, r81, r93
  Equal        r99, r97, r98
  JumpIfFalse  r99, L10
  // where ws.ws_bill_customer_sk == null
  Index        r100, r81, r74
  Equal        r101, r100, r44
  JumpIfFalse  r101, L10
  // select { channel: "web", col_name: ws.ws_bill_customer_sk, d_year: d.d_year, d_qoy: d.d_qoy, i_category: i.i_category, ext_sales_price: ws.ws_ext_sales_price }
  Const        r102, "channel"
  Const        r103, "web"
  Const        r104, "col_name"
  Index        r105, r81, r74
  Const        r106, "d_year"
  Index        r107, r39, r9
  Const        r108, "d_qoy"
  Index        r109, r39, r10
  Const        r110, "i_category"
  Index        r111, r28, r11
  Const        r112, "ext_sales_price"
  Index        r113, r81, r75
  Move         r114, r102
  Move         r115, r103
  Move         r116, r104
  Move         r117, r105
  Move         r118, r106
  Move         r119, r107
  Move         r120, r108
  Move         r121, r109
  Move         r122, r110
  Move         r123, r111
  Move         r124, r112
  Move         r125, r113
  MakeMap      r126, 6, r114
  // from ws in web_sales
  Append       r73, r73, r126
L10:
  // join d in date_dim on d.d_date_sk == ws.ws_sold_date_sk
  Add          r94, r94, r72
  Jump         L11
L9:
  // join i in item on i.i_item_sk == ws.ws_item_sk
  Add          r85, r85, r72
  Jump         L12
L8:
  // from ws in web_sales
  AddInt       r78, r78, r72
  Jump         L13
L7:
  // from cs in catalog_sales
  Const        r128, []
  // where cs.cs_bill_customer_sk == null
  Const        r129, "cs_bill_customer_sk"
  // select { channel: "catalog", col_name: cs.cs_bill_customer_sk, d_year: d.d_year, d_qoy: d.d_qoy, i_category: i.i_category, ext_sales_price: cs.cs_ext_sales_price }
  Const        r130, "cs_ext_sales_price"
  // from cs in catalog_sales
  IterPrep     r131, r4
  Len          r132, r131
  Move         r133, r17
L20:
  LessInt      r134, r133, r132
  JumpIfFalse  r134, L14
  Index        r136, r131, r133
  // join i in item on i.i_item_sk == cs.cs_item_sk
  IterPrep     r137, r1
  Len          r138, r137
  Const        r139, "cs_item_sk"
  Move         r140, r17
L19:
  LessInt      r141, r140, r138
  JumpIfFalse  r141, L15
  Index        r28, r137, r140
  Index        r143, r28, r23
  Index        r144, r136, r139
  Equal        r145, r143, r144
  JumpIfFalse  r145, L16
  // join d in date_dim on d.d_date_sk == cs.cs_sold_date_sk
  IterPrep     r146, r0
  Len          r147, r146
  Const        r148, "cs_sold_date_sk"
  Move         r149, r17
L18:
  LessInt      r150, r149, r147
  JumpIfFalse  r150, L16
  Index        r39, r146, r149
  Index        r152, r39, r34
  Index        r153, r136, r148
  Equal        r154, r152, r153
  JumpIfFalse  r154, L17
  // where cs.cs_bill_customer_sk == null
  Index        r155, r136, r129
  Equal        r156, r155, r44
  JumpIfFalse  r156, L17
  // select { channel: "catalog", col_name: cs.cs_bill_customer_sk, d_year: d.d_year, d_qoy: d.d_qoy, i_category: i.i_category, ext_sales_price: cs.cs_ext_sales_price }
  Const        r157, "channel"
  Const        r158, "catalog"
  Const        r159, "col_name"
  Index        r160, r136, r129
  Const        r161, "d_year"
  Index        r162, r39, r9
  Const        r163, "d_qoy"
  Index        r164, r39, r10
  Const        r165, "i_category"
  Index        r166, r28, r11
  Const        r167, "ext_sales_price"
  Index        r168, r136, r130
  Move         r169, r157
  Move         r170, r158
  Move         r171, r159
  Move         r172, r160
  Move         r173, r161
  Move         r174, r162
  Move         r175, r163
  Move         r176, r164
  Move         r177, r165
  Move         r178, r166
  Move         r179, r167
  Move         r180, r168
  MakeMap      r181, 6, r169
  // from cs in catalog_sales
  Append       r128, r128, r181
L17:
  // join d in date_dim on d.d_date_sk == cs.cs_sold_date_sk
  Add          r149, r149, r72
  Jump         L18
L16:
  // join i in item on i.i_item_sk == cs.cs_item_sk
  Add          r140, r140, r72
  Jump         L19
L15:
  // from cs in catalog_sales
  AddInt       r133, r133, r72
  Jump         L20
L14:
  // let all_rows = concat(store_part, web_part, catalog_part)
  UnionAll     r183, r5, r73
  UnionAll     r184, r183, r128
  // from r in all_rows
  Const        r185, []
  // channel: g.key.channel,
  Const        r186, "key"
  // sales_cnt: count(g),
  Const        r187, "sales_cnt"
  // sales_amt: sum(from x in g select x.r.ext_sales_price)
  Const        r188, "sales_amt"
  Const        r189, "r"
  // from r in all_rows
  IterPrep     r190, r184
  Len          r191, r190
  Const        r192, 0
  MakeMap      r193, 0, r0
  Const        r194, []
L23:
  LessInt      r196, r192, r191
  JumpIfFalse  r196, L21
  Index        r197, r190, r192
  Move         r198, r197
  // group by { channel: r.channel, col_name: r.col_name, d_year: r.d_year, d_qoy: r.d_qoy, i_category: r.i_category } into g
  Const        r199, "channel"
  Index        r200, r198, r7
  Const        r201, "col_name"
  Index        r202, r198, r8
  Const        r203, "d_year"
  Index        r204, r198, r9
  Const        r205, "d_qoy"
  Index        r206, r198, r10
  Const        r207, "i_category"
  Index        r208, r198, r11
  Move         r209, r199
  Move         r210, r200
  Move         r211, r201
  Move         r212, r202
  Move         r213, r203
  Move         r214, r204
  Move         r215, r205
  Move         r216, r206
  Move         r217, r207
  Move         r218, r208
  MakeMap      r219, 5, r209
  Str          r220, r219
  In           r221, r220, r193
  JumpIfTrue   r221, L22
  // from r in all_rows
  Const        r222, []
  Const        r223, "__group__"
  Const        r224, true
  Const        r225, "key"
  // group by { channel: r.channel, col_name: r.col_name, d_year: r.d_year, d_qoy: r.d_qoy, i_category: r.i_category } into g
  Move         r226, r219
  // from r in all_rows
  Const        r227, "items"
  Move         r228, r222
  Const        r229, "count"
  Const        r230, 0
  Move         r231, r223
  Move         r232, r224
  Move         r233, r225
  Move         r234, r226
  Move         r235, r227
  Move         r236, r228
  Move         r237, r229
  Move         r238, r230
  MakeMap      r239, 4, r231
  SetIndex     r193, r220, r239
  Append       r194, r194, r239
L22:
  Const        r241, "items"
  Index        r242, r193, r220
  Index        r243, r242, r241
  Append       r244, r243, r197
  SetIndex     r242, r241, r244
  Const        r245, "count"
  Index        r246, r242, r245
  AddInt       r247, r246, r72
  SetIndex     r242, r245, r247
  AddInt       r192, r192, r72
  Jump         L23
L21:
  Move         r248, r17
  Len          r249, r194
L27:
  LessInt      r250, r248, r249
  JumpIfFalse  r250, L24
  Index        r252, r194, r248
  // channel: g.key.channel,
  Const        r253, "channel"
  Index        r254, r252, r186
  Index        r255, r254, r7
  // col_name: g.key.col_name,
  Const        r256, "col_name"
  Index        r257, r252, r186
  Index        r258, r257, r8
  // d_year: g.key.d_year,
  Const        r259, "d_year"
  Index        r260, r252, r186
  Index        r261, r260, r9
  // d_qoy: g.key.d_qoy,
  Const        r262, "d_qoy"
  Index        r263, r252, r186
  Index        r264, r263, r10
  // i_category: g.key.i_category,
  Const        r265, "i_category"
  Index        r266, r252, r186
  Index        r267, r266, r11
  // sales_cnt: count(g),
  Const        r268, "sales_cnt"
  Index        r269, r252, r245
  // sales_amt: sum(from x in g select x.r.ext_sales_price)
  Const        r270, "sales_amt"
  Const        r271, []
  IterPrep     r272, r252
  Len          r273, r272
  Move         r274, r17
L26:
  LessInt      r275, r274, r273
  JumpIfFalse  r275, L25
  Index        r277, r272, r274
  Index        r278, r277, r189
  Index        r279, r278, r12
  Append       r271, r271, r279
  AddInt       r274, r274, r72
  Jump         L26
L25:
  Sum          r281, r271
  // channel: g.key.channel,
  Move         r282, r253
  Move         r283, r255
  // col_name: g.key.col_name,
  Move         r284, r256
  Move         r285, r258
  // d_year: g.key.d_year,
  Move         r286, r259
  Move         r287, r261
  // d_qoy: g.key.d_qoy,
  Move         r288, r262
  Move         r289, r264
  // i_category: g.key.i_category,
  Move         r290, r265
  Move         r291, r267
  // sales_cnt: count(g),
  Move         r292, r268
  Move         r293, r269
  // sales_amt: sum(from x in g select x.r.ext_sales_price)
  Move         r294, r270
  Move         r295, r281
  // select {
  MakeMap      r296, 7, r282
  // sort by g.key.channel
  Index        r297, r252, r186
  Index        r299, r297, r7
  // from r in all_rows
  Move         r300, r296
  MakeList     r301, 2, r299
  Append       r185, r185, r301
  AddInt       r248, r248, r72
  Jump         L27
L24:
  // sort by g.key.channel
  Sort         r185, r185
  // json(result)
  JSON         r185
  // expect result == [
  Const        r304, [{"channel": "store", "col_name": nil, "d_qoy": 1, "d_year": 1998, "i_category": "CatA", "sales_amt": 10, "sales_cnt": 1}, {"channel": "web", "col_name": nil, "d_qoy": 1, "d_year": 1998, "i_category": "CatB", "sales_amt": 15, "sales_cnt": 1}, {"channel": "catalog", "col_name": nil, "d_qoy": 1, "d_year": 1998, "i_category": "CatC", "sales_amt": 20, "sales_cnt": 1}]
  Equal        r305, r185, r304
  Expect       r305
  Return       r0
