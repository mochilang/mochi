// Shipping time buckets for catalog sales
type CatalogSale { cs_ship_date_sk: int, cs_sold_date_sk: int, cs_warehouse_sk: int, cs_ship_mode_sk: int, cs_call_center_sk: int }
type Warehouse { w_warehouse_sk: int, w_warehouse_name: string }
type ShipMode { sm_ship_mode_sk: int, sm_type: string }
type CallCenter { cc_call_center_sk: int, cc_name: string }

let catalog_sales = [
  {cs_ship_date_sk: 31, cs_sold_date_sk: 1, cs_warehouse_sk: 1, cs_ship_mode_sk: 1, cs_call_center_sk: 1},
  {cs_ship_date_sk: 51, cs_sold_date_sk: 1, cs_warehouse_sk: 1, cs_ship_mode_sk: 1, cs_call_center_sk: 1},
  {cs_ship_date_sk: 71, cs_sold_date_sk: 1, cs_warehouse_sk: 1, cs_ship_mode_sk: 1, cs_call_center_sk: 1},
  {cs_ship_date_sk: 101, cs_sold_date_sk: 1, cs_warehouse_sk: 1, cs_ship_mode_sk: 1, cs_call_center_sk: 1},
  {cs_ship_date_sk: 131, cs_sold_date_sk: 1, cs_warehouse_sk: 1, cs_ship_mode_sk: 1, cs_call_center_sk: 1}
]

let warehouse = [{w_warehouse_sk: 1, w_warehouse_name: "Warehouse1"}]
let ship_mode = [{sm_ship_mode_sk: 1, sm_type: "EXP"}]
let call_center = [{cc_call_center_sk: 1, cc_name: "CC1"}]

let d30 = count(from cs in catalog_sales where cs.cs_ship_date_sk - cs.cs_sold_date_sk <= 30 select cs)
let d60 = count(from cs in catalog_sales where cs.cs_ship_date_sk - cs.cs_sold_date_sk > 30 && cs.cs_ship_date_sk - cs.cs_sold_date_sk <= 60 select cs)
let d90 = count(from cs in catalog_sales where cs.cs_ship_date_sk - cs.cs_sold_date_sk > 60 && cs.cs_ship_date_sk - cs.cs_sold_date_sk <= 90 select cs)
let d120 = count(from cs in catalog_sales where cs.cs_ship_date_sk - cs.cs_sold_date_sk > 90 && cs.cs_ship_date_sk - cs.cs_sold_date_sk <= 120 select cs)
let dmore = count(from cs in catalog_sales where cs.cs_ship_date_sk - cs.cs_sold_date_sk > 120 select cs)
let wname = "Warehouse1"
let smtype = "EXP"
let ccname = "CC1"
let grouped = [{
  warehouse: substr(str(wname),0,20),
  sm_type: smtype,
  cc_name: ccname,
  d30: d30,
  d60: d60,
  d90: d90,
  d120: d120,
  dmore: dmore
}]

json(grouped)

test "TPCDS Q99 buckets" {
  expect grouped == [{warehouse: "Warehouse1", sm_type: "EXP", cc_name: "CC1", d30: 1, d60: 1, d90: 1, d120: 1, dmore: 1}]
}
