let catalog_sales = [
  {cs_item_sk: 1, cs_sold_date_sk: 1, cs_ext_discount_amt: 10.0},
  {cs_item_sk: 1, cs_sold_date_sk: 2, cs_ext_discount_amt: 20.0},
  {cs_item_sk: 2, cs_sold_date_sk: 1, cs_ext_discount_amt: 5.0},
]

let item = [
  {i_item_sk: 1, i_manufact_id: 1},
  {i_item_sk: 2, i_manufact_id: 2},
]

let date_dim = [
  {d_date_sk: 1, d_date: "2000-01-10"},
  {d_date_sk: 2, d_date: "2000-02-15"},
  {d_date_sk: 3, d_date: "2000-05-01"},
]

let start_date = "2000-01-01"
let end_date = "2000-07-01"

let sales =
  from cs in catalog_sales
  join i in item on cs.cs_item_sk == i.i_item_sk
  join d in date_dim on cs.cs_sold_date_sk == d.d_date_sk
  where i.i_manufact_id == 1 && d.d_date >= start_date && d.d_date <= end_date
  select {item_sk: i.i_item_sk, disc: cs.cs_ext_discount_amt}

let avg_by_item =
  from s in sales
  group by s.item_sk into g
  select {item_sk: g.key, avg_disc: avg(from x in g select x.disc)}

let result =
  sum(from s in sales
      join a in avg_by_item on s.item_sk == a.item_sk
      where s.disc > a.avg_disc * 1.3
      select s.disc)

json(result)

test "TPCDS Q32 simplified" {
  expect result == 20.0
}
