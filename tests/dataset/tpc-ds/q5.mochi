let store_sales = []
let store_returns = []
let store = []
let catalog_sales = []
let catalog_returns = []
let catalog_page = []
let web_sales = []
let web_returns = []
let web_site = []
let date_dim = []

let ss =
  from ss in store_sales
  join d in date_dim on ss.ss_sold_date_sk == d.d_date_sk
  join s in store on ss.ss_store_sk == s.s_store_sk
  where d.d_date >= "1998-12-01" && d.d_date <= "1998-12-15"
  group by s.s_store_id into g
  select {
    channel: "store channel",
    id: "store" + str(g.key),
    sales: sum(from x in g select x.ss.ss_ext_sales_price),
    returns: 0.0,
    profit: sum(from x in g select x.ss.ss_net_profit),
    profit_loss: 0.0
  }

let sr =
  from sr in store_returns
  join d in date_dim on sr.sr_returned_date_sk == d.d_date_sk
  join s in store on sr.sr_store_sk == s.s_store_sk
  where d.d_date >= "1998-12-01" && d.d_date <= "1998-12-15"
  group by s.s_store_id into g
  select {
    channel: "store channel",
    id: "store" + str(g.key),
    sales: 0.0,
    returns: sum(from x in g select x.sr.sr_return_amt),
    profit: 0.0,
    profit_loss: sum(from x in g select x.sr.sr_net_loss)
  }

let cs =
  from cs in catalog_sales
  join d in date_dim on cs.cs_sold_date_sk == d.d_date_sk
  join cp in catalog_page on cs.cs_catalog_page_sk == cp.cp_catalog_page_sk
  where d.d_date >= "1998-12-01" && d.d_date <= "1998-12-15"
  group by cp.cp_catalog_page_id into g
  select {
    channel: "catalog channel",
    id: "catalog_page" + str(g.key),
    sales: sum(from x in g select x.cs.cs_ext_sales_price),
    returns: 0.0,
    profit: sum(from x in g select x.cs.cs_net_profit),
    profit_loss: 0.0
  }

let cr =
  from cr in catalog_returns
  join d in date_dim on cr.cr_returned_date_sk == d.d_date_sk
  join cp in catalog_page on cr.cr_catalog_page_sk == cp.cp_catalog_page_sk
  where d.d_date >= "1998-12-01" && d.d_date <= "1998-12-15"
  group by cp.cp_catalog_page_id into g
  select {
    channel: "catalog channel",
    id: "catalog_page" + str(g.key),
    sales: 0.0,
    returns: sum(from x in g select x.cr.cr_return_amount),
    profit: 0.0,
    profit_loss: sum(from x in g select x.cr.cr_net_loss)
  }

let ws =
  from ws in web_sales
  join d in date_dim on ws.ws_sold_date_sk == d.d_date_sk
  join w in web_site on ws.ws_web_site_sk == w.web_site_sk
  where d.d_date >= "1998-12-01" && d.d_date <= "1998-12-15"
  group by w.web_site_id into g
  select {
    channel: "web channel",
    id: "web_site" + str(g.key),
    sales: sum(from x in g select x.ws.ws_ext_sales_price),
    returns: 0.0,
    profit: sum(from x in g select x.ws.ws_net_profit),
    profit_loss: 0.0
  }

let wr =
  from wr in web_returns
  join ws in web_sales on wr.wr_item_sk == ws.ws_item_sk && wr.wr_order_number == ws.ws_order_number
  join d in date_dim on wr.wr_returned_date_sk == d.d_date_sk
  join w in web_site on ws.ws_web_site_sk == w.web_site_sk
  where d.d_date >= "1998-12-01" && d.d_date <= "1998-12-15"
  group by w.web_site_id into g
  select {
    channel: "web channel",
    id: "web_site" + str(g.key),
    sales: 0.0,
    returns: sum(from x in g select x.wr.wr_return_amt),
    profit: 0.0,
    profit_loss: sum(from x in g select x.wr.wr_net_loss)
  }

let per_channel = concat(ss union all sr, cs union all cr, ws union all wr)

let result =
  from p in per_channel
  group by { channel: p.channel, id: p.id } into g
  sort by g.key.channel
  select {
    channel: g.key.channel,
    id: g.key.id,
    sales: sum(from x in g select x.p.sales),
    returns: sum(from x in g select x.p.returns),
    profit: sum(from x in g select x.p.profit) - sum(from x in g select x.p.profit_loss)
  }

json(result)

test "TPCDS Q5 empty" {
  expect len(result) == 0
}
