open System
open System.Text.Json

type Anon1 = {
    cs_item_sk: int
    cs_sold_date_sk: int
    cs_ext_discount_amt: float
}
type Anon2 = {
    i_item_sk: int
    i_manufact_id: int
}
type Anon3 = {
    d_date_sk: int
    d_year: int
}
let catalog_sales: Anon1 list = [{ cs_item_sk = 1; cs_sold_date_sk = 1; cs_ext_discount_amt = 5.0 }; { cs_item_sk = 1; cs_sold_date_sk = 2; cs_ext_discount_amt = 10.0 }; { cs_item_sk = 1; cs_sold_date_sk = 3; cs_ext_discount_amt = 20.0 }]
let item: Anon2 list = [{ i_item_sk = 1; i_manufact_id = 1 }]
let date_dim: Anon3 list = [{ d_date_sk = 1; d_year = 2000 }; { d_date_sk = 2; d_year = 2000 }; { d_date_sk = 3; d_year = 2000 }]
let filtered: float list = [ for cs in catalog_sales do 
  for i in item do 
  for d in date_dim do if cs.cs_item_sk = i.i_item_sk && cs.cs_sold_date_sk = d.d_date_sk && i.i_manufact_id = 1 && d.d_year = 2000 then yield cs.cs_ext_discount_amt ]
let avg_discount: obj = (float (List.sum filtered) / float (List.length filtered))
let result: obj = List.sum [ for x in filtered do if x > avg_discount * 1.3 then yield x ]
printfn "%A" (JsonSerializer.Serialize(result))
assert (result = 20.0)
