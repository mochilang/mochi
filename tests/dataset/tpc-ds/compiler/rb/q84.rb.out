# Generated by Mochi compiler v0.10.25 on 2025-07-15T04:48:36Z
require 'ostruct'

def _json(v)
  require 'json'
  obj = v
  if v.is_a?(Array)
    obj = v.map { |it| it.respond_to?(:to_h) ? it.to_h : it }
  elsif v.respond_to?(:to_h)
    obj = v.to_h
  end
  puts(JSON.generate(obj))
end
def _sum(v)
  list = nil
  if defined?(MGroup) && v.is_a?(MGroup)
    list = v.Items
  elsif v.is_a?(Array)
    list = v
  elsif v.respond_to?(:to_a)
    list = v.to_a
  end
  return 0 if !list || list.empty?
  s = 0.0
  list.each { |n| s += n.to_f }
  s
end

$customer = [OpenStruct.new(id: 1, current_addr: 1, cdemo: 1, hdemo: 1), OpenStruct.new(id: 2, current_addr: 1, cdemo: 2, hdemo: 2), OpenStruct.new(id: 3, current_addr: 1, cdemo: 3, hdemo: 1), OpenStruct.new(id: 4, current_addr: 1, cdemo: 4, hdemo: 2)]
$customer_address = [OpenStruct.new(ca_address_sk: 1, ca_city: "Springfield")]
$customer_demographics = [OpenStruct.new(cd_demo_sk: 1), OpenStruct.new(cd_demo_sk: 2), OpenStruct.new(cd_demo_sk: 3), OpenStruct.new(cd_demo_sk: 4)]
$household_demographics = [OpenStruct.new(hd_demo_sk: 1, income_band_sk: 1), OpenStruct.new(hd_demo_sk: 2, income_band_sk: 1)]
$income_band = [OpenStruct.new(ib_income_band_sk: 1, ib_lower_bound: 0, ib_upper_bound: 50000)]
$store_returns = [OpenStruct.new(sr_cdemo_sk: 1, amt: 10.0), OpenStruct.new(sr_cdemo_sk: 2, amt: 20.0), OpenStruct.new(sr_cdemo_sk: 3, amt: 30.0), OpenStruct.new(sr_cdemo_sk: 4, amt: 24.0)]
$result = _sum((begin
	_res = []
	for c in $customer
		for ca in $customer_address
			if ((c.current_addr == ca.ca_address_sk) && (ca.ca_city == "Springfield"))
				for cd in $customer_demographics
					if (c.cdemo == cd.cd_demo_sk)
						for sr in $store_returns
							if (cd.cd_demo_sk == sr.sr_cdemo_sk)
								for hd in $household_demographics
									if (c.hdemo == hd.hd_demo_sk)
										for ib in $income_band
											if (hd.income_band_sk == ib.ib_income_band_sk)
												_res << sr.amt
											end
										end
									end
								end
							end
						end
					end
				end
			end
		end
	end
	_res
end))
_json($result)
raise "expect failed" unless ($result == 84.0)
