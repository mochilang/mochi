! Generated by Mochi compiler v0.10.26 on 2025-07-15T07:32:24Z
program q1
  implicit none
  character(len=512) :: out
  out = tpcds_q1()
  print '(A)', trim(out)
  contains
  character(len=512) function tpcds_q1() result(res)
    implicit none
    type :: Store_return
      integer :: returned_date_sk
      integer :: customer_sk
      integer :: store_sk
      real(8) :: return_amt
    end type Store_return
    type :: Date_dim
      integer :: date_sk
      integer :: year
    end type Date_dim
    type :: Store
      integer :: store_sk
      character(len=2) :: state
    end type Store
    type :: Customer
      integer :: customer_sk
      character(len=2) :: customer_id
    end type Customer
    type :: CtrRec
      integer :: customer_sk
      integer :: store_sk
      real(8) :: total_return
    end type CtrRec
    type(Store_return) :: sr(2)
    type(Date_dim) :: dd(1)
    type(Store) :: st(1)
    type(Customer) :: cust(2)
    type(CtrRec) :: ctr(2)
    integer :: i,j,k,found,ctr_n
    integer :: cnt
    real(8) :: sum_ret,avg_ret
    integer :: res_n
    character(len=32) :: tmpid
    sr(1) = Store_return(1,1,10,20.0d0)
    sr(2) = Store_return(1,2,10,50.0d0)
    dd(1) = Date_dim(1,1998)
    st(1) = Store(10,'TN')
    cust(1) = Customer(1,'C1')
    cust(2) = Customer(2,'C2')
    ctr_n = 0
    do i = 1, 2
      if (sr(i)%returned_date_sk == dd(1)%date_sk .and. dd(1)%year == 1998) then
        found = 0
        do j = 1, ctr_n
          if (ctr(j)%customer_sk == sr(i)%customer_sk .and. ctr(j)%store_sk == sr(i)%store_sk) then
            found = j
            exit
          end if
        end do
        if (found == 0) then
          ctr_n = ctr_n + 1
          ctr(ctr_n)%customer_sk = sr(i)%customer_sk
          ctr(ctr_n)%store_sk = sr(i)%store_sk
          ctr(ctr_n)%total_return = 0d0
          found = ctr_n
        end if
        ctr(found)%total_return = ctr(found)%total_return + sr(i)%return_amt
      end if
    end do
    res = '['
    res_n = 0
    do i = 1, ctr_n
      if (ctr(i)%store_sk == st(1)%store_sk) then
        do j = 1, 2
          if (ctr(i)%customer_sk == cust(j)%customer_sk) then
            sum_ret = 0d0
            cnt = 0
            do k = 1, ctr_n
              if (ctr(k)%store_sk == ctr(i)%store_sk) then
                sum_ret = sum_ret + ctr(k)%total_return
                cnt = cnt + 1
              end if
            end do
            avg_ret = sum_ret / cnt
            if (ctr(i)%total_return > avg_ret*1.2 .and. st(1)%state == 'TN') then
              if (res_n > 0) res = trim(res)//','
              tmpid = cust(j)%customer_id
              res = trim(res)//'{"c_customer_id":"'//trim(tmpid)//'"}'
              res_n = res_n + 1
            end if
          end if
        end do
      end if
    end do
    res = trim(res)//']'
    return
  end function tpcds_q1
end program q1
