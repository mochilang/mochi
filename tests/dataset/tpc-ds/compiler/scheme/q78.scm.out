; Generated by Mochi compiler v0.10.26 on 2025-07-15T07:38:01Z
(define (map-get m k)
    (let ((p (assoc k m)))
        (if p (cdr p) '()))
)
(define (map-set m k v)
    (let ((p (assoc k m)))
        (if p
            (begin (set-cdr! p v) m)
            (cons (cons k v) m)))
)
(import (srfi 1) (srfi 95) (chibi json) (chibi io) (chibi process) (chibi) (chibi string))

(define (_fmt . parts)
  (apply string-append (map _to_string parts)))

(define (_to_string v)
  (call-with-output-string (lambda (p) (write v p))))

(define (_yaml_value v)
  (let ((n (string->number v)))
    (if n n v)))

(define (_parse_yaml text)
  (let ((rows '()) (cur '()))
    (for-each (lambda (ln)
                (when (and (>= (string-length ln) 2) (string-prefix? "- " ln))
                  (when (not (null? cur))
                    (set! rows (append rows (list cur))))
                  (set! cur '())
                  (set! ln (substring ln 2 (string-length ln))))
                (when (string-contains ln ":")
                  (let* ((p (string-split ln #\:))
                         (k (string-trim (car p)))
                         (val (string-trim (string-join (cdr p) ":"))))
                    (set! cur (append cur (list (cons k (_yaml_value val))))))))
              (string-split text #\newline))
    (when (not (null? cur))
      (set! rows (append rows (list cur))))
    rows))

(define (_fetch url opts)
  (let* ((method (if (and opts (assq 'method opts)) (cdr (assq 'method opts)) "GET"))
         (args (list "curl" "-s" "-X" method)))
    (when (and opts (assq 'headers opts))
      (for-each (lambda (p)
                  (set! args (append args (list "-H" (_fmt (car p) ": " (cdr p))))))
                (cdr (assq 'headers opts))))
    (when (and opts (assq 'query opts))
      (let* ((q (cdr (assq 'query opts)))
             (qs (string-join (map (lambda (p) (_fmt (car p) "=" (cdr p))) q) "&")))
        (set! url (string-append url (if (string-contains url "?") "&" "?") qs))))
    (when (and opts (assq 'body opts))
      (set! args (append args (list "-d" (json->string (cdr (assq 'body opts)))))))
    (when (and opts (assq 'timeout opts))
      (set! args (append args (list "--max-time" (_to_string (cdr (assq 'timeout opts)))))))
    (set! args (append args (list url)))
    (let* ((p (open-input-pipe (string-join args " ")))
           (txt (port->string p)))
      (close-input-port p)
      (string->json txt))))

(define (_load path opts)
  (let* ((fmt (if (and opts (assq 'format opts)) (cdr (assq 'format opts)) "json"))
         (in (if (or (not path) (string=? path "") (string=? path "-"))
                 (current-input-port)
                 (open-input-file path)))
         (text (port->string in)))
    (when (not (eq? in (current-input-port)))
      (close-input-port in))
    (cond ((string=? fmt "jsonl")
           (map string->json
                (filter (lambda (l) (not (string=? l "")))
                        (string-split text #\newline))))
          ((string=? fmt "yaml")
           (_parse_yaml text))
          (else
           (let ((d (string->json text)))
             (if (list? d) d (list d)))))))

(define (_save rows path opts)
  (let* ((fmt (if (and opts (assq 'format opts)) (cdr (assq 'format opts)) "json"))
         (out (if (or (not path) (string=? path "") (string=? path "-"))
                  (current-output-port)
                  (open-output-file path))))
  (cond ((string=? fmt "jsonl")
           (for-each (lambda (r) (write-string (json->string r) out) (newline out)) rows))
          (else
           (write-string (json->string rows) out)))
    (when (not (eq? out (current-output-port)))
      (close-output-port out))))

(define (_date_number s)
  (let ((parts (string-split s #\-)))
    (if (= (length parts) 3)
        (+ (* (string->number (list-ref parts 0)) 10000)
           (* (string->number (list-ref parts 1)) 100)
           (string->number (list-ref parts 2)))
        #f)))

(define (_lt a b)
  (cond
    ((and (number? a) (number? b)) (< a b))
    ((and (string? a) (string? b))
      (let ((da (_date_number a))
            (db (_date_number b)))
        (if (and da db)
            (< da db)
            (string<? a b))))
    ((and (pair? a) (pair? b))
      (cond
        ((null? a) (not (null? b)))
        ((null? b) #f)
        (else (let ((ka (car a)) (kb (car b)))
                (if (equal? ka kb)
                    (_lt (cdr a) (cdr b))
                    (_lt ka kb)))))
    )
    (else (string<? (_to_string a) (_to_string b)))))

(define (_le a b)
  (or (_lt a b) (equal? a b)))

(define (_gt a b)
  (_lt b a))

(define (_ge a b)
  (or (_gt a b) (equal? a b)))

(define (_sort pairs)
  (letrec ((cmp (lambda (a b) (_lt (cdr a) (cdr b))))
           (insert (lambda (x lst)
                     (cond ((null? lst) (list x))
                           ((cmp x (car lst)) (cons x lst))
                           (else (cons (car lst) (insert x (cdr lst)))))))
           (loop (lambda (xs out)
                   (if (null? xs)
                       out
                       (loop (cdr xs) (insert (car xs) out))))) )
    (loop pairs '())))
(import (chibi json))

(define (_json v)
  (cond
    ;; list of objects
    ((and (list? v) (pair? v) (pair? (car v)) (pair? (caar v)))
     (display "[")
     (let loop ((xs v) (first #t))
       (unless (null? xs)
         (unless first (display ","))
         (display (json->string (car xs)))
         (loop (cdr xs) #f)))
     (display "]"))
    ;; single object or other value
    (else
     (display (json->string v))))
  (newline))
(define failures 0)
(define (print-test-start name)
  (display "   test ") (display name) (display " ..."))
(define (print-test-pass) (display " ok") (newline))
(define (print-test-fail err) (display " fail ") (display err) (newline))
(define (run-test name thunk)
  (print-test-start name)
  (let ((ok #t))
    (with-exception-handler
      (lambda (e)
        (set! ok #f)
        (set! failures (+ failures 1))
        (print-test-fail e))
      (lambda () (thunk)))
    (when ok (print-test-pass))))

(define (test_TPCDS_Q78_simplified)
  (when (not (equal? result (list (list (cons 'ss_sold_year 1998) (cons 'ss_item_sk 1) (cons 'ss_customer_sk 1) (cons 'ratio 1.25) (cons 'store_qty 10) (cons 'store_wholesale_cost 50.0) (cons 'store_sales_price 100.0) (cons 'other_chan_qty 8) (cons 'other_chan_wholesale_cost 40.0) (cons 'other_chan_sales_price 80.0))))) (error "expect failed"))
)

(define ss (list (list (cons 'ss_sold_year 1998) (cons 'ss_item_sk 1) (cons 'ss_customer_sk 1) (cons 'ss_qty 10) (cons 'ss_wc 50.0) (cons 'ss_sp 100.0))))
(define ws (list (list (cons 'ws_sold_year 1998) (cons 'ws_item_sk 1) (cons 'ws_customer_sk 1) (cons 'ws_qty 5) (cons 'ws_wc 25.0) (cons 'ws_sp 50.0))))
(define cs (list (list (cons 'cs_sold_year 1998) (cons 'cs_item_sk 1) (cons 'cs_customer_sk 1) (cons 'cs_qty 3) (cons 'cs_wc 15.0) (cons 'cs_sp 30.0))))
(define result (let ((_res '()))
  (for-each (lambda (s)
    (let ((_ms0 '()) (_m0 #f))
      (for-each (lambda (w)
        (when (and (and (equal? (map-get w 'ws_sold_year) (map-get s 'ss_sold_year)) (equal? (map-get w 'ws_item_sk) (map-get s 'ss_item_sk))) (equal? (map-get w 'ws_customer_sk) (map-get s 'ss_customer_sk)))
          (set! _ms0 (append _ms0 (list w)))
          (set! _m0 #t))
) (if (string? ws) (string->list ws) ws))
      (if _m0
          (for-each (lambda (w)
            (let ((_ms1 '()) (_m1 #f))
              (for-each (lambda (c)
                (when (and (and (equal? (map-get c 'cs_sold_year) (map-get s 'ss_sold_year)) (equal? (map-get c 'cs_item_sk) (map-get s 'ss_item_sk))) (equal? (map-get c 'cs_customer_sk) (map-get s 'ss_customer_sk)))
                  (set! _ms1 (append _ms1 (list c)))
                  (set! _m1 #t))
) (if (string? cs) (string->list cs) cs))
              (if _m1
                  (for-each (lambda (c)
                    (when (and (or (_gt (if (equal? w '()) 0 (map-get w 'ws_qty)) 0) (_gt (if (equal? c '()) 0 (map-get c 'cs_qty)) 0)) (equal? (map-get s 'ss_sold_year) 1998))
                      (set! _res (append _res (list (list (cons 'ss_sold_year (map-get s 'ss_sold_year)) (cons 'ss_item_sk (map-get s 'ss_item_sk)) (cons 'ss_customer_sk (map-get s 'ss_customer_sk)) (cons 'ratio (/ (map-get s 'ss_qty) (+ (if (equal? w '()) 0 (map-get w 'ws_qty)) (if (equal? c '()) 0 (map-get c 'cs_qty))))) (cons 'store_qty (map-get s 'ss_qty)) (cons 'store_wholesale_cost (map-get s 'ss_wc)) (cons 'store_sales_price (map-get s 'ss_sp)) (cons 'other_chan_qty (+ (if (equal? w '()) 0 (map-get w 'ws_qty)) (if (equal? c '()) 0 (map-get c 'cs_qty)))) (cons 'other_chan_wholesale_cost (+ (if (equal? w '()) 0.0 (map-get w 'ws_wc)) (if (equal? c '()) 0.0 (map-get c 'cs_wc)))) (cons 'other_chan_sales_price (+ (if (equal? w '()) 0.0 (map-get w 'ws_sp)) (if (equal? c '()) 0.0 (map-get c 'cs_sp))))))))
                    )
                  ) _ms1)
                  (let ((c '()))
                    (when (and (or (_gt (if (equal? w '()) 0 (map-get w 'ws_qty)) 0) (_gt (if (equal? c '()) 0 (map-get c 'cs_qty)) 0)) (equal? (map-get s 'ss_sold_year) 1998))
                      (set! _res (append _res (list (list (cons 'ss_sold_year (map-get s 'ss_sold_year)) (cons 'ss_item_sk (map-get s 'ss_item_sk)) (cons 'ss_customer_sk (map-get s 'ss_customer_sk)) (cons 'ratio (/ (map-get s 'ss_qty) (+ (if (equal? w '()) 0 (map-get w 'ws_qty)) (if (equal? c '()) 0 (map-get c 'cs_qty))))) (cons 'store_qty (map-get s 'ss_qty)) (cons 'store_wholesale_cost (map-get s 'ss_wc)) (cons 'store_sales_price (map-get s 'ss_sp)) (cons 'other_chan_qty (+ (if (equal? w '()) 0 (map-get w 'ws_qty)) (if (equal? c '()) 0 (map-get c 'cs_qty)))) (cons 'other_chan_wholesale_cost (+ (if (equal? w '()) 0.0 (map-get w 'ws_wc)) (if (equal? c '()) 0.0 (map-get c 'cs_wc)))) (cons 'other_chan_sales_price (+ (if (equal? w '()) 0.0 (map-get w 'ws_sp)) (if (equal? c '()) 0.0 (map-get c 'cs_sp))))))))
                    )
                  ))
            )
          ) _ms0)
          (let ((w '()))
            (let ((_ms2 '()) (_m2 #f))
              (for-each (lambda (c)
                (when (and (and (equal? (map-get c 'cs_sold_year) (map-get s 'ss_sold_year)) (equal? (map-get c 'cs_item_sk) (map-get s 'ss_item_sk))) (equal? (map-get c 'cs_customer_sk) (map-get s 'ss_customer_sk)))
                  (set! _ms2 (append _ms2 (list c)))
                  (set! _m2 #t))
) (if (string? cs) (string->list cs) cs))
              (if _m2
                  (for-each (lambda (c)
                    (when (and (or (_gt (if (equal? w '()) 0 (map-get w 'ws_qty)) 0) (_gt (if (equal? c '()) 0 (map-get c 'cs_qty)) 0)) (equal? (map-get s 'ss_sold_year) 1998))
                      (set! _res (append _res (list (list (cons 'ss_sold_year (map-get s 'ss_sold_year)) (cons 'ss_item_sk (map-get s 'ss_item_sk)) (cons 'ss_customer_sk (map-get s 'ss_customer_sk)) (cons 'ratio (/ (map-get s 'ss_qty) (+ (if (equal? w '()) 0 (map-get w 'ws_qty)) (if (equal? c '()) 0 (map-get c 'cs_qty))))) (cons 'store_qty (map-get s 'ss_qty)) (cons 'store_wholesale_cost (map-get s 'ss_wc)) (cons 'store_sales_price (map-get s 'ss_sp)) (cons 'other_chan_qty (+ (if (equal? w '()) 0 (map-get w 'ws_qty)) (if (equal? c '()) 0 (map-get c 'cs_qty)))) (cons 'other_chan_wholesale_cost (+ (if (equal? w '()) 0.0 (map-get w 'ws_wc)) (if (equal? c '()) 0.0 (map-get c 'cs_wc)))) (cons 'other_chan_sales_price (+ (if (equal? w '()) 0.0 (map-get w 'ws_sp)) (if (equal? c '()) 0.0 (map-get c 'cs_sp))))))))
                    )
                  ) _ms2)
                  (let ((c '()))
                    (when (and (or (_gt (if (equal? w '()) 0 (map-get w 'ws_qty)) 0) (_gt (if (equal? c '()) 0 (map-get c 'cs_qty)) 0)) (equal? (map-get s 'ss_sold_year) 1998))
                      (set! _res (append _res (list (list (cons 'ss_sold_year (map-get s 'ss_sold_year)) (cons 'ss_item_sk (map-get s 'ss_item_sk)) (cons 'ss_customer_sk (map-get s 'ss_customer_sk)) (cons 'ratio (/ (map-get s 'ss_qty) (+ (if (equal? w '()) 0 (map-get w 'ws_qty)) (if (equal? c '()) 0 (map-get c 'cs_qty))))) (cons 'store_qty (map-get s 'ss_qty)) (cons 'store_wholesale_cost (map-get s 'ss_wc)) (cons 'store_sales_price (map-get s 'ss_sp)) (cons 'other_chan_qty (+ (if (equal? w '()) 0 (map-get w 'ws_qty)) (if (equal? c '()) 0 (map-get c 'cs_qty)))) (cons 'other_chan_wholesale_cost (+ (if (equal? w '()) 0.0 (map-get w 'ws_wc)) (if (equal? c '()) 0.0 (map-get c 'cs_wc)))) (cons 'other_chan_sales_price (+ (if (equal? w '()) 0.0 (map-get w 'ws_sp)) (if (equal? c '()) 0.0 (map-get c 'cs_sp))))))))
                    )
                  ))
            )
          ))
    )
  ) (if (string? ss) (string->list ss) ss))
  _res))
(_json result)
(run-test "TPCDS Q78 simplified" test_TPCDS_Q78_simplified)
(when (> failures 0) (display "\n[FAIL] ") (display failures) (display " test(s) failed.\n"))
