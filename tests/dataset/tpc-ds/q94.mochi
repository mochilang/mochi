let web_sales = [
  { ws_order_number: 1, ws_ship_date_sk: 1, ws_ship_addr_sk: 1, ws_web_site_sk: 1, ws_warehouse_sk: 1, ws_ext_ship_cost: 5.0, ws_net_profit: 10.0 },
  { ws_order_number: 1, ws_ship_date_sk: 1, ws_ship_addr_sk: 1, ws_web_site_sk: 1, ws_warehouse_sk: 2, ws_ext_ship_cost: 7.0, ws_net_profit: 12.0 }
]

let date_dim = [
  { d_date_sk: 1, d_date: "1999-02-10" }
]

let customer_address = [
  { ca_address_sk: 1, ca_state: "CA" }
]

let web_site = [
  { web_site_sk: 1, web_company_name: "pri" }
]

let wr_returns = [] // none so NOT EXISTS holds

let qualified_ws1 =
  from ws1 in web_sales
  join d in date_dim on d.d_date_sk == ws1.ws_ship_date_sk
  join ca in customer_address on ca.ca_address_sk == ws1.ws_ship_addr_sk
  join web in web_site on web.web_site_sk == ws1.ws_web_site_sk
  where d.d_date >= "1999-02-01" && d.d_date <= "1999-04-02" &&
        ca.ca_state == "CA" && web.web_company_name == "pri" &&
        exists(from ws2 in web_sales where ws1.ws_order_number == ws2.ws_order_number && ws1.ws_warehouse_sk != ws2.ws_warehouse_sk select 1) &&
        not exists(from wr1 in wr_returns where ws1.ws_order_number == wr1.wr_order_number select 1)
  select ws1

let result = [{
  "order count": count(distinct from x in qualified_ws1 select x.ws_order_number),
  "total shipping cost": sum(from x in qualified_ws1 select x.ws_ext_ship_cost),
  "total net profit": sum(from x in qualified_ws1 select x.ws_net_profit)
}]

json(result)

test "TPCDS Q94 simplified" {
  expect result == [{ "order count": 1, "total shipping cost": 5.0, "total net profit": 10.0 }]
}
