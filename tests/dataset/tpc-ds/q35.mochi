let customer = [
  {c_customer_sk: 1, c_current_addr_sk: 1, c_current_cdemo_sk: 1}
]

let customer_address = [
  {ca_address_sk: 1, ca_state: "CA"}
]

let customer_demographics = [
  {cd_demo_sk: 1, cd_gender: "M", cd_marital_status: "S", cd_dep_count: 2,
   cd_dep_employed_count: 1, cd_dep_college_count: 0}
]

let date_dim = [
  {d_date_sk: 1, d_qoy: 1, d_year: 2000}
]

let store_sales = [
  {ss_customer_sk: 1, ss_sold_date_sk: 1}
]

let web_sales = [
  {ws_bill_customer_sk: 1, ws_sold_date_sk: 1}
]

let result =
  from c in customer
  join ca in customer_address on c.c_current_addr_sk == ca.ca_address_sk
  join cd in customer_demographics on c.c_current_cdemo_sk == cd.cd_demo_sk
  where exists(from ss in store_sales
               join d in date_dim on ss.ss_sold_date_sk == d.d_date_sk
               where ss.ss_customer_sk == c.c_customer_sk && d.d_year == 2000 && d.d_qoy < 4
               select 1 |> first?) &&
        (exists(from ws in web_sales
                 join d in date_dim on ws.ws_sold_date_sk == d.d_date_sk
                 where ws.ws_bill_customer_sk == c.c_customer_sk && d.d_year == 2000 && d.d_qoy < 4
                 select 1 |> first?) ||
         exists(from cs in store_sales
                 join d in date_dim on cs.ss_sold_date_sk == d.d_date_sk
                 where cs.ss_customer_sk == c.c_customer_sk && d.d_year == 2000 && d.d_qoy < 4
                 select 1 |> first?))
  group by {state: ca.ca_state, gender: cd.cd_gender, marital: cd.cd_marital_status,
            dep: cd.cd_dep_count, emp: cd.cd_dep_employed_count, col: cd.cd_dep_college_count} into g
  select {
    ca_state: g.key.state,
    cd_gender: g.key.gender,
    cd_marital_status: g.key.marital,
    cd_dep_count: g.key.dep,
    cnt1: len(g), sum_dep: sum(from x in g select x.cd.cd_dep_count),
    min_dep: min(from x in g select x.cd.cd_dep_count),
    max_dep: max(from x in g select x.cd.cd_dep_count),
    avg_dep: avg(from x in g select x.cd.cd_dep_count),
    cd_dep_employed_count: g.key.emp,
    cnt2: len(g), sum_emp: sum(from x in g select x.cd.cd_dep_employed_count),
    min_emp: min(from x in g select x.cd.cd_dep_employed_count),
    max_emp: max(from x in g select x.cd.cd_dep_employed_count),
    avg_emp: avg(from x in g select x.cd.cd_dep_employed_count),
    cd_dep_college_count: g.key.col,
    cnt3: len(g), sum_col: sum(from x in g select x.cd.cd_dep_college_count),
    min_col: min(from x in g select x.cd.cd_dep_college_count),
    max_col: max(from x in g select x.cd.cd_dep_college_count),
    avg_col: avg(from x in g select x.cd.cd_dep_college_count)
  }
  |> to_list

json(result)

test "TPCDS Q35 simplified" {
  expect result == [{ca_state: "CA", cd_gender: "M", cd_marital_status: "S", cd_dep_count: 2,
    cnt1: 1, sum_dep: 2, min_dep: 2, max_dep: 2, avg_dep: 2.0,
    cd_dep_employed_count: 1, cnt2: 1, sum_emp: 1, min_emp: 1, max_emp: 1, avg_emp: 1.0,
    cd_dep_college_count: 0, cnt3: 1, sum_col: 0, min_col: 0, max_col: 0, avg_col: 0.0}]
}
