Letâ€™s proceed with **TPC-H Query 12**, which computes counts of high/low priority orders **shipped late**, grouped by **shipping mode**.

---

## ðŸ§¾ TPC-H Query 12 â€” Shipping Modes and Delays

### âœ… **SQL Overview**

```sql
SELECT
  l_shipmode,
  SUM(CASE WHEN o_orderpriority = '1-URGENT' OR o_orderpriority = '2-HIGH' THEN 1 ELSE 0 END) AS high_line_count,
  SUM(CASE WHEN o_orderpriority <> '1-URGENT' AND o_orderpriority <> '2-HIGH' THEN 1 ELSE 0 END) AS low_line_count
FROM
  orders,
  lineitem
WHERE
  o_orderkey = l_orderkey
  AND l_shipmode IN ('MAIL', 'SHIP')
  AND l_commitdate < l_receiptdate
  AND l_shipdate < l_commitdate
  AND l_receiptdate >= DATE '1994-01-01'
  AND l_receiptdate < DATE '1995-01-01'
GROUP BY
  l_shipmode
ORDER BY
  l_shipmode;
```

### ðŸ§  Purpose

> Counts late shipments (by shipping mode) based on whether the order was high priority or not.

---

## ðŸ¦Š Mochi Version â€” Inline + Test

We simulate:

* 2 lineitems with different shipping modes and dates
* 2 orders with different priorities
* Only 1 matches all filters and is `'1-URGENT'`

---

### ðŸ§¾ **Mochi Code**

```mochi
let orders = [
  { o_orderkey: 1, o_orderpriority: "1-URGENT" },
  { o_orderkey: 2, o_orderpriority: "3-MEDIUM" }
]

let lineitem = [
  {
    l_orderkey: 1,
    l_shipmode: "MAIL",
    l_commitdate: "1994-02-10",
    l_receiptdate: "1994-02-15",
    l_shipdate: "1994-02-05"
  },
  {
    l_orderkey: 2,
    l_shipmode: "SHIP",
    l_commitdate: "1994-03-01",
    l_receiptdate: "1994-02-28", // commitdate > receiptdate â†’ excluded
    l_shipdate: "1994-02-27"
  }
]

let result =
  from l in lineitem
  where
    l.l_shipmode in ["MAIL", "SHIP"] and
    l.l_commitdate < l.l_receiptdate and
    l.l_shipdate < l.l_commitdate and
    l.l_receiptdate >= "1994-01-01" and
    l.l_receiptdate < "1995-01-01"
  join o in orders on o.o_orderkey == l.l_orderkey
  group by l.l_shipmode
  select {
    l_shipmode: l.l_shipmode,
    high_line_count: count(if o.o_orderpriority in ["1-URGENT", "2-HIGH"] then 1 else null),
    low_line_count: count(if o.o_orderpriority not in ["1-URGENT", "2-HIGH"] then 1 else null)
  }
  order by l_shipmode

print result

test "Q12 counts lineitems by ship mode and priority" {
  expect result == [
    {
      l_shipmode: "MAIL",
      high_line_count: 1,
      low_line_count: 0
    }
  ]
}
```

---

### âœ… Explanation

| Lineitem | Mode | Commit < Receipt? | Receipt in 1994? | Priority | Counted In        |
| -------- | ---- | ----------------- | ---------------- | -------- | ----------------- |
| L1       | MAIL | âœ…                 | âœ…                | 1-URGENT | high count (MAIL) |
| L2       | SHIP | âŒ (invalid)       | âœ–ï¸               | 3-MEDIUM | Excluded          |

Only one valid row â†’ `MAIL` â†’ high priority â†’ `high_line_count = 1`.

---

Ready for **Query 13**, which uses a **correlated subquery** to count customers who placed many orders?
