Letâ€™s continue with **TPC-H Query 8**, which introduces region-based filtering, joins across multiple dimensions, and market share calculation by nation.

---

## ğŸ§¾ TPC-H Query 8 â€” National Market Share

### âœ… **SQL Overview**

```sql
SELECT
  o_year,
  SUM(CASE
      WHEN nation = ':nation'
      THEN l_extendedprice * (1 - l_discount)
      ELSE 0 END) / SUM(l_extendedprice * (1 - l_discount)) AS mkt_share
FROM
  part, supplier, lineitem, orders, customer, nation, region
WHERE
  p_partkey = l_partkey
  AND s_suppkey = l_suppkey
  AND l_orderkey = o_orderkey
  AND o_custkey = c_custkey
  AND c_nationkey = n_nationkey
  AND n_regionkey = r_regionkey
  AND r_name = 'AMERICA'
  AND o_orderdate BETWEEN DATE '1995-01-01' AND DATE '1996-12-31'
  AND p_type = 'ECONOMY ANODIZED STEEL'
GROUP BY
  o_year
ORDER BY
  o_year;
```

### ğŸ§  Purpose

> Measures the **market share** of a specific nation (e.g., 'BRAZIL') for a certain part type in a region and year range.

---

## ğŸ¦Š Mochi Version â€” Inline + Test

We simulate:

* 2 nations: BRAZIL and CANADA (both in AMERICA)
* 1 part (type: ECONOMY ANODIZED STEEL)
* 2 orders, 2 lineitems
* 1 from BRAZIL (â†’ counts in numerator and denominator)
* 1 from CANADA (â†’ counts only in denominator)

---

### ğŸ§¾ **Mochi Code**

```mochi
let region = [
  { r_regionkey: 0, r_name: "AMERICA" }
]

let nation = [
  { n_nationkey: 10, n_regionkey: 0, n_name: "BRAZIL" },
  { n_nationkey: 20, n_regionkey: 0, n_name: "CANADA" }
]

let customer = [
  { c_custkey: 1, c_nationkey: 10 },
  { c_custkey: 2, c_nationkey: 20 }
]

let orders = [
  { o_orderkey: 100, o_custkey: 1, o_orderdate: "1995-04-10" },
  { o_orderkey: 200, o_custkey: 2, o_orderdate: "1995-07-15" }
]

let lineitem = [
  { l_orderkey: 100, l_suppkey: 1000, l_partkey: 5000, l_extendedprice: 1000.0, l_discount: 0.1 },
  { l_orderkey: 200, l_suppkey: 2000, l_partkey: 5000, l_extendedprice: 500.0, l_discount: 0.05 }
]

let supplier = [
  { s_suppkey: 1000 },
  { s_suppkey: 2000 }
]

let part = [
  { p_partkey: 5000, p_type: "ECONOMY ANODIZED STEEL" },
  { p_partkey: 6000, p_type: "SMALL BRASS" }
]

let start_date = "1995-01-01"
let end_date = "1996-12-31"
let target_type = "ECONOMY ANODIZED STEEL"
let target_nation = "BRAZIL"

let result =
  from l in lineitem
  join p in part on p.p_partkey == l.l_partkey
  where p.p_type == target_type
  join s in supplier on s.s_suppkey == l.l_suppkey
  join o in orders on o.o_orderkey == l.l_orderkey
  where o.o_orderdate >= start_date and o.o_orderdate <= end_date
  join c in customer on c.c_custkey == o.o_custkey
  join n in nation on n.n_nationkey == c.c_nationkey
  join r in region on r.r_regionkey == n.n_regionkey
  where r.r_name == "AMERICA"
  let revenue = l.l_extendedprice * (1 - l.l_discount)
  let year = substring(o.o_orderdate, 0, 4)
  group by year
  select {
    o_year: year,
    mkt_share:
      sum(if n.n_name == target_nation then revenue else 0) /
      sum(revenue)
  }
  order by o_year

print result

test "Q8 returns correct market share for BRAZIL in 1995" {
  let numerator = 1000.0 * 0.9      // 900
  let denominator = numerator + 500.0 * 0.95 // 900 + 475 = 1375
  let share = numerator / denominator         // â‰ˆ 0.6545

  expect result == [
    { o_year: "1995", mkt_share: share }
  ]
}
```

---

### âœ… Explanation

| Order | Nation | Year | Revenue | Counts In               |
| ----- | ------ | ---- | ------- | ----------------------- |
| 100   | BRAZIL | 1995 | 900.0   | Numerator + Denominator |
| 200   | CANADA | 1995 | 475.0   | Denominator only        |

â†’ `mkt_share = 900 / 1375 â‰ˆ 0.6545`

---

Want to proceed to **Query 9**, which calculates **profit by nation and part name prefix**?
