Let’s continue with **TPC-H Query 13**, which uses a **correlated subquery** to count **how many customers** have placed **more than one order** — excluding those who haven't ordered anything.

---

## 🧾 TPC-H Query 13 — Customer Distribution

### ✅ **SQL Overview**

```sql
SELECT
  c_count,
  COUNT(*) AS custdist
FROM (
  SELECT
    c_custkey,
    COUNT(o_orderkey) AS c_count
  FROM
    customer
    LEFT OUTER JOIN orders ON c_custkey = o_custkey
  WHERE
    o_comment NOT LIKE '%special%requests%'
  GROUP BY
    c_custkey
) AS c_orders
GROUP BY
  c_count
ORDER BY
  custdist DESC,
  c_count DESC;
```

### 🧠 Purpose

> For each number of orders a customer has placed (after filtering out orders with special requests), count how many customers fall into that group.

---

## 🦊 Mochi Version — Inline + Test

We simulate:

* 3 customers
* 3 orders (1 filtered due to `'special requests'`)
* Output: `{c_count → number of customers}`

---

### 🧾 **Mochi Code**

```mochi
let customer = [
  { c_custkey: 1 },
  { c_custkey: 2 },
  { c_custkey: 3 }
]

let orders = [
  { o_orderkey: 100, o_custkey: 1, o_comment: "fast delivery" },
  { o_orderkey: 101, o_custkey: 1, o_comment: "no comment" },
  { o_orderkey: 102, o_custkey: 2, o_comment: "special requests only" } // excluded
]

let per_customer =
  from c in customer
  let order_count =
    count(
      from o in orders
      where (
        o.o_custkey == c.c_custkey &&
        (!("special" in o.o_comment)) &&
        (!("requests" in o.o_comment))
      )
      select o
    )
  select { c_count: order_count }

let grouped =
  from x in per_customer
  group by x.c_count
  select { c_count: x.c_count, custdist: count() }
  order by { custdist desc, c_count desc }

print grouped

test "Q13 groups customers by non-special order count" {
  expect grouped == [
    { c_count: 2, custdist: 1 },  // customer 1
    { c_count: 0, custdist: 2 }   // customer 2 & 3
  ]
}
```

---

### ✅ Explanation

| Custkey | Orders (filtered)      | c\_count |
| ------- | ---------------------- | -------- |
| 1       | 2 valid orders         | 2        |
| 2       | 1 order with “special” | 0        |
| 3       | No orders              | 0        |

→ `{2 → 1}, {0 → 2}`

---

Would you like to proceed to **Query 14**, which calculates the **revenue impact of promotions** using a percentage of total sales?
