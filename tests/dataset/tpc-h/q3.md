Great â€” letâ€™s proceed to **TPC-H Query 3**, again with **inline data**, **Mochi syntax**, and a correctness `test`.

---

## ðŸ“¦ TPC-H Query 3 â€” Shipping Priority

### âœ… **SQL Overview**

```sql
SELECT
  l_orderkey,
  SUM(l_extendedprice * (1 - l_discount)) AS revenue,
  o_orderdate,
  o_shippriority
FROM
  customer, orders, lineitem
WHERE
  c_mktsegment = ':segment'
  AND c_custkey = o_custkey
  AND l_orderkey = o_orderkey
  AND o_orderdate < DATE ':date'
  AND l_shipdate > DATE ':date'
GROUP BY
  l_orderkey, o_orderdate, o_shippriority
ORDER BY
  revenue DESC, o_orderdate
```

### ðŸ§  Purpose

> For customers in a given **market segment**, return revenue by **order**, only if the order was placed before a date and shipped after it.

---

## ðŸ¦Š Mochi Version â€” Inline + Test

Letâ€™s assume:

* Market segment: `"BUILDING"`
* Cutoff date: `"1995-03-15"`

### ðŸ§¾ **Mochi Code**

```mochi
let customer = [
  { c_custkey: 1, c_mktsegment: "BUILDING" },
  { c_custkey: 2, c_mktsegment: "AUTOMOBILE" }
]

let orders = [
  { o_orderkey: 100, o_custkey: 1, o_orderdate: "1995-03-14", o_shippriority: 1 },
  { o_orderkey: 200, o_custkey: 2, o_orderdate: "1995-03-10", o_shippriority: 2 }
]

let lineitem = [
  { l_orderkey: 100, l_extendedprice: 1000.0, l_discount: 0.05, l_shipdate: "1995-03-16" },
  { l_orderkey: 100, l_extendedprice: 500.0, l_discount: 0.00, l_shipdate: "1995-03-20" },
  { l_orderkey: 200, l_extendedprice: 1000.0, l_discount: 0.10, l_shipdate: "1995-03-14" } // too early
]

let cutoff = "1995-03-15"
let segment = "BUILDING"

let building_customers =
  from c in customer
  where c.c_mktsegment == segment
  select c

let valid_orders =
  from o in orders
  join c in building_customers on o.o_custkey == c.c_custkey
  where o.o_orderdate < cutoff
  select o

let valid_lineitems =
  from l in lineitem
  where l.l_shipdate > cutoff
  select l

let order_line_join =
  from o in valid_orders
  join l in valid_lineitems on l.l_orderkey == o.o_orderkey
  group by { o.o_orderkey, o.o_orderdate, o.o_shippriority }
  select {
    l_orderkey: o.o_orderkey,
    revenue: sum(l.l_extendedprice * (1 - l.l_discount)),
    o_orderdate: o.o_orderdate,
    o_shippriority: o.o_shippriority
  }
  order by { revenue desc, o_orderdate }

print order_line_join

test "Q3 returns revenue per order with correct priority" {
  expect order_line_join == [
    {
      l_orderkey: 100,
      revenue: 1000.0 * 0.95 + 500.0,
      o_orderdate: "1995-03-14",
      o_shippriority: 1
    }
  ]
}
```

---

### ðŸ§  Breakdown:

* `c_mktsegment == "BUILDING"` filters customers
* `o_orderdate < "1995-03-15"` filters orders
* `l_shipdate > "1995-03-15"` filters lineitems
* Joins on `custkey` and `orderkey`
* Group by `order` and compute `revenue`
* Sort by `revenue desc`, then `orderdate`

---

Would you like to continue with **Q4** or switch to a **streaming variant** of one of the queries in Mochi?
