Letâ€™s move on to **TPC-H Query 10**, which identifies **top customers by revenue** from returned items. It uses filtering, joining, grouping, sorting, and limiting the result set.

---

## ğŸ§¾ TPC-H Query 10 â€” Returned Item Reporting

### âœ… **SQL Overview**

```sql
SELECT
  c_custkey,
  c_name,
  SUM(l_extendedprice * (1 - l_discount)) AS revenue,
  c_acctbal,
  n_name,
  c_address,
  c_phone,
  c_comment
FROM
  customer,
  orders,
  lineitem,
  nation
WHERE
  c_custkey = o_custkey
  AND l_orderkey = o_orderkey
  AND o_orderdate >= DATE '1993-10-01'
  AND o_orderdate < DATE '1994-01-01'
  AND l_returnflag = 'R'
  AND c_nationkey = n_nationkey
GROUP BY
  c_custkey, c_name, c_acctbal, c_phone, n_name, c_address, c_comment
ORDER BY
  revenue DESC;
```

### ğŸ§  Purpose

> Computes **customer revenue** from **returned items** (`l_returnflag = 'R'`) during a **date window**, with nation and account metadata.

---

## ğŸ¦Š Mochi Version â€” Inline + Test

We simulate:

* 2 customers (1 in BRAZIL)
* 2 orders (only 1 in date window)
* 2 lineitems (only 1 flagged `'R'` and linked to the order)

---

### ğŸ§¾ **Mochi Code**

```mochi
let nation = [
  { n_nationkey: 1, n_name: "BRAZIL" }
]

let customer = [
  {
    c_custkey: 1,
    c_name: "Alice",
    c_acctbal: 100.0,
    c_nationkey: 1,
    c_address: "123 St",
    c_phone: "123-456",
    c_comment: "Loyal"
  }
]

let orders = [
  { o_orderkey: 1000, o_custkey: 1, o_orderdate: "1993-10-15" },
  { o_orderkey: 2000, o_custkey: 1, o_orderdate: "1994-01-02" } // outside window
]

let lineitem = [
  {
    l_orderkey: 1000,
    l_returnflag: "R",
    l_extendedprice: 1000.0,
    l_discount: 0.1
  },
  {
    l_orderkey: 2000,
    l_returnflag: "N",
    l_extendedprice: 500.0,
    l_discount: 0.0
  }
]

let start_date = "1993-10-01"
let end_date = "1994-01-01"

let result =
  from c in customer
  join o in orders on o.o_custkey == c.c_custkey
  where o.o_orderdate >= start_date and o.o_orderdate < end_date
  join l in lineitem on l.l_orderkey == o.o_orderkey
  where l.l_returnflag == "R"
  join n in nation on n.n_nationkey == c.c_nationkey
  let revenue = l.l_extendedprice * (1 - l.l_discount)
  group by {
    c_custkey: c.c_custkey,
    c_name: c.c_name,
    c_acctbal: c.c_acctbal,
    c_address: c.c_address,
    c_phone: c.c_phone,
    c_comment: c.c_comment,
    n_name: n.n_name
  }
  select {
    c_custkey,
    c_name,
    revenue: sum(revenue),
    c_acctbal,
    n_name,
    c_address,
    c_phone,
    c_comment
  }
  order by revenue desc

print result

test "Q10 returns customer revenue from returned items" {
  expect result == [
    {
      c_custkey: 1,
      c_name: "Alice",
      revenue: 1000.0 * 0.9, // 900.0
      c_acctbal: 100.0,
      n_name: "BRAZIL",
      c_address: "123 St",
      c_phone: "123-456",
      c_comment: "Loyal"
    }
  ]
}
```

---

### âœ… Explanation

| Lineitem | Order Date | Return? | Match? | Revenue |
| -------- | ---------- | ------- | ------ | ------- |
| L1       | 1993-10-15 | R       | âœ…      | 900.0   |
| L2       | 1994-01-02 | N       | âŒ      | â€”       |

Only one lineitem satisfies all conditions (`order date in range`, `returnflag == R`).

---

Ready for **Query 11**, which filters **high-value parts** supplied by suppliers in a specific nation?
