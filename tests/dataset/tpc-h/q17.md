Letâ€™s now move on to **TPC-H Query 18**, which identifies **big-volume customers** â€” customers whose **total quantity ordered** exceeds a threshold, and then computes their **total revenue**.

---

## ðŸ§¾ TPC-H Query 18 â€” Large Volume Customer

### âœ… **SQL Overview**

```sql
SELECT
  c_name,
  c_custkey,
  SUM(l_extendedprice * (1 - l_discount)) AS revenue,
  c_acctbal,
  n_name,
  c_address,
  c_phone,
  c_comment
FROM
  customer,
  orders,
  lineitem,
  nation
WHERE
  c_custkey = o_custkey
  AND o_orderkey = l_orderkey
  AND c_nationkey = n_nationkey
GROUP BY
  c_name, c_custkey, c_acctbal, c_phone, n_name, c_address, c_comment
HAVING
  SUM(l_quantity) > :threshold
ORDER BY
  revenue DESC;
```

### ðŸ§  Purpose

> Identify **high-volume customers** whoâ€™ve ordered more than a certain quantity (e.g., 300 units total), and return their revenue and metadata.

---

## ðŸ¦Š Mochi Version â€” Inline + Test

We simulate:

* 2 customers (1 exceeds threshold)
* Lineitems across multiple orders
* We use a threshold of `300`

---

### ðŸ§¾ **Mochi Code**

```mochi
let nation = [
  { n_nationkey: 1, n_name: "GERMANY" }
]

let customer = [
  {
    c_custkey: 1,
    c_name: "Alice",
    c_acctbal: 500.0,
    c_nationkey: 1,
    c_address: "123 Street",
    c_phone: "123-456",
    c_comment: "Top client"
  },
  {
    c_custkey: 2,
    c_name: "Bob",
    c_acctbal: 100.0,
    c_nationkey: 1,
    c_address: "456 Road",
    c_phone: "987-654",
    c_comment: "New account"
  }
]

let orders = [
  { o_orderkey: 100, o_custkey: 1 },
  { o_orderkey: 200, o_custkey: 1 },
  { o_orderkey: 300, o_custkey: 2 }
]

let lineitem = [
  { l_orderkey: 100, l_quantity: 150, l_extendedprice: 1000.0, l_discount: 0.05 },
  { l_orderkey: 200, l_quantity: 200, l_extendedprice: 1500.0, l_discount: 0.10 },
  { l_orderkey: 300, l_quantity: 50, l_extendedprice: 500.0, l_discount: 0.00 }
]

let threshold = 300

let joined =
  from c in customer
  join o in orders on o.o_custkey == c.c_custkey
  join l in lineitem on l.l_orderkey == o.o_orderkey
  join n in nation on c.c_nationkey == n.n_nationkey
  group by {
    c_name: c.c_name,
    c_custkey: c.c_custkey,
    c_acctbal: c.c_acctbal,
    c_address: c.c_address,
    c_phone: c.c_phone,
    c_comment: c.c_comment,
    n_name: n.n_name
  }
  having sum(l.l_quantity) > threshold
  select {
    c_name,
    c_custkey,
    revenue: sum(l.l_extendedprice * (1 - l.l_discount)),
    c_acctbal,
    n_name,
    c_address,
    c_phone,
    c
```


Let's now correctly handle **TPC-H Query 17**, which calculates revenue for **expensive parts** ordered in **small quantities**, by comparing each lineitemâ€™s quantity to **20% of the average quantity for the same part**.

---

## ðŸ§¾ TPC-H Query 17 â€” Small Quantity Order Revenue

### âœ… **SQL Overview**

```sql
SELECT
  SUM(l_extendedprice) / 7.0 AS avg_yearly
FROM
  lineitem,
  part
WHERE
  p_partkey = l_partkey
  AND p_brand = ':brand'
  AND p_container = ':container'
  AND l_quantity < (
    SELECT 0.2 * AVG(l_quantity)
    FROM lineitem
    WHERE l_partkey = p_partkey
  );
```

### ðŸ§  Purpose

> For a given `brand` and `container`, compute average yearly revenue from orders with **low quantity**, where low is defined as < 20% of the **avg quantity per part**.

---

## ðŸ¦Š Mochi Version â€” Inline + Test (Fixed)

We simulate:

* 1 part: `Brand#23`, `MED BOX`
* 3 lineitems for that part: quantities 1, 10, 20 â†’ avg = 10.33 â†’ threshold = 2.066
* Only 1 lineitem (`qty = 1`) qualifies

---

### ðŸ§¾ **Mochi Code**

```mochi
let part = [
  { p_partkey: 1, p_brand: "Brand#23", p_container: "MED BOX" },
  { p_partkey: 2, p_brand: "Brand#77", p_container: "LG JAR" }
]

let lineitem = [
  { l_partkey: 1, l_quantity: 1, l_extendedprice: 100.0 },   // qualifies
  { l_partkey: 1, l_quantity: 10, l_extendedprice: 1000.0 },
  { l_partkey: 1, l_quantity: 20, l_extendedprice: 2000.0 },
  { l_partkey: 2, l_quantity: 5, l_extendedprice: 500.0 }     // wrong brand/container
]

let brand = "Brand#23"
let container = "MED BOX"

let result =
  from l in lineitem
  join p in part on p.p_partkey == l.l_partkey
  where
    p.p_brand == brand and
    p.p_container == container and
    l.l_quantity < (
      let avg_qty = avg(x.l_quantity for x in lineitem where x.l_partkey == p.p_partkey)
      in 0.2 * avg_qty
    )
  select sum(l.l_extendedprice) / 7.0

print result

test "Q17 returns average yearly revenue for small-quantity orders" {
  let expected = 100.0 / 7.0
  expect result == expected
}
```

---

### âœ… Explanation

| l\_quantity | Avg Qty (p1) | 20% Threshold | Match? |
| ----------- | ------------ | ------------- | ------ |
| 1           | 10.33        | 2.066         | âœ…      |
| 10, 20      |              |               | âŒ      |

â†’ Only one matching lineitem â†’ `100 / 7.0 = 14.285714...`

---

Would you like to proceed to **Query 18**, which selects **large volume customers** who have **high total quantity** across all their orders?
