Let‚Äôs continue with **TPC-H Query 18**, which identifies **customers whose total ordered quantity exceeds a threshold**, and computes their **revenue and metadata**.

---

## üßæ TPC-H Query 18 ‚Äî Large Volume Customer

### ‚úÖ **SQL Overview**

```sql
SELECT
  c_name,
  c_custkey,
  SUM(l_extendedprice * (1 - l_discount)) AS revenue,
  c_acctbal,
  n_name,
  c_address,
  c_phone,
  c_comment
FROM
  customer,
  orders,
  lineitem,
  nation
WHERE
  c_custkey = o_custkey
  AND o_orderkey = l_orderkey
  AND c_nationkey = n_nationkey
GROUP BY
  c_name, c_custkey, c_acctbal, c_phone, n_name, c_address, c_comment
HAVING
  SUM(l_quantity) > :threshold
ORDER BY
  revenue DESC;
```

### üß† Purpose

> Finds **high-volume customers** (those ordering more than `:threshold` total quantity) and returns their **revenue and profile data**.

---

## ü¶ä Mochi Version ‚Äî Inline + Test

We simulate:

* 2 customers
* Multiple orders and lineitems
* Set threshold = `200`, only 1 customer passes

---

### üßæ **Mochi Code**

```mochi
let nation = [
  { n_nationkey: 1, n_name: "GERMANY" }
]

let customer = [
  {
    c_custkey: 1,
    c_name: "Alice",
    c_acctbal: 1000.0,
    c_nationkey: 1,
    c_address: "123 Market St",
    c_phone: "123-456",
    c_comment: "Premium client"
  },
  {
    c_custkey: 2,
    c_name: "Bob",
    c_acctbal: 200.0,
    c_nationkey: 1,
    c_address: "456 Side St",
    c_phone: "987-654",
    c_comment: "Frequent returns"
  }
]

let orders = [
  { o_orderkey: 100, o_custkey: 1 },
  { o_orderkey: 200, o_custkey: 1 },
  { o_orderkey: 300, o_custkey: 2 }
]

let lineitem = [
  { l_orderkey: 100, l_quantity: 150, l_extendedprice: 1000.0, l_discount: 0.1 },
  { l_orderkey: 200, l_quantity: 100, l_extendedprice: 800.0, l_discount: 0.0 },
  { l_orderkey: 300, l_quantity: 30, l_extendedprice: 300.0, l_discount: 0.05 }
]

let threshold = 200

let result =
  from c in customer
  join o in orders on o.o_custkey == c.c_custkey
  join l in lineitem on l.l_orderkey == o.o_orderkey
  join n in nation on n.n_nationkey == c.c_nationkey
  group by {
    c_name: c.c_name,
    c_custkey: c.c_custkey,
    c_acctbal: c.c_acctbal,
    c_address: c.c_address,
    c_phone: c.c_phone,
    c_comment: c.c_comment,
    n_name: n.n_name
  }
  having sum(l.l_quantity) > threshold
  select {
    c_name,
    c_custkey,
    revenue: sum(l.l_extendedprice * (1 - l.l_discount)),
    c_acctbal,
    n_name,
    c_address,
    c_phone,
    c_comment
  }
  order by revenue desc

print result

test "Q18 returns large-volume customers with total quantity > 200" {
  // Alice: 150 + 100 = 250 > 200 ‚Üí included
  // Revenue = 1000*0.9 + 800 = 900 + 800 = 1700
  expect result == [
    {
      c_name: "Alice",
      c_custkey: 1,
      revenue: 1700.0,
      c_acctbal: 1000.0,
      n_name: "GERMANY",
      c_address: "123 Market St",
      c_phone: "123-456",
      c_comment: "Premium client"
    }
  ]
}
```

---

### ‚úÖ Explanation

| Customer | Quantity        | Revenue                 | Included? |
| -------- | --------------- | ----------------------- | --------- |
| Alice    | 150 + 100 = 250 | 1000√ó0.9 + 800 = 1700.0 | ‚úÖ         |
| Bob      | 30              | 300√ó0.95 = 285.0        | ‚ùå         |

---

Would you like to continue with **Query 19**, which filters revenue for **branded parts** with complex container/size conditions?
