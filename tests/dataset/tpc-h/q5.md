Letâ€™s proceed with **TPC-H Query 5**, again in **Mochi**, with inline datasets and a correctness `test`.

---

## ðŸ§¾ TPC-H Query 5 â€” Local Supplier Volume

### âœ… **SQL Overview**

```sql
SELECT
  n_name,
  SUM(l_extendedprice * (1 - l_discount)) AS revenue
FROM
  customer, orders, lineitem, supplier, nation, region
WHERE
  c_custkey = o_custkey
  AND l_orderkey = o_orderkey
  AND l_suppkey = s_suppkey
  AND c_nationkey = s_nationkey
  AND s_nationkey = n_nationkey
  AND n_regionkey = r_regionkey
  AND r_name = 'ASIA'
  AND o_orderdate >= DATE '1994-01-01'
  AND o_orderdate < DATE '1995-01-01'
GROUP BY
  n_name
ORDER BY
  revenue DESC;
```

### ðŸ§  Purpose

> Calculates total revenue per **nation** for **local customers and suppliers** (same nation), within a region (`'ASIA'`) and a specific year.

---

## ðŸ¦Š Mochi Version â€” Inline + Test

We simulate:

* 1 region: `ASIA`
* 2 nations: `JAPAN`, `INDIA`
* 2 customers and 2 suppliers (nation-aligned)
* 3 orders and 3 lineitems

---

### ðŸ§¾ **Mochi Code**

```mochi
let region = [
  { r_regionkey: 0, r_name: "ASIA" },
  { r_regionkey: 1, r_name: "EUROPE" }
]

let nation = [
  { n_nationkey: 10, n_regionkey: 0, n_name: "JAPAN" },
  { n_nationkey: 20, n_regionkey: 0, n_name: "INDIA" },
  { n_nationkey: 30, n_regionkey: 1, n_name: "FRANCE" }
]

let customer = [
  { c_custkey: 1, c_nationkey: 10 },
  { c_custkey: 2, c_nationkey: 20 }
]

let supplier = [
  { s_suppkey: 100, s_nationkey: 10 },
  { s_suppkey: 200, s_nationkey: 20 }
]

let orders = [
  { o_orderkey: 1000, o_custkey: 1, o_orderdate: "1994-03-15" },
  { o_orderkey: 2000, o_custkey: 2, o_orderdate: "1994-06-10" },
  { o_orderkey: 3000, o_custkey: 2, o_orderdate: "1995-01-01" } // outside range
]

let lineitem = [
  { l_orderkey: 1000, l_suppkey: 100, l_extendedprice: 1000.0, l_discount: 0.05 },
  { l_orderkey: 2000, l_suppkey: 200, l_extendedprice: 800.0, l_discount: 0.10 },
  { l_orderkey: 3000, l_suppkey: 200, l_extendedprice: 900.0, l_discount: 0.05 } // ignored
]

let asia_nations =
  from r in region
  join n in nation on n.n_regionkey == r.r_regionkey
  where r.r_name == "ASIA"
  select n

let local_customer_supplier_orders =
  from c in customer
  join n in asia_nations on c.c_nationkey == n.n_nationkey
  join o in orders on o.o_custkey == c.c_custkey
  join l in lineitem on l.l_orderkey == o.o_orderkey
  join s in supplier on s.s_suppkey == l.l_suppkey
  where o.o_orderdate >= "1994-01-01" and o.o_orderdate < "1995-01-01" and s.s_nationkey == c.c_nationkey
  select {
    nation: n.n_name,
    revenue: l.l_extendedprice * (1 - l.l_discount)
  }

let result =
  from r in local_customer_supplier_orders
  group by r.nation
  select {
    n_name: r.nation,
    revenue: sum(r.revenue)
  }
  order by revenue desc

print result

test "Q5 returns revenue per nation in ASIA with local suppliers" {
  expect result == [
    { n_name: "JAPAN", revenue: 950.0 },
    { n_name: "INDIA", revenue: 720.0 }
  ]
}
```

---

### âœ… Explanation of Result

| Nation | Revenue Calculation             |
| ------ | ------------------------------- |
| JAPAN  | `1000.0 * (1 - 0.05)` = `950.0` |
| INDIA  | `800.0 * (1 - 0.10)` = `720.0`  |

Only 2 orders from 1994 with matching customer/supplier nation in ASIA.

---

Would you like to continue to **Query 6**, which is simpler (single-table revenue filter with discount range)?
