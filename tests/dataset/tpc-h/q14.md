Letâ€™s move on to **TPC-H Query 14**, a concise but insightful query that calculates the **effect of promotions** by comparing revenue from promotional items vs. total revenue.

---

## ðŸ§¾ TPC-H Query 14 â€” Promotion Effect

### âœ… **SQL Overview**

```sql
SELECT
  100.00 * SUM(
    CASE
      WHEN p_type LIKE 'PROMO%' THEN l_extendedprice * (1 - l_discount)
      ELSE 0
    END
  ) / SUM(l_extendedprice * (1 - l_discount)) AS promo_revenue
FROM
  lineitem,
  part
WHERE
  l_partkey = p_partkey
  AND l_shipdate >= DATE '1995-09-01'
  AND l_shipdate < DATE '1995-10-01';
```

### ðŸ§  Purpose

> Computes the percentage of **total revenue** from **PROMO products** shipped in **September 1995**.

---

## ðŸ¦Š Mochi Version â€” Inline + Test

We simulate:

* 2 parts (one `PROMO`, one not)
* 3 lineitems (only 2 shipped in Sept 1995)

---

### ðŸ§¾ **Mochi Code**

```mochi
let part = [
  { p_partkey: 1, p_type: "PROMO LUXURY" },
  { p_partkey: 2, p_type: "STANDARD BRASS" }
]

let lineitem = [
  {
    l_partkey: 1,
    l_extendedprice: 1000.0,
    l_discount: 0.1,
    l_shipdate: "1995-09-05"
  },
  {
    l_partkey: 2,
    l_extendedprice: 800.0,
    l_discount: 0.0,
    l_shipdate: "1995-09-20"
  },
  {
    l_partkey: 1,
    l_extendedprice: 500.0,
    l_discount: 0.2,
    l_shipdate: "1995-10-02"  // outside range
  }
]

let start_date = "1995-09-01"
let end_date = "1995-10-01"

let filtered =
  from l in lineitem
  where l.l_shipdate >= start_date and l.l_shipdate < end_date
  join p in part on p.p_partkey == l.l_partkey
  let revenue = l.l_extendedprice * (1 - l.l_discount)
  select {
    is_promo: p.p_type has "PROMO",
    revenue
  }

let promo_sum = sum(x.revenue for x in filtered where x.is_promo)
let total_sum = sum(x.revenue for x in filtered)

let result = 100.0 * promo_sum / total_sum

print result

test "Q14 calculates promo revenue percent in 1995-09" {
  let promo = 1000.0 * 0.9       // = 900
  let total = 900 + 800.0        // = 1700
  let expected = 100.0 * promo / total  // â‰ˆ 52.94

  expect result == expected
}
```

---

### âœ… Explanation

| Lineitem | Part Type      | Shipdate   | Revenue | Promo?       |
| -------- | -------------- | ---------- | ------- | ------------ |
| 1        | PROMO LUXURY   | 1995-09-05 | 900.0   | âœ…            |
| 2        | STANDARD BRASS | 1995-09-20 | 800.0   | âŒ            |
| 3        | PROMO LUXURY   | 1995-10-02 | â€”       | âŒ (excluded) |

â†’ **Promo % = 900 / 1700 Ã— 100 = 52.94%**

---

Ready for **Query 15**, which identifies the **top supplier by revenue**, using a **view** and selection of **max revenue**?
