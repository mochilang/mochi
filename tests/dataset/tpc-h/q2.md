Let's move on to **TPC-H Query 2** in **Mochi**, with **inline data** and a **`test` block** for correctness.

---

## ðŸ§¾ TPC-H Query 2 â€” Minimum Cost Supplier

### âœ… **SQL Overview**

```sql
SELECT
  s_acctbal, s_name, n_name, p_partkey, p_mfgr,
  s_address, s_phone, s_comment
FROM
  part, supplier, partsupp, nation, region
WHERE
  p_partkey = ps_partkey
  AND s_suppkey = ps_suppkey
  AND p_size = :size
  AND p_type LIKE '%BRASS'
  AND s_nationkey = n_nationkey
  AND n_regionkey = r_regionkey
  AND r_name = 'EUROPE'
  AND ps_supplycost = (
    SELECT MIN(ps_supplycost)
    FROM partsupp, supplier, nation, region
    WHERE p_partkey = ps_partkey
      AND s_suppkey = ps_suppkey
      AND s_nationkey = n_nationkey
      AND n_regionkey = r_regionkey
      AND r_name = 'EUROPE'
  )
ORDER BY
  s_acctbal DESC, n_name, s_name, p_partkey
```

### ðŸ§  Purpose

> Find supplier(s) in Europe who offer the minimum supply cost for parts of a certain size and type ("BRASS").

---

## ðŸ¦Š Mochi Version â€” Inline + Test

We simulate a small world with:

* 2 regions: `EUROPE`, `ASIA`
* 2 nations
* 2 suppliers
* 2 parts
* 2 partsupps

### ðŸ§¾ **Mochi Code**

```mochi
let region = [
  { r_regionkey: 1, r_name: "EUROPE" },
  { r_regionkey: 2, r_name: "ASIA" }
]

let nation = [
  { n_nationkey: 10, n_regionkey: 1, n_name: "FRANCE" },
  { n_nationkey: 20, n_regionkey: 2, n_name: "CHINA" }
]

let supplier = [
  {
    s_suppkey: 100,
    s_name: "BestSupplier",
    s_address: "123 Rue",
    s_nationkey: 10,
    s_phone: "123",
    s_acctbal: 1000.0,
    s_comment: "Fast and reliable"
  },
  {
    s_suppkey: 200,
    s_name: "AltSupplier",
    s_address: "456 Way",
    s_nationkey: 20,
    s_phone: "456",
    s_acctbal: 500.0,
    s_comment: "Slow"
  }
]

let part = [
  { p_partkey: 1000, p_type: "LARGE BRASS", p_size: 15, p_mfgr: "M1" },
  { p_partkey: 2000, p_type: "SMALL COPPER", p_size: 15, p_mfgr: "M2" }
]

let partsupp = [
  { ps_partkey: 1000, ps_suppkey: 100, ps_supplycost: 10.00 },
  { ps_partkey: 1000, ps_suppkey: 200, ps_supplycost: 15.00 }
]

let europe_nations =
  from r in region
  where r.r_name == "EUROPE"
  join n in nation on n.n_regionkey == r.r_regionkey
  select n

let europe_suppliers =
  from s in supplier
  join n in europe_nations on s.s_nationkey == n.n_nationkey
  select { s: s, n: n }

let target_parts =
  from p in part
  where p.p_size == 15 and p.p_type has "BRASS"
  select p

let target_partsupp =
  from ps in partsupp
  join p in target_parts on ps.ps_partkey == p.p_partkey
  join s in europe_suppliers on ps.ps_suppkey == s.s.s_suppkey
  select {
    s_acctbal: s.s.s_acctbal,
    s_name: s.s.s_name,
    n_name: s.n.n_name,
    p_partkey: p.p_partkey,
    p_mfgr: p.p_mfgr,
    s_address: s.s.s_address,
    s_phone: s.s.s_phone,
    s_comment: s.s.s_comment,
    ps_supplycost: ps.ps_supplycost
  }

let min_cost =
  min(x.ps_supplycost for x in target_partsupp)

let result =
  from x in target_partsupp
  where x.ps_supplycost == min_cost
  order by { x.s_acctbal desc, x.n_name, x.s_name, x.p_partkey }
  select x

print result

test "Q2 returns only supplier with min cost in Europe for brass part" {
  expect result == [
    {
      s_acctbal: 1000.0,
      s_name: "BestSupplier",
      n_name: "FRANCE",
      p_partkey: 1000,
      p_mfgr: "M1",
      s_address: "123 Rue",
      s_phone: "123",
      s_comment: "Fast and reliable",
      ps_supplycost: 10.0
    }
  ]
}
```

---

### ðŸ§  Key Concepts Used

* `join` across 5 tables (region â†’ nation â†’ supplier â†’ partsupp â†’ part)
* `min(...)` supply cost
* Final filter to select **only** suppliers with that min cost
* Use of `has` for `LIKE '%BRASS'`

---

Want the next query (Q3) or a version with larger test cases and multiple min-cost matches?
