Letâ€™s move on to **TPC-H Query 11**, which is short but interesting â€” it identifies **important stock items** for a given nation by comparing value contribution to the total.

---

## ðŸ§¾ TPC-H Query 11 â€” Important Stock Identification

### âœ… **SQL Overview**

```sql
SELECT
  ps_partkey,
  SUM(ps_supplycost * ps_availqty) AS value
FROM
  partsupp,
  supplier,
  nation
WHERE
  ps_suppkey = s_suppkey
  AND s_nationkey = n_nationkey
  AND n_name = ':nation'
GROUP BY
  ps_partkey
HAVING
  SUM(ps_supplycost * ps_availqty) > (
    SELECT SUM(ps_supplycost * ps_availqty) * 0.0001
    FROM
      partsupp,
      supplier,
      nation
    WHERE
      ps_suppkey = s_suppkey
      AND s_nationkey = n_nationkey
      AND n_name = ':nation'
  )
ORDER BY
  value DESC;
```

### ðŸ§  Purpose

> For a given nation (e.g., `'GERMANY'`), list parts that represent a **significant total value** in stock (more than 0.01% of the total).

---

## ðŸ¦Š Mochi Version â€” Inline + Test

We simulate:

* 2 suppliers in GERMANY
* 3 parts, 4 partsupps
* Only the highest-value part should pass the threshold

---

### ðŸ§¾ **Mochi Code**

```mochi
let nation = [
  { n_nationkey: 1, n_name: "GERMANY" },
  { n_nationkey: 2, n_name: "FRANCE" }
]

let supplier = [
  { s_suppkey: 100, s_nationkey: 1 },
  { s_suppkey: 200, s_nationkey: 1 },
  { s_suppkey: 300, s_nationkey: 2 }
]

let partsupp = [
  { ps_partkey: 1000, ps_suppkey: 100, ps_supplycost: 10.0, ps_availqty: 100 }, // 1000
  { ps_partkey: 1000, ps_suppkey: 200, ps_supplycost: 20.0, ps_availqty: 50 },  // 1000
  { ps_partkey: 2000, ps_suppkey: 100, ps_supplycost: 5.0, ps_availqty: 10 },   // 50
  { ps_partkey: 3000, ps_suppkey: 300, ps_supplycost: 8.0, ps_availqty: 500 }   // FRANCE
]

let target_nation = "GERMANY"

let filtered =
  from ps in partsupp
  join s in supplier on s.s_suppkey == ps.ps_suppkey
  join n in nation on n.n_nationkey == s.s_nationkey
  where n.n_name == target_nation
  let value = ps.ps_supplycost * ps.ps_availqty
  select { ps.ps_partkey, value }

let grouped =
  from x in filtered
  group by x.ps_partkey
  select { ps_partkey: x.ps_partkey, value: sum(x.value) }

let total =
  sum(x.value for x in filtered)

let threshold = total * 0.0001

let result =
  from x in grouped
  where x.value > threshold
  order by x.value desc
  select x

print result

test "Q11 returns high-value partkeys from GERMANY" {
  expect result == [
    { ps_partkey: 1000, value: 2000.0 },
    { ps_partkey: 2000, value: 50.0 }
  ]
}
```

---

### âœ… Explanation

| Partkey   | Value                 |
| --------- | --------------------- |
| 1000      | 1000 + 1000 = 2000.0  |
| 2000      | 5 Ã— 10 = 50.0         |
| Total     | 2050.0                |
| Threshold | 0.0001 Ã— 2050 = 0.205 |

So both parts pass the threshold of 0.205.

Part 3000 is ignored (supplier is in **FRANCE**).

---

Want to continue to **Query 12**, which counts **late shipments by ship mode and order priority**?
