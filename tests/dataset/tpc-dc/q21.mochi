// Inventory ratio before and after a target date

type Inventory { inv_item_sk: int, inv_warehouse_sk: int, inv_date_sk: int, inv_quantity_on_hand: int }
type Warehouse { w_warehouse_sk: int, w_warehouse_name: string }
type Item { i_item_sk: int, i_item_id: string }
type DateDim { d_date_sk: int, d_date: string }

let inventory = [
  // ITEM1 in Main warehouse (qualifies)
  { inv_item_sk: 1, inv_warehouse_sk: 1, inv_date_sk: 1, inv_quantity_on_hand: 30 },
  { inv_item_sk: 1, inv_warehouse_sk: 1, inv_date_sk: 2, inv_quantity_on_hand: 40 },
  // ITEM1 in Secondary warehouse - ratio too high
  { inv_item_sk: 1, inv_warehouse_sk: 2, inv_date_sk: 1, inv_quantity_on_hand: 100 },
  { inv_item_sk: 1, inv_warehouse_sk: 2, inv_date_sk: 2, inv_quantity_on_hand: 200 },
  // ITEM2 in Main warehouse - ratio too high
  { inv_item_sk: 2, inv_warehouse_sk: 1, inv_date_sk: 1, inv_quantity_on_hand: 10 },
  { inv_item_sk: 2, inv_warehouse_sk: 1, inv_date_sk: 2, inv_quantity_on_hand: 40 }
]

let warehouse = [
  { w_warehouse_sk: 1, w_warehouse_name: "Main" },
  { w_warehouse_sk: 2, w_warehouse_name: "Secondary" }
]
let item = [
  { i_item_sk: 1, i_item_id: "ITEM1" },
  { i_item_sk: 2, i_item_id: "ITEM2" }
]
let date_dim = [
  { d_date_sk: 1, d_date: "2000-03-01" },
  { d_date_sk: 2, d_date: "2000-03-20" },
  { d_date_sk: 3, d_date: "2000-04-10" }
]

let before =
  from inv in inventory
  join d in date_dim on inv.inv_date_sk == d.d_date_sk
  where d.d_date < "2000-03-15"
  group by { w: inv.inv_warehouse_sk, i: inv.inv_item_sk } into g
  select { w: g.key.w, i: g.key.i, qty: sum(from x in g select x.inv_quantity_on_hand) }

let after =
  from inv in inventory
  join d in date_dim on inv.inv_date_sk == d.d_date_sk
  where d.d_date >= "2000-03-15"
  group by { w: inv.inv_warehouse_sk, i: inv.inv_item_sk } into g
  select { w: g.key.w, i: g.key.i, qty: sum(from x in g select x.inv_quantity_on_hand) }

let result =
  from b in before
  join a in after on b.w == a.w && b.i == a.i
  join w in warehouse on w.w_warehouse_sk == b.w
  join it in item on it.i_item_sk == b.i
  let ratio = a.qty / b.qty
  where ratio >= (2.0 / 3.0) && ratio <= (3.0 / 2.0)
  sort by [w.w_warehouse_name, it.i_item_id]
  select { w_warehouse_name: w.w_warehouse_name, i_item_id: it.i_item_id, inv_before: b.qty, inv_after: a.qty }

json(result)

test "TPCDC Q21 inventory ratio" {
  expect result == [
    { w_warehouse_name: "Main", i_item_id: "ITEM1", inv_before: 30, inv_after: 40 }
  ]
}
