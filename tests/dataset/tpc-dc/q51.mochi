let date_dim = [
  {date_sk: 1, month_seq: 1},
  {date_sk: 2, month_seq: 2},
  {date_sk: 3, month_seq: 3},
  {date_sk: 4, month_seq: 4},
  {date_sk: 5, month_seq: 5}
]

let web_sales = [
  {item_sk: 1, sold_date: 1, price: 10},
  {item_sk: 1, sold_date: 2, price: 15},
  {item_sk: 1, sold_date: 3, price: 10},
  {item_sk: 1, sold_date: 4, price: 5},
  {item_sk: 1, sold_date: 5, price: 20}
]

let store_sales = [
  {item_sk: 1, sold_date: 1, price: 5},
  {item_sk: 1, sold_date: 2, price: 5},
  {item_sk: 1, sold_date: 3, price: 10},
  {item_sk: 1, sold_date: 4, price: 10},
  {item_sk: 1, sold_date: 5, price: 15}
]

// Aggregate sales by date
let ws_daily =
  from ws in web_sales
  join d in date_dim on ws.sold_date == d.date_sk
  group by {date: d.date_sk} into g
  sort by g.key.date
  select {date: g.key.date, sales: sum(from x in g select x.ws.price)}

let ss_daily =
  from ss in store_sales
  join d in date_dim on ss.sold_date == d.date_sk
  group by {date: d.date_sk} into g
  sort by g.key.date
  select {date: g.key.date, sales: sum(from x in g select x.ss.price)}

// Compute cumulative sums
var ws_running = []
var ws_total = 0
for r in ws_daily {
  ws_total = ws_total + r.sales
  ws_running = ws_running + [{date:r.date, total:ws_total}]
}

var ss_running = []
var ss_total = 0
for r in ss_daily {
  ss_total = ss_total + r.sales
  ss_running = ss_running + [{date:r.date, total:ss_total}]
}

var result = []
for w in ws_running {
  var s_total = 0
  for s in ss_running { if s.date == w.date { s_total = s.total } }
  result = result + [{item_sk:1, d_date:w.date, web_sales:w.total, store_sales:s_total}]
}

json(result)

test "TPCDC Q51 cumulative" {
  expect result == [
    {item_sk:1, d_date:1, web_sales:10, store_sales:5},
    {item_sk:1, d_date:2, web_sales:25, store_sales:10},
    {item_sk:1, d_date:3, web_sales:35, store_sales:20},
    {item_sk:1, d_date:4, web_sales:40, store_sales:30},
    {item_sk:1, d_date:5, web_sales:60, store_sales:45}
  ]
}
