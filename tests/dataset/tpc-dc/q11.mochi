let customer = [
  {c_customer_sk: 1, c_customer_id: "C1", c_first_name: "Alice", c_last_name: "Smith", c_preferred_cust_flag: "Y", c_birth_country: "US", c_login: "alice", c_email_address: "alice@example.com"},
  {c_customer_sk: 2, c_customer_id: "C2", c_first_name: "Bob", c_last_name: "Jones", c_preferred_cust_flag: "N", c_birth_country: "US", c_login: "bob", c_email_address: "bob@example.com"}
]

let store_sales = [
  {ss_customer_sk: 1, ss_sold_date_sk: 1, ss_ext_list_price: 100.0, ss_ext_discount_amt: 0.0},
  {ss_customer_sk: 1, ss_sold_date_sk: 2, ss_ext_list_price: 120.0, ss_ext_discount_amt: 0.0},
  {ss_customer_sk: 2, ss_sold_date_sk: 1, ss_ext_list_price: 100.0, ss_ext_discount_amt: 0.0},
  {ss_customer_sk: 2, ss_sold_date_sk: 2, ss_ext_list_price: 150.0, ss_ext_discount_amt: 0.0}
]

let web_sales = [
  {ws_bill_customer_sk: 1, ws_sold_date_sk: 1, ws_ext_list_price: 100.0, ws_ext_discount_amt: 0.0},
  {ws_bill_customer_sk: 1, ws_sold_date_sk: 2, ws_ext_list_price: 150.0, ws_ext_discount_amt: 0.0},
  {ws_bill_customer_sk: 2, ws_sold_date_sk: 1, ws_ext_list_price: 100.0, ws_ext_discount_amt: 0.0},
  {ws_bill_customer_sk: 2, ws_sold_date_sk: 2, ws_ext_list_price: 100.0, ws_ext_discount_amt: 0.0}
]

let date_dim = [
  {d_date_sk: 1, d_year: 1998},
  {d_date_sk: 2, d_year: 1999}
]

let store_totals =
  from c in customer
  join ss in store_sales on c.c_customer_sk == ss.ss_customer_sk
  join d in date_dim on ss.ss_sold_date_sk == d.d_date_sk
  group by {id: c.c_customer_id, first: c.c_first_name, last: c.c_last_name, flag: c.c_preferred_cust_flag, year: d.d_year} into g
  select {
    customer_id: g.key.id,
    customer_first_name: g.key.first,
    customer_last_name: g.key.last,
    customer_preferred_cust_flag: g.key.flag,
    dyear: g.key.year,
    year_total: sum(from x in g select x.ss_ext_list_price - x.ss_ext_discount_amt)
  }

let web_totals =
  from c in customer
  join ws in web_sales on c.c_customer_sk == ws.ws_bill_customer_sk
  join d in date_dim on ws.ws_sold_date_sk == d.d_date_sk
  group by {id: c.c_customer_id, first: c.c_first_name, last: c.c_last_name, flag: c.c_preferred_cust_flag, year: d.d_year} into g
  select {
    customer_id: g.key.id,
    customer_first_name: g.key.first,
    customer_last_name: g.key.last,
    customer_preferred_cust_flag: g.key.flag,
    dyear: g.key.year,
    year_total: sum(from x in g select x.ws_ext_list_price - x.ws_ext_discount_amt)
  }

let result =
  from s1 in store_totals
  join s2 in store_totals on s1.customer_id == s2.customer_id && s2.dyear == 1999
  join w1 in web_totals on s1.customer_id == w1.customer_id && w1.dyear == 1998
  join w2 in web_totals on s1.customer_id == w2.customer_id && w2.dyear == 1999
  where s1.dyear == 1998 &&
        s1.year_total > 0 && w1.year_total > 0 &&
        (w2.year_total / w1.year_total) > (s2.year_total / s1.year_total)
  sort by [s2.customer_id, s2.customer_first_name, s2.customer_last_name, s2.customer_preferred_cust_flag]
  select {
    customer_id: s2.customer_id,
    customer_first_name: s2.customer_first_name,
    customer_last_name: s2.customer_last_name,
    customer_preferred_cust_flag: s2.customer_preferred_cust_flag
  }

json(result)

test "TPCDC Q11 ratio" {
  expect result == [
    {customer_id: "C1", customer_first_name: "Alice", customer_last_name: "Smith", customer_preferred_cust_flag: "Y"}
  ]
}
