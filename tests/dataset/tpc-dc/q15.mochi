let customer = [
  {c_customer_sk: 1, c_current_addr_sk: 1},
  {c_customer_sk: 2, c_current_addr_sk: 2},
  {c_customer_sk: 3, c_current_addr_sk: 3}
]

let customer_address = [
  {ca_address_sk: 1, ca_zip: "85669", ca_state: "TX"},
  {ca_address_sk: 2, ca_zip: "00000", ca_state: "CA"},
  {ca_address_sk: 3, ca_zip: "99999", ca_state: "FL"}
]

let catalog_sales = [
  {cs_bill_customer_sk: 1, cs_sold_date_sk: 1, cs_sales_price: 100.0},
  {cs_bill_customer_sk: 2, cs_sold_date_sk: 1, cs_sales_price: 50.0},
  {cs_bill_customer_sk: 3, cs_sold_date_sk: 1, cs_sales_price: 600.0}
]

let date_dim = [{d_date_sk: 1, d_qoy: 2, d_year: 2001}]

let result =
  from cs in catalog_sales
  join c in customer on cs.cs_bill_customer_sk == c.c_customer_sk
  join ca in customer_address on c.c_current_addr_sk == ca.ca_address_sk
  join d in date_dim on cs.cs_sold_date_sk == d.d_date_sk
  where (
    substr(ca.ca_zip, 0, 5) in ["85669","86197","88274","83405","86475","85392","85460","80348","81792"] ||
    ca.ca_state in ["CA","WA","GA"] ||
    cs.cs_sales_price > 500.0
  ) &&
        d.d_qoy == 2 && d.d_year == 2001
  group by {zip: ca.ca_zip} into g
  sort by g.key.zip
  select {ca_zip: g.key.zip, total: sum(from x in g select x.cs_sales_price)}
  |> to_list

json(result)

test "TPCDC Q15 catalog sales" {
  expect result == [
    {ca_zip: "00000", total: 50.0},
    {ca_zip: "85669", total: 100.0},
    {ca_zip: "99999", total: 600.0}
  ]
}
