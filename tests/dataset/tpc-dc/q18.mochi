let catalog_sales = [
  {cs_sold_date_sk: 1, cs_item_sk: 1, cs_bill_cdemo_sk: 1, cs_bill_customer_sk: 1,
   cs_quantity: 10.0, cs_list_price: 20.0, cs_coupon_amt: 2.0, cs_sales_price: 18.0, cs_net_profit: 5.0}
]

let customer_demographics = [
  {cd_demo_sk: 1, cd_gender: "F", cd_education_status: "Unknown"},
  {cd_demo_sk: 2}
]

let customer = [
  {c_customer_sk: 1, c_current_cdemo_sk: 2, c_current_addr_sk: 1, c_birth_year: 1990, c_birth_month: 1}
]

let customer_address = [
  {ca_address_sk: 1, ca_country: "US", ca_state: "MS", ca_county: "C1"}
]

let date_dim = [{d_date_sk: 1, d_year: 1998}]
let item = [{i_item_sk: 1, i_item_id: "ITEM1"}]

let rows =
  from cs in catalog_sales
  join cd1 in customer_demographics on cs.cs_bill_cdemo_sk == cd1.cd_demo_sk
  join c in customer on cs.cs_bill_customer_sk == c.c_customer_sk
  join cd2 in customer_demographics on c.c_current_cdemo_sk == cd2.cd_demo_sk
  join ca in customer_address on c.c_current_addr_sk == ca.ca_address_sk
  join d in date_dim on cs.cs_sold_date_sk == d.d_date_sk
  join i in item on cs.cs_item_sk == i.i_item_sk
  where cd1.cd_gender == "F" && cd1.cd_education_status == "Unknown" &&
        c.c_birth_month in [1,6,8,9,12,2] &&
        d.d_year == 1998 &&
        ca.ca_state in ["MS","IN","ND","OK","NM","VA","MS"]
  group by {item: i.i_item_id, country: ca.ca_country, state: ca.ca_state, county: ca.ca_county} into g
  select {
    i_item_id: g.key.item,
    ca_country: g.key.country,
    ca_state: g.key.state,
    ca_county: g.key.county,
    agg1: avg(from x in g select x.cs_quantity),
    agg2: avg(from x in g select x.cs_list_price),
    agg3: avg(from x in g select x.cs_coupon_amt),
    agg4: avg(from x in g select x.cs_sales_price),
    agg5: avg(from x in g select x.cs_net_profit),
    agg6: avg(from x in g select float(c.c_birth_year)),
    agg7: avg(from x in g select float(cd1.cd_dep_count ?? 0))
  }
  |> to_list

json(rows)

test "TPCDC Q18 averages" {
  expect rows == [
    {
      i_item_id: "ITEM1",
      ca_country: "US",
      ca_state: "MS",
      ca_county: "C1",
      agg1: 10.0,
      agg2: 20.0,
      agg3: 2.0,
      agg4: 18.0,
      agg5: 5.0,
      agg6: 1990.0,
      agg7: 0.0
    }
  ]
}
