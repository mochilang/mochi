let item=[{i_item_sk:1, i_category:"Cat", i_brand:"Brand"}]
let call_center=[{cc_call_center_sk:1, cc_name:"CC"}]
let date_dim=[
  {d_date_sk:1, d_year:2000, d_moy:1},
  {d_date_sk:2, d_year:2000, d_moy:2},
  {d_date_sk:3, d_year:2000, d_moy:3}
]
let catalog_sales=[
  {cs_item_sk:1, cs_sold_date_sk:1, cs_call_center_sk:1, cs_sales_price:100},
  {cs_item_sk:1, cs_sold_date_sk:1, cs_call_center_sk:1, cs_sales_price:50},
  {cs_item_sk:1, cs_sold_date_sk:2, cs_call_center_sk:1, cs_sales_price:200},
  {cs_item_sk:1, cs_sold_date_sk:3, cs_call_center_sk:1, cs_sales_price:180}
]

let monthly=
  from cs in catalog_sales
  join i in item on cs.cs_item_sk == i.i_item_sk
  join d in date_dim on cs.cs_sold_date_sk == d.d_date_sk
  join cc in call_center on cs.cs_call_center_sk == cc.cc_call_center_sk
  group by {cat:i.i_category, brand:i.i_brand, cc:cc.cc_name, year:d.d_year, moy:d.d_moy} into g
  select {i_category:g.key.cat, i_brand:g.key.brand, cc_name:g.key.cc, d_year:g.key.year, d_moy:g.key.moy, sum_sales: sum(from x in g select x.cs.cs_sales_price)}

let yearly=
  from m in monthly
  group by {cat:m.i_category, brand:m.i_brand, cc:m.cc_name, year:m.d_year} into g
  select {cat:g.key.cat, brand:g.key.brand, cc:g.key.cc, year:g.key.year, avg_sales: avg(from x in g select x.sum_sales), months: from x in g select {moy:x.d_moy, sum_sales:x.sum_sales}}

var v1 = []
for y in yearly {
  var sorted = sort(y.months, fn a,b -> a.moy < b.moy end)
  var rn = 1
  for m in sorted {
    v1 = v1 + [{
      i_category:y.cat,
      i_brand:y.brand,
      cc_name:y.cc,
      d_year:y.year,
      d_moy:m.moy,
      sum_sales:m.sum_sales,
      avg_monthly_sales:y.avg_sales,
      rn:rn
    }]
    rn = rn + 1
  }
}

let result =
  from r in v1
  where r.d_year == 2000 && r.avg_monthly_sales > 0 && abs(r.sum_sales - r.avg_monthly_sales)/r.avg_monthly_sales > 0.1
  select {cc_name:r.cc_name, sum_sales:r.sum_sales, avg_monthly_sales:r.avg_monthly_sales}

json(result)

test "TPCDC Q57 call center" {
  expect result == [
    {cc_name:"CC", sum_sales:150, avg_monthly_sales:176.66666666666666},
    {cc_name:"CC", sum_sales:200, avg_monthly_sales:176.66666666666666}
  ]
}
