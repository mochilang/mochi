// Simplified cross_sales dataset for TPC-DC Q64
let cross_sales = [
  { product_name: "P1", item_sk: 1, store_name: "Store1", store_zip: "10001",
    b_street_number: "10", b_streen_name: "Main", b_city: "CityA", b_zip: "Z1",
    c_street_number: "20", c_street_name: "Second", c_city: "CityB", c_zip: "Z2",
    syear: 1999, cnt: 5, s1: 10, s2: 20, s3: 5 },
  { product_name: "P1", item_sk: 1, store_name: "Store1", store_zip: "10001",
    b_street_number: "10", b_streen_name: "Main", b_city: "CityA", b_zip: "Z1",
    c_street_number: "20", c_street_name: "Second", c_city: "CityB", c_zip: "Z2",
    syear: 2000, cnt: 4, s1: 8, s2: 18, s3: 4 },
  { product_name: "P2", item_sk: 2, store_name: "Store1", store_zip: "10001",
    b_street_number: "10", b_streen_name: "Main", b_city: "CityA", b_zip: "Z1",
    c_street_number: "20", c_street_name: "Second", c_city: "CityB", c_zip: "Z2",
    syear: 1999, cnt: 6, s1: 12, s2: 24, s3: 6 },
  { product_name: "P2", item_sk: 2, store_name: "Store1", store_zip: "10001",
    b_street_number: "10", b_streen_name: "Main", b_city: "CityA", b_zip: "Z1",
    c_street_number: "20", c_street_name: "Second", c_city: "CityB", c_zip: "Z2",
    syear: 2000, cnt: 5, s1: 10, s2: 22, s3: 5 }
]

let result =
  from cs1 in cross_sales
  join cs2 in cross_sales on cs1.item_sk == cs2.item_sk
  where cs1.syear == 1999 && cs2.syear == 2000 &&
        cs2.cnt <= cs1.cnt &&
        cs1.store_name == cs2.store_name &&
        cs1.store_zip == cs2.store_zip
  sort by cs1.product_name, cs1.store_name, cs2.cnt
  select {
    product_name: cs1.product_name,
    store_name: cs1.store_name,
    store_zip: cs1.store_zip,
    b_street_number: cs1.b_street_number,
    b_streen_name: cs1.b_streen_name,
    b_city: cs1.b_city,
    b_zip: cs1.b_zip,
    c_street_number: cs1.c_street_number,
    c_street_name: cs1.c_street_name,
    c_city: cs1.c_city,
    c_zip: cs1.c_zip,
    syear: cs1.syear,
    cnt: cs1.cnt,
    s1: cs1.s1,
    s2: cs1.s2,
    s3: cs1.s3,
    s1_2: cs2.s1,
    s2_2: cs2.s2,
    s3_2: cs2.s3,
    syear_2: cs2.syear,
    cnt_2: cs2.cnt
  }

json(result)

test "TPCDC Q64 compare cross year sales" {
  expect result == [
    {
      product_name: "P1", store_name: "Store1", store_zip: "10001",
      b_street_number: "10", b_streen_name: "Main", b_city: "CityA", b_zip: "Z1",
      c_street_number: "20", c_street_name: "Second", c_city: "CityB", c_zip: "Z2",
      syear: 1999, cnt: 5, s1: 10, s2: 20, s3: 5,
      s1_2: 8, s2_2: 18, s3_2: 4, syear_2: 2000, cnt_2: 4
    },
    {
      product_name: "P2", store_name: "Store1", store_zip: "10001",
      b_street_number: "10", b_streen_name: "Main", b_city: "CityA", b_zip: "Z1",
      c_street_number: "20", c_street_name: "Second", c_city: "CityB", c_zip: "Z2",
      syear: 1999, cnt: 6, s1: 12, s2: 24, s3: 6,
      s1_2: 10, s2_2: 22, s3_2: 5, syear_2: 2000, cnt_2: 5
    }
  ]
}
