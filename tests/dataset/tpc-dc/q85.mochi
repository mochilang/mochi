let web_sales = [
  { ws_item_sk: 1, ws_order_number: 100, ws_quantity: 2, ws_sales_price: 120.0, ws_net_profit: 180.0, ws_web_page_sk: 1, ws_sold_date_sk: 1 }
]

let web_returns = [
  { wr_item_sk: 1, wr_order_number: 100, wr_refunded_cash: 50.0, wr_fee: 2.0, wr_refunded_cdemo_sk: 1, wr_returning_cdemo_sk: 1, wr_refunded_addr_sk: 1, wr_reason_sk: 1 }
]

let web_page = [
  { wp_web_page_sk: 1 }
]

let customer_demographics = [
  { cd_demo_sk: 1, cd_marital_status: "M", cd_education_status: "E1" }
]

let customer_address = [
  { ca_address_sk: 1, ca_country: "United States", ca_state: "CA" }
]

let date_dim = [
  { d_date_sk: 1, d_year: 2000 }
]

let reason = [
  { r_reason_sk: 1, r_reason_desc: "ReasonA" }
]

let result =
  from ws in web_sales
  join wr in web_returns on ws.ws_item_sk == wr.wr_item_sk && ws.ws_order_number == wr.wr_order_number
  join wp in web_page on ws.ws_web_page_sk == wp.wp_web_page_sk
  join cd1 in customer_demographics on wr.wr_refunded_cdemo_sk == cd1.cd_demo_sk
  join cd2 in customer_demographics on wr.wr_returning_cdemo_sk == cd2.cd_demo_sk
  join ca in customer_address on wr.wr_refunded_addr_sk == ca.ca_address_sk
  join d in date_dim on ws.ws_sold_date_sk == d.d_date_sk
  join r in reason on wr.wr_reason_sk == r.r_reason_sk
  where d.d_year == 2000 && cd1.cd_marital_status == "M" && cd2.cd_marital_status == "M" &&
        cd1.cd_education_status == "E1" && cd2.cd_education_status == "E1" &&
        ws.ws_sales_price >= 100.0 && ws.ws_sales_price <= 150.0 &&
        ca.ca_country == "United States" && ca.ca_state == "CA" &&
        ws.ws_net_profit >= 100 && ws.ws_net_profit <= 200
  group by substr(r.r_reason_desc,0,20) into g
  select {
    reason: g.key,
    avg_ws_quantity: avg(from x in g select x.ws.ws_quantity),
    avg_wr_refunded_cash: avg(from x in g select x.wr.wr_refunded_cash),
    avg_wr_fee: avg(from x in g select x.wr.wr_fee)
  }
  |> to_list

json(result)

test "TPCDC Q85 averages" {
  expect result == [
    { reason: "ReasonA", avg_ws_quantity: 2.0, avg_wr_refunded_cash: 50.0, avg_wr_fee: 2.0 }
  ]
}
