let store_sales = [
  { ss_sold_date_sk: 1, ss_customer_sk: 1 },
  { ss_sold_date_sk: 1, ss_customer_sk: 2 }
]

let catalog_sales = [
  { cs_sold_date_sk: 1, cs_bill_customer_sk: 2 }
]

let web_sales = [
  { ws_sold_date_sk: 1, ws_bill_customer_sk: 3 }
]

let date_dim = [
  { d_date_sk: 1, d_month_seq: 1200 }
]

let dms = 1200

let store_customers =
  from ss in store_sales
  join d in date_dim on ss.ss_sold_date_sk == d.d_date_sk
  where d.d_month_seq >= dms && d.d_month_seq <= dms + 11
  select ss.ss_customer_sk
  |> distinct

let other_customers =
  concat(
    from cs in catalog_sales join d in date_dim on cs.cs_sold_date_sk == d.d_date_sk where d.d_month_seq >= dms && d.d_month_seq <= dms + 11 select cs.cs_bill_customer_sk,
    from ws in web_sales join d in date_dim on ws.ws_sold_date_sk == d.d_date_sk where d.d_month_seq >= dms && d.d_month_seq <= dms + 11 select ws.ws_bill_customer_sk
  )
  |> distinct

let diff =
  from c in store_customers
  where !contains(other_customers, c)
  select c
  |> to_list

let result = len(diff)

json(result)

test "TPCDC Q87 diff" {
  expect result == 1
}
