// Simplified TPC-DC Q4
let customer = [
  {c_customer_sk: 1, c_customer_id: "C1"},
  {c_customer_sk: 2, c_customer_id: "C2"}
]
let store_sales = [
  {ss_customer_sk: 1, ss_sold_date_sk: 1, ss_ext_list_price: 100, ss_ext_wholesale_cost: 60, ss_ext_discount_amt: 10, ss_ext_sales_price: 120}
]
let catalog_sales = [
  {cs_bill_customer_sk: 1, cs_sold_date_sk: 1, cs_ext_list_price: 50, cs_ext_wholesale_cost: 30, cs_ext_discount_amt: 5, cs_ext_sales_price: 70}
]
let web_sales = [
  {ws_bill_customer_sk: 1, ws_sold_date_sk: 2, ws_ext_list_price: 60, ws_ext_wholesale_cost: 40, ws_ext_discount_amt: 6, ws_ext_sales_price: 80}
]
let date_dim = [
  {d_date_sk: 1, d_year: 1998},
  {d_date_sk: 2, d_year: 1999}
]

let entries =
  from ss in store_sales
  join d in date_dim on ss.ss_sold_date_sk == d.d_date_sk
  select {customer: ss.ss_customer_sk, year: d.d_year, val: ((ss.ss_ext_list_price - ss.ss_ext_wholesale_cost - ss.ss_ext_discount_amt) + ss.ss_ext_sales_price)/2}
  union all
  from cs in catalog_sales
  join d in date_dim on cs.cs_sold_date_sk == d.d_date_sk
  select {customer: cs.cs_bill_customer_sk, year: d.d_year, val: ((cs.cs_ext_list_price - cs.cs_ext_wholesale_cost - cs.cs_ext_discount_amt) + cs.cs_ext_sales_price)/2}
  union all
  from ws in web_sales
  join d in date_dim on ws.ws_sold_date_sk == d.d_date_sk
  select {customer: ws.ws_bill_customer_sk, year: d.d_year, val: ((ws.ws_ext_list_price - ws.ws_ext_wholesale_cost - ws.ws_ext_discount_amt) + ws.ws_ext_sales_price)/2}

let year_total =
  from e in entries
  group by {customer_sk: e.customer, year: e.year} into g
  select {
    customer_sk: g.key.customer_sk,
    year: g.key.year,
    year_total: sum(from x in g select x.val)
  }

let result =
  from yt in year_total
  join c in customer on yt.customer_sk == c.c_customer_sk
  sort by c.c_customer_id, yt.year
  select {c_customer_id: c.c_customer_id, year: yt.year, total: yt.year_total}

json(result)

test "TPCDC Q4 sample" {
  expect result == [
    {c_customer_id: "C1", year: 1998, total: 117.5},
    {c_customer_id: "C1", year: 1999, total: 47}
  ]
}
