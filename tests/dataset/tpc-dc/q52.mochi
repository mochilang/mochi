let date_dim = [
  {date_sk: 1, year: 2000, month: 1},
  {date_sk: 2, year: 2000, month: 1},
  {date_sk: 3, year: 2000, month: 1}
]

let item = [
  {i_item_sk: 100, i_brand_id: 1, i_brand: "BrandA", i_manager_id: 1},
  {i_item_sk: 101, i_brand_id: 2, i_brand: "BrandB", i_manager_id: 1},
  {i_item_sk: 102, i_brand_id: 3, i_brand: "BrandC", i_manager_id: 1}
]

let store_sales = [
  {ss_item_sk: 100, ss_sold_date_sk: 1, ss_ext_sales_price: 100},
  {ss_item_sk: 100, ss_sold_date_sk: 2, ss_ext_sales_price: 50},
  {ss_item_sk: 101, ss_sold_date_sk: 1, ss_ext_sales_price: 50},
  {ss_item_sk: 101, ss_sold_date_sk: 2, ss_ext_sales_price: 25},
  {ss_item_sk: 102, ss_sold_date_sk: 3, ss_ext_sales_price: 75}
]

let result =
  from ss in store_sales
  join d in date_dim on ss.ss_sold_date_sk == d.date_sk
  join i in item on ss.ss_item_sk == i.i_item_sk
  where i.i_manager_id == 1 && d.year == 2000 && d.month == 1
  group by {year: d.year, brand_id: i.i_brand_id, brand: i.i_brand} into g
  select {d_year: g.key.year, brand_id: g.key.brand_id, brand: g.key.brand, ext_price: sum(from x in g select x.ss.ss_ext_sales_price)}
  order by {d_year: ascending, ext_price: descending, brand_id: ascending}

json(result)

test "TPCDC Q52 brand totals" {
  expect result == [
    {d_year:2000, brand_id:1, brand:"BrandA", ext_price:150},
    {d_year:2000, brand_id:2, brand:"BrandB", ext_price:75},
    {d_year:2000, brand_id:3, brand:"BrandC", ext_price:75}
  ]
}
