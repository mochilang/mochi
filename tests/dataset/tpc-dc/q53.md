# TPC-DC Query 53

Query extracted from the official TPC-DS specification.

## SQL
```sql
(select i_manufact_id,
 sum(ss_sales_price) sum_sales,
 avg(sum(ss_sales_price)) over (partition by i_manufact_id) avg_quarterly_sales
 from item, store_sales, date_dim, store
 where ss_item_sk = i_item_sk and
 ss_sold_date_sk = d_date_sk and
 ss_store_sk = s_store_sk and
d_month_seq in (1,2,3,4,5,6,7,8,9,10,11,12) and
 ((i_category in ('Books','Children','Electronics') and
 i_class in ('personal','portable','reference','self-help') and
 i_brand in ('scholaramalgamalg #14','scholaramalgamalg #7',
                 'exportiunivamalg #9','scholaramalgamalg #9'))
 or(i_category in ('Women','Music','Men') and
 i_class in ('accessories','classical','fragrances','pants') and
 i_brand in ('amalgimporto #1','edu packscholar #1','exportiimporto #1',
                 'importoamalg #1')))
 group by i_manufact_id, d_qoy ) tmp1
 where case when avg_quarterly_sales > 0
         then abs (sum_sales - avg_quarterly_sales)/ avg_quarterly_sales
         else null end > 0.1
 order by avg_quarterly_sales,
          sum_sales,
          i_manufact_id
LIMIT 100;
```

## Expected Output
Sample output from `q53.mochi` with two quarters of sales:
```json
[
  {"i_manufact_id":2, "sum_sales":80, "avg_quarterly_sales":120},
  {"i_manufact_id":2, "sum_sales":160, "avg_quarterly_sales":120},
  {"i_manufact_id":1, "sum_sales":150, "avg_quarterly_sales":225},
  {"i_manufact_id":1, "sum_sales":300, "avg_quarterly_sales":225},
  {"i_manufact_id":3, "sum_sales":160, "avg_quarterly_sales":80}
]
```
