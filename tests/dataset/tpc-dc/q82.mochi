let item = [
  { i_item_sk: 2, i_item_id: "I2", i_item_desc: "Item2", i_current_price: 55, i_manufact_id: 11 },
  { i_item_sk: 3, i_item_id: "I3", i_item_desc: "Item3", i_current_price: 65, i_manufact_id: 22 },
  { i_item_sk: 4, i_item_id: "I4", i_item_desc: "Item4", i_current_price: 70, i_manufact_id: 33 }
]

let inventory = [
  { inv_item_sk: 2, inv_date_sk: 1, inv_quantity_on_hand: 200 },
  { inv_item_sk: 3, inv_date_sk: 1, inv_quantity_on_hand: 150 },
  { inv_item_sk: 4, inv_date_sk: 1, inv_quantity_on_hand: 120 }
]

let date_dim = [
  { d_date_sk: 1, d_date: "2000-05-01" }
]

let store_sales = [
  { ss_item_sk: 2 },
  { ss_item_sk: 3 },
  { ss_item_sk: 3 },
  { ss_item_sk: 4 }
]

let result =
  from i in item
  join inv in inventory on inv.inv_item_sk == i.i_item_sk
  join d in date_dim on inv.inv_date_sk == d.d_date_sk
  join ss in store_sales on ss.ss_item_sk == i.i_item_sk
  where i.i_current_price >= 50 && i.i_current_price <= 80 &&
        inv.inv_quantity_on_hand >= 100 && inv.inv_quantity_on_hand <= 500
  group by { id: i.i_item_id, desc: i.i_item_desc, price: i.i_current_price } into g
  sort by g.key.id
  select { i_item_id: g.key.id, i_item_desc: g.key.desc, i_current_price: g.key.price }
  |> to_list

json(result)

test "TPCDC Q82 items" {
  expect result == [
    { i_item_id: "I2", i_item_desc: "Item2", i_current_price: 55 },
    { i_item_id: "I3", i_item_desc: "Item3", i_current_price: 65 },
    { i_item_id: "I4", i_item_desc: "Item4", i_current_price: 70 }
  ]
}
