let web_sales = [
  {ws_sold_date_sk: 1, ws_ext_sales_price: 100.0},
  {ws_sold_date_sk: 8, ws_ext_sales_price: 200.0}
]
let catalog_sales = [
  {cs_sold_date_sk: 1, cs_ext_sales_price: 50.0}
]
let date_dim = [
  {d_date_sk: 1, d_day_name: "Sunday", d_week_seq: 1, d_year: 2001},
  {d_date_sk: 8, d_day_name: "Sunday", d_week_seq: 1, d_year: 2002}
]

let wscs =
  from ws in web_sales
  select {sold_date_sk: ws.ws_sold_date_sk, sales_price: ws.ws_ext_sales_price}
  union all
  from cs in catalog_sales
  select {sold_date_sk: cs.cs_sold_date_sk, sales_price: cs.cs_ext_sales_price}

let wswscs =
  from w in wscs
  join d in date_dim on w.sold_date_sk == d.d_date_sk
  group by {week_seq: d.d_week_seq, year: d.d_year} into g
  select {
    week_seq: g.key.week_seq,
    year: g.key.year,
    sun_sales: sum(from x in g select x.sales_price)
  }

let y = from w in wswscs where w.year == 2001 select w
let z = from w in wswscs where w.year == 2002 select w

let result =
  from a in y
  join b in z on a.week_seq == b.week_seq
  select {d_week_seq: a.week_seq, sun_ratio: round(a.sun_sales / b.sun_sales, 2)}

json(result)

test "TPCDC Q2 weekly ratio" {
  expect result == [{d_week_seq: 1, sun_ratio: round(150.0 / 200.0, 2)}]
}
