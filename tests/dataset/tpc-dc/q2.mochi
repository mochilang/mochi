// Minimal schema for TPC-DS Q2
let web_sales = [
  {ws_sold_date_sk: 1, ws_ext_sales_price: 100.0},
  {ws_sold_date_sk: 2, ws_ext_sales_price: 50.0},
  {ws_sold_date_sk: 10, ws_ext_sales_price: 1.0},
  {ws_sold_date_sk: 11, ws_ext_sales_price: 1.0},
  {ws_sold_date_sk: 12, ws_ext_sales_price: 1.0},
  {ws_sold_date_sk: 13, ws_ext_sales_price: 1.0},
  {ws_sold_date_sk: 14, ws_ext_sales_price: 1.0}
]

let catalog_sales = [
  {cs_sold_date_sk: 8, cs_ext_sales_price: 200.0},
  {cs_sold_date_sk: 9, cs_ext_sales_price: 100.0}
]

let date_dim = [
  {d_date_sk: 1, d_week_seq: 1, d_year: 1998, d_day_name: "Sunday"},
  {d_date_sk: 2, d_week_seq: 1, d_year: 1998, d_day_name: "Monday"},
  {d_date_sk: 3, d_week_seq: 1, d_year: 1998, d_day_name: "Tuesday"},
  {d_date_sk: 4, d_week_seq: 1, d_year: 1998, d_day_name: "Wednesday"},
  {d_date_sk: 5, d_week_seq: 1, d_year: 1998, d_day_name: "Thursday"},
  {d_date_sk: 6, d_week_seq: 1, d_year: 1998, d_day_name: "Friday"},
  {d_date_sk: 7, d_week_seq: 1, d_year: 1998, d_day_name: "Saturday"},
  {d_date_sk: 8, d_week_seq: 54, d_year: 1999, d_day_name: "Sunday"},
  {d_date_sk: 9, d_week_seq: 54, d_year: 1999, d_day_name: "Monday"},
  {d_date_sk: 10, d_week_seq: 54, d_year: 1999, d_day_name: "Tuesday"},
  {d_date_sk: 11, d_week_seq: 54, d_year: 1999, d_day_name: "Wednesday"},
  {d_date_sk: 12, d_week_seq: 54, d_year: 1999, d_day_name: "Thursday"},
  {d_date_sk: 13, d_week_seq: 54, d_year: 1999, d_day_name: "Friday"},
  {d_date_sk: 14, d_week_seq: 54, d_year: 1999, d_day_name: "Saturday"}
]

let wscs =
  from ws in web_sales
  select {sold_date_sk: ws.ws_sold_date_sk, sales_price: ws.ws_ext_sales_price}
  union all
  from cs in catalog_sales
  select {sold_date_sk: cs.cs_sold_date_sk, sales_price: cs.cs_ext_sales_price}

let wswscs =
  from w in wscs
  join d in date_dim on w.sold_date_sk == d.d_date_sk
  group by {week_seq: d.d_week_seq} into g
  select {
    d_week_seq: g.key.week_seq,
    sun_sales: sum(from x in g where x.day == "Sunday" select x.sales_price),
    mon_sales: sum(from x in g where x.day == "Monday" select x.sales_price),
    tue_sales: sum(from x in g where x.day == "Tuesday" select x.sales_price),
    wed_sales: sum(from x in g where x.day == "Wednesday" select x.sales_price),
    thu_sales: sum(from x in g where x.day == "Thursday" select x.sales_price),
    fri_sales: sum(from x in g where x.day == "Friday" select x.sales_price),
    sat_sales: sum(from x in g where x.day == "Saturday" select x.sales_price)
  }

let wswscs_1998 =
  from w in wswscs
  join d in date_dim on w.d_week_seq == d.d_week_seq
  where d.d_year == 1998
  select w

let wswscs_1999 =
  from w in wswscs
  join d in date_dim on w.d_week_seq == d.d_week_seq
  where d.d_year == 1999
  select w

let result =
  from y in wswscs_1998
  join z in wswscs_1999 on y.d_week_seq == z.d_week_seq - 53
  select {
    d_week_seq1: y.d_week_seq,
    sun_ratio: y.sun_sales / z.sun_sales,
    mon_ratio: y.mon_sales / z.mon_sales,
    tue_ratio: y.tue_sales / z.tue_sales,
    wed_ratio: y.wed_sales / z.wed_sales,
    thu_ratio: y.thu_sales / z.thu_sales,
    fri_ratio: y.fri_sales / z.fri_sales,
    sat_ratio: y.sat_sales / z.sat_sales
  }

json(result)

test "TPCDC Q2 weekly ratios" {
  expect result == [
    {
      d_week_seq1: 1,
      sun_ratio: 0.5,
      mon_ratio: 0.5,
      tue_ratio: 0.0,
      wed_ratio: 0.0,
      thu_ratio: 0.0,
      fri_ratio: 0.0,
      sat_ratio: 0.0
    }
  ]
}
