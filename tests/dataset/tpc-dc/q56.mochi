let item = [
  {i_item_id:1, i_color:"Red"},
  {i_item_id:2, i_color:"Blue"},
  {i_item_id:3, i_color:"Green"}
]
let date_dim = [{d_date_sk:1, d_year:2000, d_moy:1}]
let customer_address=[{ca_address_sk:1, ca_gmt_offset:0}]
let store_sales=[
  {ss_item_sk:1, ss_sold_date_sk:1, ss_addr_sk:1, ss_ext_sales_price:20},
  {ss_item_sk:2, ss_sold_date_sk:1, ss_addr_sk:1, ss_ext_sales_price:30},
  {ss_item_sk:3, ss_sold_date_sk:1, ss_addr_sk:1, ss_ext_sales_price:10}
  ,{ss_item_sk:1, ss_sold_date_sk:1, ss_addr_sk:1, ss_ext_sales_price:10}
]
let catalog_sales=[
  {cs_item_sk:1, cs_sold_date_sk:1, cs_bill_addr_sk:1, cs_ext_sales_price:20},
  {cs_item_sk:2, cs_sold_date_sk:1, cs_bill_addr_sk:1, cs_ext_sales_price:40},
  {cs_item_sk:3, cs_sold_date_sk:1, cs_bill_addr_sk:1, cs_ext_sales_price:10}
  ,{cs_item_sk:1, cs_sold_date_sk:1, cs_bill_addr_sk:1, cs_ext_sales_price:5}
]
let web_sales=[
  {ws_item_sk:1, ws_sold_date_sk:1, ws_bill_addr_sk:1, ws_ext_sales_price:20},
  {ws_item_sk:2, ws_sold_date_sk:1, ws_bill_addr_sk:1, ws_ext_sales_price:30},
  {ws_item_sk:3, ws_sold_date_sk:1, ws_bill_addr_sk:1, ws_ext_sales_price:10}
  ,{ws_item_sk:1, ws_sold_date_sk:1, ws_bill_addr_sk:1, ws_ext_sales_price:15}
]

let ss=
  from ss in store_sales
  join d in date_dim on ss.ss_sold_date_sk == d.d_date_sk
  join ca in customer_address on ss.ss_addr_sk == ca.ca_address_sk
  join i in item on ss.ss_item_sk == i.i_item_id
  where (i.i_color == "Red" || i.i_color == "Blue" || i.i_color == "Green") && d.d_year == 2000 && d.d_moy == 1 && ca.ca_gmt_offset == 0
  group by {id:i.i_item_id} into g
  select {i_item_id:g.key.id, total_sales:sum(from x in g select x.ss.ss_ext_sales_price)}

let cs=
  from cs in catalog_sales
  join d in date_dim on cs.cs_sold_date_sk == d.d_date_sk
  join ca in customer_address on cs.cs_bill_addr_sk == ca.ca_address_sk
  join i in item on cs.cs_item_sk == i.i_item_id
  where (i.i_color == "Red" || i.i_color == "Blue" || i.i_color == "Green") && d.d_year == 2000 && d.d_moy == 1 && ca.ca_gmt_offset == 0
  group by {id:i.i_item_id} into g
  select {i_item_id:g.key.id, total_sales:sum(from x in g select x.cs.cs_ext_sales_price)}

let ws=
  from ws in web_sales
  join d in date_dim on ws.ws_sold_date_sk == d.d_date_sk
  join ca in customer_address on ws.ws_bill_addr_sk == ca.ca_address_sk
  join i in item on ws.ws_item_sk == i.i_item_id
  where (i.i_color == "Red" || i.i_color == "Blue" || i.i_color == "Green") && d.d_year == 2000 && d.d_moy == 1 && ca.ca_gmt_offset == 0
  group by {id:i.i_item_id} into g
  select {i_item_id:g.key.id, total_sales:sum(from x in g select x.ws.ws_ext_sales_price)}

let result=
  from r in (ss ++ cs ++ ws)
  group by {id:r.i_item_id} into g
  select {i_item_id:g.key.id, total_sales:sum(from x in g select x.total_sales)}

json(result)

test "TPCDC Q56 union sales" {
  expect result == [
    {i_item_id:3, total_sales:30},
    {i_item_id:1, total_sales:90},
    {i_item_id:2, total_sales:100}
  ]
}
