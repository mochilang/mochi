// Minimal dataset for TPC-DC Q62
let warehouse = [
  { w_warehouse_sk: 1, w_warehouse_name: "MainWarehouse" }
]

let ship_mode = [
  { sm_ship_mode_sk: 1, sm_type: "AIR" }
]

let web_site = [
  { web_site_sk: 1, web_name: "WebStore" }
]

let date_dim = [
  { d_date_sk: 5, d_month_seq: 1200 },
  { d_date_sk: 40, d_month_seq: 1200 },
  { d_date_sk: 80, d_month_seq: 1200 },
  { d_date_sk: 120, d_month_seq: 1200 },
  { d_date_sk: 150, d_month_seq: 1200 },
  { d_date_sk: 200, d_month_seq: 1200 },
  { d_date_sk: 25, d_month_seq: 1200 },
  { d_date_sk: 115, d_month_seq: 1200 }
]

let web_sales = [
  { ws_ship_date_sk: 10, ws_sold_date_sk: 5, ws_warehouse_sk: 1, ws_ship_mode_sk: 1, ws_web_site_sk: 1 },    // 5 days
  { ws_ship_date_sk: 80, ws_sold_date_sk: 40, ws_warehouse_sk: 1, ws_ship_mode_sk: 1, ws_web_site_sk: 1 },   // 40 days
  { ws_ship_date_sk: 120, ws_sold_date_sk: 40, ws_warehouse_sk: 1, ws_ship_mode_sk: 1, ws_web_site_sk: 1 },  // 80 days
  { ws_ship_date_sk: 150, ws_sold_date_sk: 40, ws_warehouse_sk: 1, ws_ship_mode_sk: 1, ws_web_site_sk: 1 },  // 110 days
  { ws_ship_date_sk: 200, ws_sold_date_sk: 40, ws_warehouse_sk: 1, ws_ship_mode_sk: 1, ws_web_site_sk: 1 },   // 160 days
  { ws_ship_date_sk: 25, ws_sold_date_sk: 5, ws_warehouse_sk: 1, ws_ship_mode_sk: 1, ws_web_site_sk: 1 },     // 20 days
  { ws_ship_date_sk: 115, ws_sold_date_sk: 40, ws_warehouse_sk: 1, ws_ship_mode_sk: 1, ws_web_site_sk: 1 }    // 75 days
]

let result =
  from ws in web_sales
  join w in warehouse on ws.ws_warehouse_sk == w.w_warehouse_sk
  join sm in ship_mode on ws.ws_ship_mode_sk == sm.sm_ship_mode_sk
  join web in web_site on ws.ws_web_site_sk == web.web_site_sk
  join d in date_dim on ws.ws_ship_date_sk == d.d_date_sk
  where d.d_month_seq >= 1200 && d.d_month_seq <= 1211
  group by {warehouse: w.w_warehouse_name, sm_type: sm.sm_type, web_name: web.web_name} into g
  select {
    warehouse: g.key.warehouse,
    sm_type: g.key.sm_type,
    web_name: g.key.web_name,
    d30: count(from x in g where (x.ws_ship_date_sk - x.ws_sold_date_sk) <= 30 select 1),
    d31_60: count(from x in g where (x.ws_ship_date_sk - x.ws_sold_date_sk) > 30 && (x.ws_ship_date_sk - x.ws_sold_date_sk) <= 60 select 1),
    d61_90: count(from x in g where (x.ws_ship_date_sk - x.ws_sold_date_sk) > 60 && (x.ws_ship_date_sk - x.ws_sold_date_sk) <= 90 select 1),
    d91_120: count(from x in g where (x.ws_ship_date_sk - x.ws_sold_date_sk) > 90 && (x.ws_ship_date_sk - x.ws_sold_date_sk) <= 120 select 1),
    d120_plus: count(from x in g where (x.ws_ship_date_sk - x.ws_sold_date_sk) > 120 select 1)
  }

json(result)

test "TPCDC Q62 shipping days buckets" {
  expect result == [{warehouse: "MainWarehouse", sm_type: "AIR", web_name: "WebStore", d30: 2, d31_60: 1, d61_90: 2, d91_120: 1, d120_plus: 1}]
}
