// Simplified TPC-DC Q6
let customer_address = [{ca_address_sk: 1, ca_state: "CA"}]
let customer = [{c_customer_sk: 1, c_current_addr_sk: 1}]
let store_sales = [{ss_sold_date_sk: 1, ss_customer_sk: 1, ss_item_sk: 1, ss_ext_sales_price: 50}]
let date_dim = [{d_date_sk: 1, d_month_seq: 1, d_year: 2000}]
let item = [{i_item_sk: 1, i_category: "Books", i_current_price: 20}]

let result =
  from a in customer_address
  join c in customer on a.ca_address_sk == c.c_current_addr_sk
  join s in store_sales on c.c_customer_sk == s.ss_customer_sk
  join d in date_dim on s.ss_sold_date_sk == d.d_date_sk
  join i in item on s.ss_item_sk == i.i_item_sk
  where d.d_year == 2000 && i.i_category == "Books" && i.i_current_price > 1.2 * i.i_current_price / 1.2
  group by a.ca_state into g
  select {state: g.key, total_sales: sum(from x in g select x.ss_ext_sales_price)}

json(result)

test "TPCDC Q6 sample" {
  expect result == [{state: "CA", total_sales: 50}]
}
