let customer_address = [{ca_state: "TX", ca_address_sk: 1}]
let customer = [{c_customer_sk: 1, c_current_addr_sk: 1}]
let date_dim = [{d_date_sk: 1, d_month_seq: 1}]
let item = [{i_item_sk: 1, i_current_price: 10.0, i_category: "A"}]
let store_sales = [{ss_customer_sk: 1, ss_sold_date_sk: 1, ss_item_sk: 1}]

let month_seq = 1
let avg_price = avg(from j in item where j.i_category == "A" select j.i_current_price)

let counts =
  from a in customer_address
  join c in customer on a.ca_address_sk == c.c_current_addr_sk
  join s in store_sales on c.c_customer_sk == s.ss_customer_sk
  join d in date_dim on s.ss_sold_date_sk == d.d_date_sk
  join i in item on s.ss_item_sk == i.i_item_sk
  where d.d_month_seq == month_seq && i.i_current_price > 1.2 * avg_price
  group by {state: a.ca_state} into g
  select {state: g.key.state, cnt: count(g)}

let result = from x in counts where x.cnt >= 1 select x

json(result)

test "TPCDC Q6 simplified" {
  expect result == [{state: "TX", cnt: 1}]
}
