let store_sales = [
  {ss_quantity: 10, ss_ext_discount_amt: 1.0, ss_net_paid: 9.0},
  {ss_quantity: 15, ss_ext_discount_amt: 3.0, ss_net_paid: 12.0},
  {ss_quantity: 30, ss_ext_discount_amt: 2.0, ss_net_paid: 28.0},
  {ss_quantity: 35, ss_ext_discount_amt: 4.0, ss_net_paid: 33.0},
  {ss_quantity: 50, ss_ext_discount_amt: 5.0, ss_net_paid: 45.0},
  {ss_quantity: 70, ss_ext_discount_amt: 7.0, ss_net_paid: 63.0}
]
let reason = [{r_reason_sk: 1}]

let bucket = fn(min, max) {
  let cnt = count(from s in store_sales where s.ss_quantity >= min && s.ss_quantity <= max select s)
  if cnt > 1 {
    avg(from s in store_sales where s.ss_quantity >= min && s.ss_quantity <= max select s.ss_ext_discount_amt)
  } else {
    avg(from s in store_sales where s.ss_quantity >= min && s.ss_quantity <= max select s.ss_net_paid)
  }
}

let result = [
  bucket(1,20),
  bucket(21,40),
  bucket(41,60),
  bucket(61,80)
]

json(result)

test "TPCDC Q9 simplified" {
  expect result == [2.0, 3.0, 45.0, 63.0]
}
