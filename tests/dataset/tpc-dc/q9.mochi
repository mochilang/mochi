// Simplified TPC-DC Q9
let store_sales = [
  {ss_quantity: 10, ss_ext_discount_amt: 5, ss_net_paid: 15},
  {ss_quantity: 30, ss_ext_discount_amt: 15, ss_net_paid: 40},
  {ss_quantity: 70, ss_ext_discount_amt: 20, ss_net_paid: 60},
  {ss_quantity: 90, ss_ext_discount_amt: 25, ss_net_paid: 80}
]
let reason = [{r_reason_sk: 1}]

func bucket(lo, hi, thresh) {
  let q = from ss in store_sales where ss.ss_quantity >= lo && ss.ss_quantity <= hi select ss
  let cnt = count(q)
  if cnt > thresh {
    avg(from x in q select x.ss_ext_discount_amt)
  } else {
    avg(from x in q select x.ss_net_paid)
  }
}

let result = {
  bucket1: bucket(1,20,10),
  bucket2: bucket(21,40,20),
  bucket3: bucket(41,60,30),
  bucket4: bucket(61,80,40),
  bucket5: bucket(81,100,50)
}

json(result)

test "TPCDC Q9 sample" {
  expect result == {bucket1: 15.0, bucket2: 40.0, bucket3: 0, bucket4: 60.0, bucket5: 80.0}
}
