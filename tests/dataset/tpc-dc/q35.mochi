let date_dim = [
  {d_date_sk: 1, d_year: 1999, d_qoy: 1}
]

let store_sales = [
  {ss_customer_sk: 1, ss_sold_date_sk: 1}
]

let web_sales = [
  {ws_bill_customer_sk: 1, ws_sold_date_sk: 1}
]

let customer = [
  {c_customer_sk: 1, c_current_addr_sk: 1, c_current_cdemo_sk: 1}
]

let customer_address = [
  {ca_address_sk: 1, ca_state: "CA"}
]

let customer_demographics = [
  {cd_demo_sk: 1, cd_gender: "M", cd_marital_status: "S", cd_dep_count: 1, cd_dep_employed_count: 1, cd_dep_college_count: 0}
]

let result =
  from c in customer
  join ca in customer_address on c.c_current_addr_sk == ca.ca_address_sk
  join cd in customer_demographics on c.c_current_cdemo_sk == cd.cd_demo_sk
  where exists(
          from ss in store_sales
          join d in date_dim on ss.ss_sold_date_sk == d.d_date_sk
          where ss.ss_customer_sk == c.c_customer_sk && d.d_year == 1999 && d.d_qoy < 4
        ) &&
        exists(
          from ws in web_sales
          join d in date_dim on ws.ws_sold_date_sk == d.d_date_sk
          where ws.ws_bill_customer_sk == c.c_customer_sk && d.d_year == 1999 && d.d_qoy < 4
        )
  group by {state: ca.ca_state, gender: cd.cd_gender, marital: cd.cd_marital_status, dep: cd.cd_dep_count, emp: cd.cd_dep_employed_count, college: cd.cd_dep_college_count} into g
  select {
    ca_state: g.key.state,
    cd_gender: g.key.gender,
    cd_marital_status: g.key.marital,
    cd_dep_count: g.key.dep,
    cnt1: count(g)
  }

json(result)

test "TPCDC Q35 simplified" {
  expect result == [
    {ca_state: "CA", cd_gender: "M", cd_marital_status: "S", cd_dep_count: 1, cnt1: 1}
  ]
}
