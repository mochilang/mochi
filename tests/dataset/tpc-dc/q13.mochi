let store_sales = [
  {ss_quantity: 2, ss_ext_sales_price: 200.0, ss_ext_wholesale_cost: 150.0,
   ss_sales_price: 120.0, ss_net_profit: 150, ss_hdemo_sk: 1, ss_cdemo_sk: 1,
   ss_addr_sk: 1, ss_store_sk: 1, ss_sold_date_sk: 1},
  {ss_quantity: 3, ss_ext_sales_price: 90.0, ss_ext_wholesale_cost: 70.0,
   ss_sales_price: 75.0, ss_net_profit: 160, ss_hdemo_sk: 2, ss_cdemo_sk: 2,
   ss_addr_sk: 2, ss_store_sk: 1, ss_sold_date_sk: 1},
  {ss_quantity: 4, ss_ext_sales_price: 180.0, ss_ext_wholesale_cost: 100.0,
   ss_sales_price: 170.0, ss_net_profit: 60, ss_hdemo_sk: 3, ss_cdemo_sk: 3,
   ss_addr_sk: 3, ss_store_sk: 1, ss_sold_date_sk: 1},
]

let store = [{s_store_sk: 1}]

let customer_demographics = [
  {cd_demo_sk: 1, cd_marital_status: "M", cd_education_status: "Advanced Degree"},
  {cd_demo_sk: 2, cd_marital_status: "S", cd_education_status: "College"},
  {cd_demo_sk: 3, cd_marital_status: "W", cd_education_status: "2 yr Degree"},
]

let household_demographics = [
  {hd_demo_sk: 1, hd_dep_count: 3},
  {hd_demo_sk: 2, hd_dep_count: 1},
  {hd_demo_sk: 3, hd_dep_count: 1},
]

let customer_address = [
  {ca_address_sk: 1, ca_country: "United States", ca_state: "TX"},
  {ca_address_sk: 2, ca_country: "United States", ca_state: "OR"},
  {ca_address_sk: 3, ca_country: "United States", ca_state: "VA"},
]

let date_dim = [{d_date_sk: 1, d_year: 2001}]

let filtered =
  from ss in store_sales
  join s in store on ss.ss_store_sk == s.s_store_sk
  join cd in customer_demographics on ss.ss_cdemo_sk == cd.cd_demo_sk
  join hd in household_demographics on ss.ss_hdemo_sk == hd.hd_demo_sk
  join ca in customer_address on ss.ss_addr_sk == ca.ca_address_sk
  join d in date_dim on ss.ss_sold_date_sk == d.d_date_sk
  where d.d_year == 2001 &&
        (
          (cd.cd_marital_status == "M" && cd.cd_education_status == "Advanced Degree" &&
           ss.ss_sales_price >= 100.0 && ss.ss_sales_price <= 150.0 && hd.hd_dep_count == 3) ||
          (cd.cd_marital_status == "S" && cd.cd_education_status == "College" &&
           ss.ss_sales_price >= 50.0 && ss.ss_sales_price <= 100.0 && hd.hd_dep_count == 1) ||
          (cd.cd_marital_status == "W" && cd.cd_education_status == "2 yr Degree" &&
           ss.ss_sales_price >= 150.0 && ss.ss_sales_price <= 200.0 && hd.hd_dep_count == 1)
        ) &&
        (
          (ca.ca_country == "United States" && ca.ca_state in ["TX","OH","TX"] && ss.ss_net_profit >= 100 && ss.ss_net_profit <= 200) ||
          (ca.ca_country == "United States" && ca.ca_state in ["OR","NM","KY"] && ss.ss_net_profit >= 150 && ss.ss_net_profit <= 300) ||
          (ca.ca_country == "United States" && ca.ca_state in ["VA","TX","MS"] && ss.ss_net_profit >= 50 && ss.ss_net_profit <= 250)
        )
  select ss
  |> to_list

let result = {
  avg_ss_quantity: avg(from x in filtered select x.ss_quantity),
  avg_ss_ext_sales_price: avg(from x in filtered select x.ss_ext_sales_price),
  avg_ss_ext_wholesale_cost: avg(from x in filtered select x.ss_ext_wholesale_cost),
  sum_ss_ext_wholesale_cost: sum(from x in filtered select x.ss_ext_wholesale_cost)
}

json(result)

test "TPCDC Q13 aggregates" {
  expect result.avg_ss_quantity == 3.0
  expect result.avg_ss_ext_sales_price == 156.66666666666666
  expect result.avg_ss_ext_wholesale_cost == 106.66666666666667
  expect result.sum_ss_ext_wholesale_cost == 320.0
}
