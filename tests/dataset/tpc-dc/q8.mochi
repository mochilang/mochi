let store_sales = [{ss_store_sk: 1, ss_sold_date_sk: 1, ss_net_profit: 10.0}]
let store = [{s_store_sk: 1, s_store_name: "Store1", s_zip: "12345"}]
let date_dim = [{d_date_sk: 1, d_qoy: 2, d_year: 1998}]
let customer_address = [{ca_zip: "12345"}]
let customer = [{c_current_addr_sk: 1}]

let valid_zips = from ca in customer_address select ca.ca_zip

let result =
  from ss in store_sales
  join s in store on ss.ss_store_sk == s.s_store_sk
  join d in date_dim on ss.ss_sold_date_sk == d.d_date_sk
  join c in customer on true
  where d.d_qoy == 2 && d.d_year == 1998 && substr(s.s_zip,0,2) == substr(first(valid_zips),0,2)
  group by {s_store_name: s.s_store_name} into g
  select {s_store_name: g.key.s_store_name, net: sum(from x in g select x.ss_net_profit)}

json(result)

test "TPCDC Q8 simplified" {
  expect result == [{s_store_name: "Store1", net: 10.0}]
}
