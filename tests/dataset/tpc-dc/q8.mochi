// Simplified TPC-DC Q8
let store_sales = [{ss_sold_date_sk: 1, ss_store_sk: 1, ss_net_profit: 200}]
let date_dim = [{d_date_sk: 1, d_qoy: 1, d_year: 2000}]
let store = [{s_store_sk: 1, s_store_name: "Store#1", s_zip: "12345"}]
let customer_address = [{ca_address_sk: 1, ca_zip: "12345"}]
let customer = [{c_customer_sk: 1, c_current_addr_sk: 1, c_preferred_cust_flag: "Y"}]

let result =
  from ss in store_sales
  join d in date_dim on ss.ss_sold_date_sk == d.d_date_sk
  join s in store on ss.ss_store_sk == s.s_store_sk
  join c in customer on true
  join ca in customer_address on c.c_current_addr_sk == ca.ca_address_sk
  where d.d_year == 2000 && d.d_qoy == 1 && s.s_zip[:2] == ca.ca_zip[:2]
  group by s.s_store_name into g
  select {s_store_name: g.key, profit: sum(from x in g select x.ss_net_profit)}

json(result)

test "TPCDC Q8 sample" {
  expect result == [{s_store_name: "Store#1", profit: 200}]
}
