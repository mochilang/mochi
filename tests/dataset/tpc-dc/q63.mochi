// Minimal dataset for TPC-DC Q63
let item = [
  { i_item_sk: 1, i_manager_id: 101, i_category: "Books", i_class: "personal", i_brand: "scholaramalgamalg #14" }
]

let store_sales = [
  { ss_item_sk: 1, ss_sold_date_sk: 1, ss_store_sk: 1, ss_sales_price: 10.0 },
  { ss_item_sk: 1, ss_sold_date_sk: 2, ss_store_sk: 1, ss_sales_price: 20.0 },
  { ss_item_sk: 1, ss_sold_date_sk: 3, ss_store_sk: 1, ss_sales_price: 10.0 },
  { ss_item_sk: 1, ss_sold_date_sk: 4, ss_store_sk: 1, ss_sales_price: 20.0 }
]

let date_dim = [
  { d_date_sk: 1, d_month_seq: 1200, d_moy: 1 },
  { d_date_sk: 2, d_month_seq: 1201, d_moy: 2 },
  { d_date_sk: 3, d_month_seq: 1202, d_moy: 3 },
  { d_date_sk: 4, d_month_seq: 1203, d_moy: 4 }
]

let store = [
  { s_store_sk: 1 }
]

let tmp1 =
  from ss in store_sales
  join i in item on ss.ss_item_sk == i.i_item_sk
  join d in date_dim on ss.ss_sold_date_sk == d.d_date_sk
  join s in store on ss.ss_store_sk == s.s_store_sk
  where d.d_month_seq >= 1200 && d.d_month_seq <= 1211
  group by {i_manager_id: i.i_manager_id, d_moy: d.d_moy} into g
  select {
    i_manager_id: g.key.i_manager_id,
    sum_sales: sum(from x in g select x.ss_sales_price),
    avg_monthly_sales: avg(from x in g select x.ss_sales_price)
  }

let result =
  from r in tmp1
  where abs(r.sum_sales - r.avg_monthly_sales) / r.avg_monthly_sales > 0.1
  sort by r.i_manager_id, r.avg_monthly_sales, r.sum_sales
  select r

json(result)

test "TPCDC Q63 monthly sales deviation" {
  expect result == [
    { i_manager_id: 101, sum_sales: 10.0, avg_monthly_sales: 15.0 },
    { i_manager_id: 101, sum_sales: 20.0, avg_monthly_sales: 15.0 },
    { i_manager_id: 101, sum_sales: 10.0, avg_monthly_sales: 15.0 },
    { i_manager_id: 101, sum_sales: 20.0, avg_monthly_sales: 15.0 }
  ]
}
