let item=[{i_item_id:1}, {i_item_id:2}]
let date_dim=[
  {d_date_sk:1, d_week_seq:1, d_date:"2023-01-01"},
  {d_date_sk:2, d_week_seq:1, d_date:"2023-01-02"}
]
let store_sales=[
  {ss_item_sk:1, ss_sold_date_sk:1, ss_ext_sales_price:20},
  {ss_item_sk:2, ss_sold_date_sk:2, ss_ext_sales_price:30}
]
let catalog_sales=[
  {cs_item_sk:1, cs_sold_date_sk:1, cs_ext_sales_price:20},
  {cs_item_sk:2, cs_sold_date_sk:2, cs_ext_sales_price:30}
]
let web_sales=[
  {ws_item_sk:1, ws_sold_date_sk:1, ws_ext_sales_price:20},
  {ws_item_sk:2, ws_sold_date_sk:2, ws_ext_sales_price:32}
]

let ss_items=
  from ss in store_sales
  join i in item on ss.ss_item_sk==i.i_item_id
  join d in date_dim on ss.ss_sold_date_sk==d.d_date_sk
  group by {id:i.i_item_id} into g
  select {item_id:g.key.id, ss_item_rev:sum(from x in g select x.ss.ss_ext_sales_price)}
let cs_items=
  from cs in catalog_sales
  join i in item on cs.cs_item_sk==i.i_item_id
  join d in date_dim on cs.cs_sold_date_sk==d.d_date_sk
  group by {id:i.i_item_id} into g
  select {item_id:g.key.id, cs_item_rev:sum(from x in g select x.cs.cs_ext_sales_price)}
let ws_items=
  from ws in web_sales
  join i in item on ws.ws_item_sk==i.i_item_id
  join d in date_dim on ws.ws_sold_date_sk==d.d_date_sk
  group by {id:i.i_item_id} into g
  select {item_id:g.key.id, ws_item_rev:sum(from x in g select x.ws.ws_ext_sales_price)}

let combined=
  from s in ss_items
  join c in cs_items on s.item_id==c.item_id
  join w in ws_items on s.item_id==w.item_id
  select {item_id:s.item_id, average:(s.ss_item_rev+c.cs_item_rev+w.ws_item_rev)/3}

json(combined)

test "TPCDC Q58 revenue parity" {
  expect combined == [
    {item_id:1, average:20},
    {item_id:2, average:30.666666666666668}
  ]
}
