let store_sales = [
  { ss_item_sk: 1, ss_store_sk: 1, ss_net_profit: 5.0 },
  { ss_item_sk: 1, ss_store_sk: 1, ss_net_profit: 5.0 },
  { ss_item_sk: 2, ss_store_sk: 1, ss_net_profit: -1.0 },
  { ss_item_sk: 3, ss_store_sk: 1, ss_net_profit: 8.0 },
  { ss_item_sk: 3, ss_store_sk: 1, ss_net_profit: 7.0 }
  ,{ ss_item_sk: 4, ss_store_sk: 1, ss_net_profit: 6.0 }
  ,{ ss_item_sk: 4, ss_store_sk: 1, ss_net_profit: 4.0 }
  ,{ ss_item_sk: 5, ss_store_sk: 1, ss_net_profit: 2.0 }
]

let item = [
  { i_item_sk: 1, i_product_name: "ItemA" },
  { i_item_sk: 2, i_product_name: "ItemB" },
  { i_item_sk: 3, i_product_name: "ItemC" }
  ,{ i_item_sk: 4, i_product_name: "ItemD" }
  ,{ i_item_sk: 5, i_product_name: "ItemE" }
]

let grouped =
  from ss in store_sales
  group by ss.ss_item_sk into g
  let avg_profit = avg(from x in g select x.ss_net_profit)
  select { item_sk: g.key, avg_profit: avg_profit }

let best = first(from x in grouped sort by -x.avg_profit select x)
let worst = first(from x in grouped sort by x.avg_profit select x)

let best_name = from i in item where i.i_item_sk == best.item_sk select i.i_product_name |> first
let worst_name = from i in item where i.i_item_sk == worst.item_sk select i.i_product_name |> first

let result = { best_performing: best_name, worst_performing: worst_name }

json(result)

test "TPCDS Q44 simplified" {
  expect result == { best_performing: "ItemC", worst_performing: "ItemB" }
}
