let catalog_sales = [
  {cs_bill_customer_sk:1, cs_sold_date_sk:1, cs_item_sk:1},
  {cs_bill_customer_sk:3, cs_sold_date_sk:1, cs_item_sk:1},
  {cs_bill_customer_sk:4, cs_sold_date_sk:1, cs_item_sk:1},
  {cs_bill_customer_sk:5, cs_sold_date_sk:1, cs_item_sk:1}
]
let web_sales = [
  {ws_bill_customer_sk:2, ws_sold_date_sk:1, ws_item_sk:1}
]
let item = [{i_item_sk:1, i_category:"Cat", i_class:"Class"}]
let date_dim = [{d_date_sk:1, d_moy:1, d_year:2000, d_month_seq:1}]
let customer = [
  {c_customer_sk:1, c_current_addr_sk:1},
  {c_customer_sk:2, c_current_addr_sk:2},
  {c_customer_sk:3, c_current_addr_sk:3},
  {c_customer_sk:4, c_current_addr_sk:4},
  {c_customer_sk:5, c_current_addr_sk:1}
]
let store_sales = [
  {ss_customer_sk:1, ss_sold_date_sk:2, ss_ext_sales_price:120},
  {ss_customer_sk:2, ss_sold_date_sk:2, ss_ext_sales_price:160},
  {ss_customer_sk:3, ss_sold_date_sk:2, ss_ext_sales_price:60},
  {ss_customer_sk:1, ss_sold_date_sk:2, ss_ext_sales_price:30},
  {ss_customer_sk:3, ss_sold_date_sk:2, ss_ext_sales_price:40},
  {ss_customer_sk:4, ss_sold_date_sk:2, ss_ext_sales_price:40}
  ,{ss_customer_sk:5, ss_sold_date_sk:2, ss_ext_sales_price:80}
]
let customer_address=[
  {ca_address_sk:1, ca_county:"C", ca_state:"S"},
  {ca_address_sk:2, ca_county:"C", ca_state:"S"},
  {ca_address_sk:3, ca_county:"C", ca_state:"S"},
  {ca_address_sk:4, ca_county:"C", ca_state:"S"}
]
let store=[{s_store_sk:1, s_county:"C", s_state:"S"}]

let my_customers =
  from cs in catalog_sales
  select {customer_sk: cs.cs_bill_customer_sk, c_current_addr_sk: 1} union all
  from ws in web_sales
  select {customer_sk: ws.ws_bill_customer_sk, c_current_addr_sk: 2}

let my_revenue =
  from mc in my_customers
  join ss in store_sales on ss.ss_customer_sk == mc.customer_sk
  join ca in customer_address on mc.c_current_addr_sk == ca.ca_address_sk
  join s in store on ca.ca_county == s.s_county && ca.ca_state == s.s_state
  join d in date_dim on ss.ss_sold_date_sk == d.d_date_sk
  group by {cust: mc.customer_sk} into g
  select {c_customer_sk: g.key.cust, revenue: sum(from x in g select x.ss.ss_ext_sales_price)}

let segments =
  from r in my_revenue
  select {segment: int(r.revenue / 50)}

let result =
  from s in segments
  group by {seg: s.segment} into g
  select {segment: g.key.seg, num_customers: count(g), segment_base: g.key.seg * 50}
  order by {segment: ascending}

json(result)

test "TPCDC Q54 segments" {
  expect result == [
    {segment:0, num_customers:1, segment_base:0},
    {segment:1, num_customers:1, segment_base:50},
    {segment:2, num_customers:1, segment_base:100},
    {segment:3, num_customers:2, segment_base:150}
  ]
}
