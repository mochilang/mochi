let web_sales = [
  { ws_sold_date_sk: 1, ws_item_sk: 1, ws_net_paid: 40.0 },
  { ws_sold_date_sk: 1, ws_item_sk: 2, ws_net_paid: 60.0 },
  { ws_sold_date_sk: 2, ws_item_sk: 1, ws_net_paid: 30.0 }
]

let date_dim = [
  { d_date_sk: 1, d_month_seq: 1200 },
  { d_date_sk: 2, d_month_seq: 1201 }
]

let item = [
  { i_item_sk: 1, i_category: "CatA", i_class: "ClassA" },
  { i_item_sk: 2, i_category: "CatA", i_class: "ClassB" }
]

let dms = 1200

let result =
  from ws in web_sales
  join d in date_dim on ws.ws_sold_date_sk == d.d_date_sk
  join i in item on ws.ws_item_sk == i.i_item_sk
  where d.d_month_seq >= dms && d.d_month_seq <= dms + 11
  group by { category: i.i_category, class: i.i_class } into g
  sort by g.key.category, g.key.class
  select { i_category: g.key.category, i_class: g.key.class, total_sum: sum(from x in g select x.ws.ws_net_paid) }
  |> to_list

json(result)

test "TPCDC Q86 totals" {
  expect result == [
    { i_category: "CatA", i_class: "ClassA", total_sum: 70.0 },
    { i_category: "CatA", i_class: "ClassB", total_sum: 60.0 }
  ]
}
