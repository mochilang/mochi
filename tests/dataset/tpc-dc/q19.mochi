let date_dim = [{d_date_sk: 1, d_moy: 11, d_year: 1998}]
let item = [{i_item_sk: 1, i_brand_id: 1, i_brand: "B1", i_manufact_id: 1, i_manufact: "M1", i_manager_id: 8}]
let customer = [{c_customer_sk: 1, c_current_addr_sk: 1}]
let customer_address = [{ca_address_sk: 1, ca_zip: "12345"}]
let store = [{s_store_sk: 1, s_zip: "99999"}]
let store_sales = [{ss_sold_date_sk: 1, ss_item_sk: 1, ss_customer_sk: 1, ss_store_sk: 1, ss_ext_sales_price: 100.0}]

let result =
  from d in date_dim
  join ss in store_sales on d.d_date_sk == ss.ss_sold_date_sk
  join i in item on ss.ss_item_sk == i.i_item_sk
  join c in customer on ss.ss_customer_sk == c.c_customer_sk
  join ca in customer_address on c.c_current_addr_sk == ca.ca_address_sk
  join s in store on ss.ss_store_sk == s.s_store_sk
  where i.i_manager_id == 8 && d.d_moy == 11 && d.d_year == 1998 && substr(ca.ca_zip,0,5) != substr(s.s_zip,0,5)
  group by {brand:i.i_brand, brand_id:i.i_brand_id, man_id:i.i_manufact_id, man:i.i_manufact} into g
  sort by [sum(from x in g select x.ss_ext_sales_price) desc, g.key.brand, g.key.brand_id, g.key.man_id, g.key.man]
  select {
    brand: g.key.brand,
    brand_id: g.key.brand_id,
    i_manufact_id: g.key.man_id,
    i_manufact: g.key.man,
    ext_price: sum(from x in g select x.ss_ext_sales_price)
  }
  |> to_list

json(result)

test "TPCDC Q19 brand revenue" {
  expect result == [
    {brand: "B1", brand_id: 1, i_manufact_id: 1, i_manufact: "M1", ext_price: 100.0}
  ]
}
