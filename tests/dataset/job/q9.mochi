let aka_name = [
  { person_id: 1, name: "Angela Alias" },
  { person_id: 2, name: "Berta" }
]

let char_name = [
  { id: 1, name: "Angel" },
  { id: 2, name: "Villain" }
]

let cast_info = [
  { movie_id: 1, person_id: 1, person_role_id: 1, role_id: 1, note: "(voice)" },
  { movie_id: 2, person_id: 2, person_role_id: 2, role_id: 2, note: "(voice)" }
]

let company_name = [
  { id: 10, country_code: "[us]" },
  { id: 20, country_code: "[uk]" }
]

let movie_companies = [
  { movie_id: 1, company_id: 10, note: "Distributor (USA)" },
  { movie_id: 2, company_id: 20, note: null }
]

let name = [
  { id: 1, name: "Angelina", gender: "f" },
  { id: 2, name: "Bob", gender: "m" }
]

let role_type = [
  { id: 1, role: "actress" },
  { id: 2, role: "actor" }
]

let title = [
  { id: 1, title: "My Animated Film", production_year: 2010 },
  { id: 2, title: "Old Film", production_year: 1990 }
]

let voice_notes = [
  "(voice)",
  "(voice: Japanese version)",
  "(voice) (uncredited)",
  "(voice: English version)"
]

let candidates =
  from ci in cast_info
  join t in title on ci.movie_id == t.id
  join mc in movie_companies on mc.movie_id == ci.movie_id
  join cn in company_name on cn.id == mc.company_id
  join rt in role_type on rt.id == ci.role_id
  join n in name on n.id == ci.person_id
  join chn in char_name on chn.id == ci.person_role_id
  join an in aka_name on an.person_id == n.id
  where ci.note in voice_notes &&
        cn.country_code == "[us]" &&
        mc.note != null &&
        (contains(mc.note, "(USA)") || contains(mc.note, "(worldwide)")) &&
        n.gender == "f" &&
        contains(n.name, "Ang") &&
        rt.role == "actress" &&
        t.production_year >= 2005 &&
        t.production_year <= 2015
  select { an: an, chn: chn, t: t }

let result =
  from r in candidates
  group by {} into g
  select {
    alternative_name: min(from x in g select x.an.name),
    character_name: min(from x in g select x.chn.name),
    movie: min(from x in g select x.t.title)
  }

print json(result)

test "JOB Q9 finds voice actresses in US movies" {
  expect result == [
    {
      alternative_name: "Angela Alias",
      character_name: "Angel",
      movie: "My Animated Film"
    }
  ]
}
