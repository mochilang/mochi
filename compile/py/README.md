# Python Backend

The Python backend translates Mochi programs into standard Python source code. It is useful when you want to run Mochi on systems with Python installed or integrate with existing Python tooling.

## Files

- `compiler.go` – entry point for the Python code generator
- `statements.go` – compilation of statements and declarations
- `compiler_test.go` – golden tests that execute the generated code with `python3`
- `helpers.go` – utilities for indentation, name sanitisation and type inference helpers
- `infer.go` – local type inference used by the code generator
- `runtime.go` – stringified runtime helpers injected into generated programs
- `tools.go` – ensures `python3` is available for benchmarks and tests
- Struct methods defined inside `type` blocks are emitted as Python class methods

## Runtime Helpers

`runtime.go` defines helper functions that are embedded only when needed. They provide LLM integration, file I/O, dataset querying and stream handling. A snippet of the definitions:

```go
var helperGenText = "def _gen_text(prompt, model=None, params=None):\n" +
    "    # TODO: send prompt to your LLM of choice\n" +
    "    return prompt\n"
var helperGenEmbed = "def _gen_embed(text, model=None, params=None):\n" +
    "    # TODO: send text to your embedding model of choice\n" +
    "    return [float(ord(c)) for c in text]\n"
var helperGenStruct = "def _gen_struct(cls, prompt, model=None, params=None):\n" +
    "    # TODO: send prompt to your LLM of choice and parse JSON\n" +
    "    import json\n" +
    "    data = json.loads(prompt)\n" +
    "    return cls(**data)\n"
```
【F:compile/py/runtime.go†L7-L19】

Runtime helpers include type hints using `typing.TypeVar` to reduce
`Any` usage. For example:

```go
var helperAppend = "def _append(lst: list[T] | None, v: T) -> list[T]:\n" +
    "    out: list[T] = list(lst) if lst is not None else []\n" +
    "    out.append(v)\n" +
    "    return out\n"
```


Additional helpers cover data loading, saving and HTTP requests. They are referenced from a map used by `emitRuntime`:

```go
var helperMap = map[string]string{
    "_gen_text":   helperGenText,
    "_gen_embed":  helperGenEmbed,
    "_gen_struct": helperGenStruct,
    "_group":      helperGroupClass,
    "_group_by":   helperGroupBy,
    "_count":      helperCount,
    "_avg":        helperAvg,
    "_union_all":  helperUnionAll,
    "_union":      helperUnion,
    "_except":     helperExcept,
    "_intersect":  helperIntersect,
    "_fetch":      helperFetch,
    "_load":       helperLoad,
    "_save":       helperSave,
    "_slice":      helperSlice,
    "_reverse":    helperReverse,
    "_stream":     helperStream,
    "_wait_all":   helperWaitAll,
    "_agent":      helperAgent,
    "_query":      helperQuery,
}
```
【F:compile/py/runtime.go†L345-L364】

## Building

Compile a Mochi source file to Python using `mochi build`:

```bash
mochi build --target python main.mochi -o main.py
```

Generated files start with a prologue and include imports and helpers only when required:

```go
c.writeln("# Generated by Mochi Python compiler")
c.writeln("from __future__ import annotations")
...
if needsAsync {
    c.writeln("async def _run():")
    ...
    c.writeln("asyncio.run(_run())")
} else {
    c.writeln("if __name__ == \"__main__\":")
    c.writeln("main()")
}
```
【F:compile/py/compiler.go†L211-L262】

## Tests

Golden tests under `compile/py` generate Python code and run it with `python3`. Run them with:

```bash
go test ./compile/py -tags slow
```

`tools.go` attempts to install Python automatically if it is missing:

```go
// EnsurePython installs Python3 if missing. Useful for benchmarks and tests.
func EnsurePython() error {
    if _, err := exec.LookPath("python3"); err == nil {
        return nil
    }
    ...
}
```
【F:compile/py/tools.go†L10-L42】

## Supported Features

The Python backend supports a large subset of Mochi. Highlights include:

- Functions and variables with type inference
- Classes with fields and methods (rendered as dataclasses)
- Dataset queries and list/map operations
- Stream handlers and agents with asynchronous execution
- LLM helpers such as `gen_text` and `fetch`

## Unsupported Features

The Python backend does not yet implement every language feature. Known
limitations include:

* `import` statements targeting a language other than Python
* Error handling with `try`/`catch`
* Concurrency primitives like `spawn` and channels

## Notes

The backend supports streams, agents, dataset queries, LLM helpers and more. When asynchronous stream handlers are present, the compiler wraps execution in `_run()` and waits for all pending tasks before exiting.
