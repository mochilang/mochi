//go:build slow

package dart

import (
	"bytes"

	meta "mochi/compiler/meta"
)

// formatDart runs `dart format` if available, falling back to simple formatting.
func formatDart(src []byte) []byte {
	header := meta.Header("//")
	if i := bytes.IndexByte(src, '\n'); i != -1 && bytes.HasPrefix(src, []byte("// Generated by Mochi")) {
		src = src[i+1:]
	}

	// Disable external formatter to keep output stable across environments.
	src = append(header, src...)
	src = bytes.ReplaceAll(src, []byte("\t"), []byte("  "))
	if len(src) > 0 && src[len(src)-1] != '\n' {
		src = append(src, '\n')
	}
	return src
}
