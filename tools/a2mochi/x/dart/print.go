package dart

import (
	"fmt"
	"os"
	"path/filepath"
	"runtime"
	"strings"
	"time"

	"mochi/ast"
)

var version = func() string {
	_, file, _, ok := runtime.Caller(0)
	if ok {
		data, err := os.ReadFile(filepath.Join(filepath.Dir(file), "../../../..", "VERSION"))
		if err == nil {
			return strings.TrimSpace(string(data))
		}
	}
	return "unknown"
}()

func header() string {
	tz := time.FixedZone("GMT+7", 7*60*60)
	return fmt.Sprintf("// Generated by a2mochi v%s on %s", strings.TrimSpace(version), time.Now().In(tz).Format("2006-01-02 15:04:05 MST"))
}

// Print returns Mochi source code for the given AST node.
func Print(node *ast.Node) (string, error) {
	if node == nil {
		return "", fmt.Errorf("nil node")
	}
	var b strings.Builder
	if err := ast.Fprint(&b, node); err != nil {
		return "", err
	}
	if b.Len() > 0 && b.String()[b.Len()-1] != '\n' {
		b.WriteByte('\n')
	}
	var out strings.Builder
	out.WriteString(header())
	out.WriteByte('\n')
	out.WriteString(b.String())
	return out.String(), nil
}
